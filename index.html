<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Open+Sans&family=Lato&family=Montserrat&family=Oswald&family=Raleway&family=Poppins&family=Nunito&family=Playfair+Display&family=Merriweather&family=Indie+Flower&family=Dancing+Script&family=Pacifico&family=Lobster&family=Source+Code+Pro&family=Nunito+Sans&family=Inter&family=Work+Sans&family=Fira+Sans&family=Source+Sans+Pro&family=PT+Sans&family=Ubuntu&family=Lora&family=Quicksand&family=Comfortaa&family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&family=Bebas+Neue&family=Kanit&family=Permanent+Marker&family=Anton&family=Archivo+Black&family=Abril+Fatface&family=Josefin+Sans&family=Satisfy&family=Courgette&family=Noto+Sans&family=Dosis&family=Merriweather+Sans&family=Concert+One&family=Passion+One&family=Barlow&family=Caveat&family=Alfa+Slab+One&family=Exo+2&family=Secular+One&display=swap" rel="stylesheet" />
    <style>
        body { margin: 0; font-family: Arial, sans-serif; background: #f0f2f5; overflow: hidden; }
        #chatIcon { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: black; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 0 20px rgba(255,0,255,0.5), 0 0 20px rgba(0,255,255,0.5); z-index: 1000; }
        .chat-window { 
            position: fixed; 
            bottom: 90px; 
            right: 20px; 
            width: 590px; 
            height: 470px; 
            background: rgba(255, 255, 255, 0.2); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px);
            border-radius: 15px; 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: none; 
            flex-direction: column; 
            overflow: hidden; 
            z-index: 999; 
            opacity: 0; 
            transform: translateY(20px); 
            pointer-events: none; 
            transition: opacity 0.3s ease, transform 0.3s ease; 
        }
        .chat-window.open { display: flex; opacity: 1; transform: translateY(0); pointer-events: auto; }
        .chat-window.maximized { width: 100vw; height: 100vh; bottom: 0; right: 0; border-radius: 0; }
        .chat-window.minimized { height: 40px; }
        .chat-header { 
            background: rgba(255, 255, 255, 0.3); 
            padding: 10px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.5); 
            position: relative; 
            min-height: 40px; 
        }
        .header-icons-left, .header-icons-right { display: flex; align-items: center; gap: 15px; }
        .chat-header h2 { margin: 0; font-size: 18px; color: #111; position: absolute; left: 50%; transform: translateX(-50%); white-space: nowrap; }
        .screen { display: none; flex: 1; padding: 20px; overflow-y: auto; flex-direction: column; justify-content: center; align-items: center; gap: 15px; }
        #chatScreen { justify-content: flex-start; align-items: stretch; }
        #chatScreen[style*="background-color"] { background-color: var(--chat-wallpaper-color, #fff); }
        .chat-message { 
            background-color: rgba(255, 255, 255, 0.4) !important; 
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 8px 12px; 
            border-radius: 18px; 
            margin-bottom: 8px; 
            max-width: 80%; 
            align-self: flex-start; 
            word-wrap: break-word; 
            position: relative; 
            cursor: pointer; 
        }
        .chat-message.my-message { align-self: flex-end; }
        .system-message { text-align: center; font-size: 12px; color: #888; margin: 8px 0; font-style: italic; }
        .admin-star { margin-right: 5px; color: #ffc107; }
        .room-lock-icon { margin-left: auto; color: #dc3545; }
        .invite-message { background-color: #e9f5ff; border-left: 4px solid #007bff; padding: 10px; margin: 10px 5%; border-radius: 4px; font-size: 14px; }
        .invite-message p { margin: 0 0 10px 0; }
        .invite-message button { background-color: #007bff; color: white; border: none; padding: 5px 10px; margin-right: 10px; border-radius: 4px; cursor: pointer; font-size: 12px; width: auto; }
        .invite-message button.decline { background-color: #ccc; color: #333; }
        
        .chat-footer { position: relative; background: #ffffff; padding: 8px 10px; display: flex; align-items: center; gap: 8px; border-top: 1px solid #e0e0e0; }
        .footer-toolbar { display: flex; align-items: center; gap: 4px; }
        .tool-button { background: transparent; border: none; padding: 4px; cursor: pointer; border-radius: 4px; color: black; display: flex; }
        .tool-button.active { background-color: #e0e0e0; }
        .tool-button i { width: 16px; height: 16px; }
        #font-select { border-radius: 4px; border: 1px solid #ccc; background: white; max-width: 100%; font-size: 12px; }
        
        input[type="text"]#usernameInput {
            background: rgba(0, 0, 0, 0.1);
            color: #000;
            border: none;
            outline: none;
            flex: 1;
            padding: 8px;
            border-radius: 8px;
        }
        #messageInput { flex: 1; border: 1px solid #ccc; padding: 8px; border-radius: 15px; color: #111; max-height: 80px; overflow-y: auto; background: white; }
        #sendBtn { background: transparent; border: none; padding: 4px; cursor: pointer; width: auto; color: black; display: flex; }
        #sendBtn i { width: 20px; height: 20px; }
        .emoji-button { font-size: 20px; border: none; background: none; cursor: pointer; }
        .emoji-picker-container { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; max-height: 150px; overflow-y: auto; padding: 5px; }
        .emoji-category-tabs { display: flex; justify-content: center; margin-bottom: 10px; }
        .emoji-category-tabs button { padding: 5px 10px; border: none; background: #eee; cursor: pointer; }
        #formatting-popup {
            position: absolute;
            bottom: calc(100% + 5px);
            left: 10px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px;
            display: none;
            flex-wrap: nowrap;
            gap: 4px;
            width: 95%;
            overflow-x: auto;
            border: 1px solid #ddd;
            z-index: 1003;
        }
        #formatting-popup.open { display: flex; }
        #reaction-popup, #emoji-modal { position: fixed; display: none; background: #fff; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.25); padding: 8px; z-index: 1001; top: 50%; left: 50%; transform: translate(-50%, -50%); flex-direction: column; }
        #emoji-modal .modal-content { padding: 0; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1002; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; max-width: 400px; width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column; align-items: center; }
        .modal-header { display: flex; justify-content: center; align-items: center; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 15px; width: 100%; }
        .modal-header h2 { margin: 0; font-size: 18px; }
        .screen.active { display: flex; }
        .form-group { display: flex; align-items: center; border-bottom: 1px solid #e0e0e0; padding: 5px; width: 90%; }
        input { border: none; outline: none; flex: 1; padding: 8px; background: transparent; }
        button { background: black; color: white; border: none; border-radius: 5px; padding: 10px; font-weight: bold; cursor: pointer; width: 90%; margin-top: 10px; }
        .header-button { background: none; border: none; padding: 0; cursor: pointer; color: #333; }
        .emoji-button {
            font-size: 24px;
            border: none;
            background: none;
            cursor: pointer;
            padding: 5px;
            flex-basis: calc(100% / 7);
            max-width: calc(100% / 7);
            box-sizing: border-box;
        }
        #admin-panel-modal .modal-content {
            overflow-y: auto;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
        }
        .admin-global-message-container {
            width: 100%;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        .admin-global-formatting-toolbar {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 4px;
            width: 100%;
            margin-bottom: 10px;
            padding: 5px 0;
            border-radius: 5px;
            background-color: #f1f1f1;
            align-items: center;
        }
        .admin-global-formatting-toolbar select {
            border-radius: 4px;
            border: 1px solid #ccc;
            background: white;
            max-width: 100%;
            font-size: 12px;
        }
        #adminGlobalMessage {
            flex: 1;
            border: 1px solid #ccc;
            border-radius: 15px;
            padding: 8px;
            min-height: 50px;
            max-height: 100px;
            overflow-y: auto;
        }
        .global-message {
            position: relative;
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 10px;
            font-weight: bold;
            color: white;
            background: linear-gradient(45deg, #007bff, #dc3545, #28a745);
            border: 2px solid;
            border-image: linear-gradient(45deg, #007bff, #dc3545, #28a745) 1;
        }
        #admin-stats { margin-bottom: 20px; text-align: center; font-size: 14px; }
        #admin-room-list { margin-top: 15px; width: 90%; text-align: left; font-size: 14px; }
        #admin-room-list ul { list-style: none; padding: 0; margin: 0; }
        #admin-room-list li { margin-bottom: 5px; }
        .admin-search-group { display: flex; flex-direction: column; width: 90%; gap: 10px; margin-bottom: 20px; }
        .admin-search-group input { border: 1px solid #ccc; border-radius: 5px; }
        .admin-search-group button { margin-top: 0; }
        #admin-search-results { margin-top: 15px; width: 90%; text-align: center; font-size: 14px; min-height: 20px; }
        .reactions-display { 
            display: flex; 
            gap: 5px;
            flex-wrap: wrap; 
        }
        .reaction-count { display: flex; align-items: center; background-color: #f1f1f1; border-radius: 12px; padding: 2px 6px; font-size: 12px; }
        .reaction-count i { width: 12px; height: 12px; margin-right: 3px; }
        .highlighted { background-color: yellow; }
        #messageInput.font-size-small { font-size: 12px; }
        #messageInput.font-size-medium { font-size: 16px; }
        #messageInput.font-size-large { font-size: 20px; }
        .shake-animation {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        #audio-call-modal .modal-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #audio-call-modal h3 {
            margin: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            width: 100%;
            text-align: center;
        }
        #audio-call-modal button {
            width: 100%;
            margin: 0;
            padding: 8px;
            text-align: left;
            background: #f1f1f1;
            color: #333;
            border: 1px solid #ddd;
        }
        #audio-call-modal button:hover {
            background: #e9e9e9;
        }
    </style>
</head>
<body>
    <div id="chatIcon"><i data-feather="message-square"></i></div>
    <audio id="messageSound" src="https://www.soundjay.com/buttons/button-10.mp3" preload="auto"></audio>
    <audio id="applauseSound" src="https://assets.mixkit.co/sfx/preview/mixkit-small-group-of-people-applauding-511.mp3" preload="auto"></audio>
    <audio id="screamSound" src="https://assets.mixkit.co/sfx/preview/mixkit-scream-of-a-man-in-fear-1279.mp3" preload="auto"></audio>
    <audio id="attentionSound" src="https://assets.mixkit.co/sfx/preview/mixkit-attention-bell-2759.mp3" preload="auto"></audio>
    <audio id="thumbsUpSound" src="https://www.soundjay.com/buttons/sounds/button-36.mp3" preload="auto"></audio>
    <audio id="heartSound" src="https://www.soundjay.com/buttons/sounds/button-18.mp3" preload="auto"></audio>
    <audio id="smileSound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>
    <audio id="starSound" src="https://www.soundjay.com/buttons/sounds/button-2.mp3" preload="auto"></audio>
    <audio id="frownSound" src="https://www.soundjay.com/buttons/sounds/button-37.mp3" preload="auto"></audio>
    <audio id="thumbsDownSound" src="https://www.soundjay.com/buttons/sounds/button-1.mp3" preload="auto"></audio>
    <audio id="helpCircleSound" src="https://www.soundjay.com/buttons/sounds/button-7.mp3" preload="auto"></audio>
    <audio id="checkCircleSound" src="https://www.soundjay.com/buttons/sounds/button-23.mp3" preload="auto"></audio>

    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <div class="header-icons-left">
                <button id="backToChatBtn" class="header-button"><i data-feather="arrow-left"></i></button>
                <button id="roomsBtn" class="header-button"><i data-feather="hash"></i></button>
                <button id="usersOnlineBtn" class="header-button" title="Online Users" style="display: none;"><i data-feather="users"></i></button>
                <button id="audioToggleBtn" class="header-button" title="Toggle Notifications" style="display: none;"><i data-feather="volume-2"></i></button>
                <button id="minimizeChatBtn" class="header-button" title="Minimize" style="display: none;"><i data-feather="minus"></i></button>
                <button id="maximizeChatBtn" class="header-button" title="Maximize" style="display: none;"><i data-feather="maximize-2"></i></button>
                <button id="restoreChatBtn" class="header-button" title="Restore" style="display: none;"><i data-feather="minimize-2"></i></button>
            </div>
            <h2 id="screenTitle">Login</h2>
            <div class="header-icons-right">
                <button id="inviteUserBtn" class="header-button" title="Invite user" style="display: none;"><i data-feather="search"></i></button>
                <button id="adminPanelBtn" class="header-button" title="Admin Panel" style="display: none;"><i data-feather="star"></i></button>
                <button id="roomLockBtn" class="header-button" title="Lock/Unlock Room" style="display: none;"><i data-feather="unlock"></i></button>
                <button id="alarmBtn" class="header-button" title="Call attention" style="display: none;"><i data-feather="bell"></i></button>
                <button id="colorPaletteBtn" class="header-button" title="Change wallpaper color" style="display: none;"><i data-feather="droplet"></i></button>
                <input type="color" id="chatWallpaperColor" style="display: none;" />
                <button id="saveChatBtn" class="header-button" title="Save chat as PDF" style="display: none;"><i data-feather="save"></i></button>
                <button id="logoutBtn" class="header-button"><i data-feather="power"></i></button>
            </div>
        </div>
        <div class="screen active" id="loginScreen"><div class="form-group"><i data-feather="user"></i><input type="text" id="usernameInput" placeholder="Create username" /></div><button id="loginBtn">Enter</button></div>
        <div class="screen" id="chatScreen"></div>
        <div class="chat-footer" id="chatFooter">
            <div id="formatting-popup">
                <button class="tool-button" data-command="bold" title="Bold"><i data-feather="bold"></i></button>
                <button class="tool-button" data-command="italic" title="Italic"><i data-feather="italic"></i></button>
                <button class="tool-button" data-command="underline" title="Underline"><i data-feather="underline"></i></button>
                <button class="tool-button" data-command="strikethrough" title="Strikethrough"><i data-feather="minus"></i></button>
                <button class="tool-button" data-command="shadow" title="Shadow"><i data-feather="type"></i></button>
                <select id="font-select" title="Text Font"></select>
                <button class="tool-button" id="fontSizePlusBtn" title="Increase Font"><i data-feather="plus-circle"></i></button>
                <button class="tool-button" id="fontSizeMinusBtn" title="Decrease Font"><i data-feather="minus-circle"></i></button>
                <button class="tool-button" id="highlightBtn" title="Highlight Text"><i data-feather="pen-tool"></i></button>
                <input type="color" id="highlightPicker" style="display: none;" />
                <button class="tool-button" id="colorBtn" title="Text Color"><i data-feather="edit-3"></i></button>
                <input type="color" id="colorPicker" style="display: none;" />
            </div>
            <div class="footer-toolbar">
                <button class="tool-button" id="toggleFormattingBtn" title="Format Text"><i data-feather="plus"></i></button>
                <button class="tool-button" id="mentionBtn" title="Mention/Reply"><i data-feather="at-sign"></i></button>
                <button id="attachFileBtn" class="tool-button" title="Attach file"><i data-feather="paperclip"></i></button>
                <input type="file" id="fileUpload" accept="image/*" style="display: none;" />
                <button id="emojiBtn" class="tool-button" title="Emojis"><span class="material-symbols-outlined">sentiment_satisfied</span></button>
                <button id="audioCallBtn" class="tool-button" title="Audio Call" style="display: none;"><i data-feather="phone"></i></button>
            </div>
            <div id="messageInput" contenteditable="true" spellcheck="false"></div>
            <button id="sendBtn" title="Send message"><i data-feather="send"></i></button>
        </div>
    </div>
    
    <div id="reaction-popup" class="modal-content">
        <div class="reaction-options">
            <button class="reaction-button" data-message-id="" data-reaction="thumbs-up"><i data-feather="thumbs-up"></i></button>
            <button class="reaction-button" data-message-id="" data-reaction="heart"><i data-feather="heart"></i></button>
            <button class="reaction-button" data-message-id="" data-reaction="smile"><i data-feather="smile"></i></button>
            <button class="reaction-button" data-message-id="" data-reaction="star"><i data-feather="star"></i></button>
            <button class="reaction-button" data-message-id="" data-reaction="frown"><i data-feather="frown"></i></button>
            <button class="reaction-button" data-message-id="" data-reaction="thumbs-down"><i data-feather="thumbs-down"></i></button>
            <button class="reaction-button" data-message-id="" data-reaction="help-circle"><i data-feather="help-circle"></i></button>
            <button class="reaction-button" data-message-id="" data-reaction="check-circle"><i data-feather="check-circle"></i></button>
        </div>
        <div class="post-actions-buttons">
            
             <button class="action-button edit-post" title="Edit"><i data-feather="edit-2"></i></button>
             <button class="action-button delete-post" data-message-id="${messageId}" title="Delete"><i data-feather="trash-2"></i></button>
        </div>
    </div>
    <div class="modal-overlay" id="emoji-modal"><div class="modal-content"><div class="modal-header"><h2>Choose Emoji</h2></div><div id="emoji-picker"></div></div></div>
    <div class="modal-overlay" id="rooms-modal"><div class="modal-content"><div class="modal-header"><h2>Change Room</h2></div><div class="form-group"><i data-feather="hash"></i><input type="number" id="roomNumberInput" placeholder="Room number (0 = General)" min="0" /></div><button id="joinRoomBtn">Join Room</button></div></div>
    <div class="modal-overlay" id="users-online-modal"><div class="modal-content"><div class="modal-header"><h2>Online Users</h2></div><div id="users-list"></div></div></div>
    <div class="modal-overlay" id="alarm-modal"><div class="modal-content"><div class="modal-header"><h2>Call Attention</h2></div><div id="alarm-options"></div></div></div>
    <div class="modal-overlay" id="invite-modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Invite User</h2></div>
            <div class="form-group">
                <i data-feather="user"></i>
                <input type="text" id="usernameToInviteInput" placeholder="Username" />
            </div>
            <button id="sendInviteBtn">Invite</button>
        </div>
    </div>
    <div class="modal-overlay" id="audio-call-modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Audio Call</h2></div>
            <div id="audio-call-users-list"></div>
            <audio id="localAudio" autoplay muted></audio>
            <audio id="remoteAudio" autoplay></audio>
        </div>
    </div>
    
    <div class="modal-overlay" id="admin-panel-modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Admin Panel</h2></div>
            <div id="admin-stats"></div>
            <div class="admin-search-group">
                <input type="text" id="adminUserInput" placeholder="Search by user" />
                <button id="adminUserSearchBtn">Search User</button>
            </div>
            <div class="admin-search-group">
                <input type="number" id="adminRoomInput" placeholder="Search by room #" min="0" />
                <button id="adminRoomSearchBtn">Search Room</button>
            </div>
            <div id="admin-room-list"></div>
            <div class="admin-icon-toggles">
              <label><input type="checkbox" id="toggleRoomsBtn" checked /> Rooms</label>
              <label><input type="checkbox" id="toggleUsersOnlineBtn" checked /> Users Online</label>
              <label><input type="checkbox" id="toggleAudioToggleBtn" checked /> Audio</label>
              <label><input type="checkbox" id="toggleMinimizeChatBtn" checked /> Minimize</label>
              <label><input type="checkbox" id="toggleMaximizeChatBtn" checked /> Maximize</label>
              <label><input type="checkbox" id="toggleInviteUserBtn" checked /> Invite User</label>
              <label><input type="checkbox" id="toggleAdminPanelBtn" checked /> Admin Panel</label>
              <label><input type="checkbox" id="toggleRoomLockBtn" checked /> Room Lock</label>
              <label><input type="checkbox" id="toggleAlarmBtn" checked /> Alarm</label>
              <label><input type="checkbox" id="toggleColorPaletteBtn" checked /> Color Palette</label>
              <label><input type="checkbox" id="toggleSaveChatBtn" checked /> Save Chat</label>
              <label><input type="checkbox" id="toggleLogoutBtn" checked /> Logout</label>
              <label><input type="checkbox" id="toggleFormattingBtn" checked /> Formatting</label>
              <label><input type="checkbox" id="toggleMentionBtn" checked /> Mention</label>
              <label><input type="checkbox" id="toggleAttachFileBtn" checked /> Attach File</label>
              <label><input type="checkbox" id="toggleEmojiBtn" checked /> Emoji</label>
              <label><input type="checkbox" id="toggleSendBtn" checked /> Send Button</label>
            </div>
            <div id="admin-search-results"></div>
            <h3>Room Control</h3>
            <div id="admin-room-users"></div>
            <div class="admin-global-message-container">
                <h3>Global Announcement</h3>
                <div id="adminGlobalMessage" contenteditable="true" spellcheck="false" placeholder="Write global message..."></div>
                <div class="admin-global-formatting-toolbar">
                    <button class="tool-button" data-command="bold" title="Bold"><i data-feather="bold"></i></button>
                    <button class="tool-button" data-command="italic" title="Italic"><i data-feather="italic"></i></button>
                    <button class="tool-button" data-command="underline" title="Underline"><i data-feather="underline"></i></button>
                    <button class="tool-button" data-command="strikethrough" title="Strikethrough"><i data-feather="minus"></i></button>
                    <button class="tool-button" data-command="shadow" title="Shadow"><i data-feather="type"></i></button>
                    <button class="tool-button" id="admin-fontSizePlusBtn" title="Increase Font"><i data-feather="plus-circle"></i></button>
                    <button class="tool-button" id="admin-fontSizeMinusBtn" title="Decrease Font"><i data-feather="minus-circle"></i></button>
                    <button class="tool-button" id="admin-highlightBtn" title="Highlight Text"><i data-feather="pen-tool"></i></button>
                    <input type="color" id="admin-highlightPicker" style="display: none;" />
                    <button class="tool-button" id="admin-colorBtn" title="Text Color"><i data-feather="edit-3"></i></button>
                    <input type="color" id="admin-colorPicker" style="display: none;" />
                    <div id="admin-global-sound-selector" style="display: flex; align-items: center; gap: 5px;">
                        <i data-feather="music"></i>
                        <select id="admin-global-sound-select">
                            <option value="none" />None
                            <option value="screamSound" />Scream
                            <option value="applauseSound" />Applause
                            <option value="attentionSound" />Attention
                        </select>
                    </div>
                </div>
                <button id="sendGlobalMessageBtn" style="margin-top: 10px;">Send Global Message</button>
            </div>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Selectors ---
        const chatWindow = document.getElementById('chatWindow');
        const toggleFormattingBtn = document.getElementById('toggleFormattingBtn');
        const formattingPopup = document.getElementById('formatting-popup');
        const roomsBtn = document.getElementById('roomsBtn');
        const roomsModal = document.getElementById('rooms-modal');
        const roomNumberInput = document.getElementById('roomNumberInput');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const inviteUserBtn = document.getElementById('inviteUserBtn');
        const inviteModal = document.getElementById('invite-modal');
        const usernameToInviteInput = document.getElementById('usernameToInviteInput');
        const sendInviteBtn = document.getElementById('sendInviteBtn');
        const chatIcon=document.getElementById('chatIcon'),chatScreen=document.getElementById('chatScreen'),screenTitle=document.getElementById('screenTitle'),logoutBtn=document.getElementById('logoutBtn'),backToChatBtn=document.getElementById('backToChatBtn'),messageInput=document.getElementById('messageInput'),sendBtn=document.getElementById('sendBtn'),attachFileBtn=document.getElementById('attachFileBtn'),fileUpload=document.getElementById('fileUpload'),saveChatBtn=document.getElementById('saveChatBtn'),fontSelect=document.getElementById('font-select'),colorBtn=document.getElementById('colorBtn'),colorPicker=document.getElementById('colorPicker'),usernameInput=document.getElementById('usernameInput'),loginBtn=document.getElementById('loginBtn'),reactionPopup=document.getElementById('reaction-popup'),mentionBtn=document.getElementById('mentionBtn');
        
        // --- Admin Panel Selectors ---
        const adminPanelBtn = document.getElementById('adminPanelBtn');
        const adminPanelModal = document.getElementById('admin-panel-modal');
        const adminStatsDiv = document.getElementById('admin-stats');
        const adminUserInput = document.getElementById('adminUserInput');
        const adminUserSearchBtn = document.getElementById('adminUserSearchBtn');
        const adminRoomInput = document.getElementById('adminRoomInput');
        const adminRoomSearchBtn = document.getElementById('adminRoomSearchBtn');
        const adminSearchResults = document.getElementById('admin-search-results');
        const adminRoomList = document.getElementById('admin-room-list');
        const roomLockBtn = document.getElementById('roomLockBtn');
        const usersOnlineBtn = document.getElementById('usersOnlineBtn');
        const usersOnlineModal = document.getElementById('users-online-modal');
        const usersListDiv = document.getElementById('users-list');
        const alarmBtn = document.getElementById('alarmBtn');
        const alarmModal = document.getElementById('alarm-modal');
        const alarmOptionsDiv = document.getElementById('alarm-options');
        const fontSizePlusBtn = document.getElementById('fontSizePlusBtn');
        const fontSizeMinusBtn = document.getElementById('fontSizeMinusBtn');
        const highlightBtn = document.getElementById('highlightBtn');
        const highlightPicker = document.getElementById('highlightPicker');
        const adminRoomUsersDiv = document.getElementById('admin-room-users');
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiModal = document.getElementById('emoji-modal');
        const emojiPicker = document.getElementById('emoji-picker');
        const audioToggleBtn = document.getElementById('audioToggleBtn');
        const minimizeChatBtn = document.getElementById('minimizeChatBtn');
        const maximizeChatBtn = document.getElementById('maximizeChatBtn');
        const restoreChatBtn = document.getElementById('restoreChatBtn');
        const colorPaletteBtn = document.getElementById('colorPaletteBtn');
        const chatWallpaperColor = document.getElementById('chatWallpaperColor');
        const toggleRoomsBtn = document.getElementById('toggleRoomsBtn');
        const toggleUsersOnlineBtn = document.getElementById('toggleUsersOnlineBtn');
        const toggleAudioToggleBtn = document.getElementById('toggleAudioToggleBtn');
        const toggleMinimizeChatBtn = document.getElementById('toggleMinimizeChatBtn');
        const toggleMaximizeChatBtn = document.getElementById('toggleMaximizeChatBtn');
        const toggleInviteUserBtn = document.getElementById('toggleInviteUserBtn');
        const toggleAdminPanelBtn = document.getElementById('toggleAdminPanelBtn');
        const toggleRoomLockBtn = document.getElementById('toggleRoomLockBtn');
        const toggleAlarmBtn = document.getElementById('toggleAlarmBtn');
        const toggleColorPaletteBtn = document.getElementById('toggleColorPaletteBtn');
        const toggleSaveChatBtn = document.getElementById('toggleSaveChatBtn');
        const toggleLogoutBtn = document.getElementById('toggleLogoutBtn');
        const toggleFormattingBtnAdmin = document.getElementById('toggleFormattingBtn');
        const toggleMentionBtn = document.getElementById('toggleMentionBtn');
        const toggleAttachFileBtn = document.getElementById('toggleAttachFileBtn');
        const toggleEmojiBtn = document.getElementById('toggleEmojiBtn');
        const toggleSendBtn = document.getElementById('toggleSendBtn');
        const audioCallBtn = document.getElementById('audioCallBtn');
        const audioCallModal = document.getElementById('audio-call-modal');
        const audioCallUsersList = document.getElementById('audio-call-users-list');
        
        // --- State Variables ---
        let currentRoom = 0;
        let currentUser = "Guest", isAudioEnabled = true, messageIdCounter = 0;
        let activeStyles = { bold: false, italic: false, underline: false, strikethrough: false, shadow: false, color: '#000000', fontFamily: 'Roboto', highlight: '' };
        let activeFontSize = 16;
        let adminGlobalStyles = { bold: false, italic: false, underline: false, strikethrough: false, shadow: false, color: '#000000', fontFamily: 'Roboto', highlight: '' };
        let adminGlobalFontSize = 16;
        let adminGlobalSound = 'none';
        let isEditing = false;
        let messageToEditId = null;
        const googleFonts = ['Roboto','Open Sans','Lato','Montserrat','Oswald','Raleway','Poppins','Nunito','Playfair Display','Merriweather','Indie Flower','Dancing Script','Pacifico','Lobster','Source Code Pro','Nunito Sans','Inter','Work Sans','Fira Sans','Source Sans Pro','PT Sans','Ubuntu','Lora','Quicksand','Comfortaa', 'Bebas Neue', 'Kanit', 'Permanent Marker', 'Anton', 'Archivo Black', 'Abril Fatface', 'Josefin Sans', 'Satisfy', 'Courgette', 'Noto Sans', 'Dosis', 'Merriweather Sans', 'Concert One', 'Passion One', 'Barlow', 'Caveat', 'Alfa Slab One', 'Exo 2', 'Secular One'];
        const messageReactions = {};
        const availableReactions = [{type:'icon',id:'thumbs-up',label:'Like'},{type:'icon',id:'heart',label:'Love'},{type:'icon',id:'smile',label:'Haha'},{type:'icon',id:'star',label:'Wow'},{type:'icon',id:'frown',label:'Sad'},{type:'icon',id:'thumbs-down',label:'No'},{type:'icon',id:'help-circle',label:'Thinking'},{type:'icon',id:'check-circle',label:'Approve'}];
        const reactionSounds = {
            'thumbs-up': new Audio('https://www.soundjay.com/buttons/sounds/button-36.mp3'),
            'heart': new Audio('https://www.soundjay.com/buttons/sounds/button-18.mp3'),
            'smile': new Audio('https://www.soundjay.com/buttons/sounds/button-3.mp3'),
            'star': new Audio('https://www.soundjay.com/buttons/sounds/button-2.mp3'),
            'frown': new Audio('https://www.soundjay.com/buttons/sounds/button-37.mp3'),
            'thumbs-down': new Audio('https://www.soundjay.com/buttons/sounds/button-1.mp3'),
            'help-circle': new Audio('https://www.soundjay.com/buttons/sounds/button-7.mp3'),
            'check-circle': new Audio('https://www.soundjay.com/buttons/sounds/button-23.mp3')
        };
        const globalSounds = {
            'screamSound': new Audio('https://assets.mixkit.co/sfx/preview/mixkit-scream-of-a-man-in-fear-1279.mp3'),
            'applauseSound': new Audio('https://assets.mixkit.co/sfx/preview/mixkit-small-group-of-people-applauding-511.mp3'),
            'attentionSound': new Audio('https://assets.mixkit.co/sfx/preview/mixkit-attention-bell-2759.mp3'),
        };
        const emojis = {
            'ðŸ˜€': ['ðŸ˜€', 'ðŸ˜ƒ', 'ðŸ˜„', 'ðŸ˜', 'ðŸ˜†', 'ðŸ˜…', 'ðŸ¤£', 'ðŸ˜‚', 'ðŸ™‚', 'ðŸ™ƒ', 'ðŸ˜‰', 'ðŸ˜Š', 'ðŸ˜‡', 'ðŸ¥°', 'ðŸ˜', 'ðŸ¤©', 'ðŸ˜˜', 'ðŸ˜—', 'ðŸ˜š', 'ðŸ˜™', 'ðŸ˜‹', 'ðŸ˜›', 'ðŸ˜œ', 'ðŸ¤ª', 'ðŸ˜', 'ðŸ¤—', 'ðŸ¤­', 'ðŸ¤«', 'ðŸ¤”', 'ðŸ¤', 'ðŸ¤¨', 'ðŸ˜', 'ðŸ˜‘', 'ðŸ˜¶', 'ðŸ˜', 'ðŸ˜’', 'ðŸ™„', 'ðŸ˜¬', 'ðŸ¤¥', 'ðŸ˜Œ', 'ðŸ˜”', 'ðŸ˜ª', 'ðŸ¤¤', 'ðŸ˜´', 'ðŸ˜·', 'ðŸ¤’', 'ðŸ¤•', 'ðŸ¤¢', 'ðŸ¤®', 'ðŸ¤§', 'ðŸ¥µ', 'ðŸ¥¶', 'ðŸ¥´', 'ðŸ˜µ', 'ðŸ¤¯', 'ðŸ¤ ', 'ðŸ¥³', 'ðŸ˜Ž', 'ðŸ¤“', 'ðŸ§', 'ðŸ˜•', 'ðŸ˜Ÿ', 'ðŸ™', 'ðŸ˜®', 'ðŸ˜¯', 'ðŸ˜²', 'ðŸ˜³', 'ðŸ¥º', 'ðŸ˜¦', 'ðŸ˜§', 'ðŸ˜¨', 'ðŸ˜°', 'ðŸ˜¥', 'ðŸ˜¢', 'ðŸ˜­', 'ðŸ˜±', 'ðŸ˜–', 'ðŸ˜£', 'ðŸ˜©', 'ðŸ˜«', 'ðŸ˜¡', 'ðŸ˜ ', 'ðŸ˜¤', 'ðŸ¤¬', 'ðŸ˜ˆ', 'ðŸ‘¿', 'ðŸ’€', 'ðŸ‘»', 'ðŸ’©', 'ðŸ¤¡'],
            'ðŸ”': ['ðŸ‡', 'ðŸˆ', 'ðŸ‰', 'ðŸŠ', 'ðŸ‹', 'ðŸŒ', 'ðŸ', 'ðŸ¥­', 'ðŸŽ', 'ðŸ', 'ðŸ', 'ðŸ‘', 'ðŸ’', 'ðŸ“', 'ðŸ¥', 'ðŸ…', 'ðŸ¥¥', 'ðŸ¥‘', 'ðŸ†', 'ðŸ¥”', 'ðŸ¥•', 'ðŸŒ½', 'ðŸŒ¶ï¸', 'ðŸ¥’', 'ðŸ¥¬', 'ðŸ¥¦', 'ðŸ„', 'ðŸ¥œ', 'ðŸŒ°', 'ðŸž', 'ðŸ¥', 'ðŸ¥–', 'ðŸ¥¨', 'ðŸ¥ž', 'ðŸ§‡', 'ðŸ§€', 'ðŸ—', 'ðŸ–', 'ðŸ¥©', 'ðŸ¥“', 'ðŸ”', 'ðŸŸ', 'ðŸ•', 'ðŸŒ­', 'ðŸ¥ª', 'ðŸŒ®', 'ðŸŒ¯', 'ðŸ¥™', 'ðŸ³', 'ðŸ¥š', 'ðŸ¥˜', 'ðŸ²', 'ðŸœ', 'ðŸ', 'ðŸ£', 'ðŸ¤', 'ðŸš', 'ðŸ™', 'ðŸ˜', 'ðŸ¥', 'ðŸ¡', 'ðŸ¢', 'ðŸ§', 'ðŸ¨', 'ðŸ¦', 'ðŸ¥§', 'ðŸ°', 'ðŸŽ‚', 'ðŸ®', 'ðŸ¬', 'ðŸ­', 'ðŸ«', 'ðŸ¿', 'ðŸ©', 'ðŸª', 'ðŸ¥›', 'â˜•', 'ðŸµ', 'ðŸ¶', 'ðŸ¾', 'ðŸ·', 'ðŸ¸', 'ðŸ¹', 'ðŸº', 'ðŸ»', 'ðŸ¥‚', 'ðŸ¥ƒ', 'ðŸ¥¤', 'ðŸ§ƒ'],
            'ðŸ¶': ['ðŸ¶', 'ðŸ±', 'ðŸ­', 'ðŸ¹', 'ðŸ°', 'ðŸ¦Š', 'ðŸ»', 'ðŸ¼', 'ðŸ¨', 'ðŸ¯', 'ðŸ¦', 'ðŸ®', 'ðŸ·', 'ðŸ¸', 'ðŸµ', 'ðŸ”', 'ðŸ§', 'ðŸ¦', 'ðŸ¦‰', 'ðŸ¦†', 'ðŸ¦…', 'ðŸ¦‹', 'ðŸ›', 'ðŸ', 'ðŸž', 'ðŸ¢', 'ðŸ', 'ðŸ¦•', 'ðŸ¦–', 'ðŸ™', 'ðŸ¦‘', 'ðŸ¦€', 'ðŸ¦ž', 'ðŸ¦', 'ðŸ ', 'ðŸŸ', 'ðŸ¡', 'ðŸ¬', 'ðŸ³', 'ðŸ¦ˆ', 'ðŸŠ', 'ðŸ…', 'ðŸ†', 'ðŸ¦“', 'ðŸ¦’', 'ðŸ˜', 'ðŸ¦', 'ðŸª', 'ðŸ«', 'ðŸ¦˜', 'ðŸƒ', 'ðŸ‚', 'ðŸ„', 'ðŸ–', 'ðŸ', 'ðŸ‘', 'ðŸ', 'ðŸ¦Œ', 'ðŸŽ', 'ðŸ´', 'ðŸ¦„', 'ðŸ•Šï¸', 'ðŸ¾', 'ðŸŒ³', 'ðŸŒ²', 'ðŸŒ´', 'ðŸŒµ', 'ðŸŒ·', 'ðŸŒ¸', 'ðŸŒ¹', 'ðŸŒ»', 'ðŸŒ¼', 'ðŸŒº', 'ðŸŒ¾', 'ðŸ', 'ðŸ‚', 'ðŸ„'],
            'ðŸš—': ['âš½', 'ðŸ€', 'ðŸˆ', 'âš¾', 'ðŸŽ¾', 'ðŸ', 'ðŸ‰', 'ðŸŽ±', 'ðŸ“', 'ðŸ¸', 'ðŸ’', 'ðŸ¥', 'ðŸ‘', 'ðŸ¹', 'ðŸŽ£', 'ðŸ¥Š', 'ðŸ¥‹', 'ðŸŽ¿', 'ðŸ‚', 'ðŸ›·', 'â›¸ï¸', 'ðŸ¥Œ', 'ðŸŽ½', 'ðŸ¤¸', 'ðŸ‹ï¸', 'â›¹ï¸', 'ðŸ¤º', 'ðŸŒï¸', 'ðŸ„', 'ðŸŠ', 'ðŸ¤½', 'ðŸš£', 'ðŸ‡', 'ðŸš´', 'ðŸšµ', 'ðŸ›£ï¸', 'ðŸ›¤ï¸', 'ðŸš¢', 'ðŸ›³ï¸', 'â›µ', 'ðŸš¤', 'ðŸ›¥ï¸', 'ðŸš€', 'ðŸš', 'âœˆï¸', 'ðŸ›«', 'ðŸ›¬', 'ðŸšŠ', 'ðŸš‚', 'ðŸšƒ', 'ðŸš„', 'ðŸš…', 'ðŸš†', 'ðŸš‡', 'ðŸšˆ', 'ðŸš‰', 'ðŸš', 'ðŸšŒ', 'ðŸš', 'ðŸš‘', 'ðŸš’', 'ðŸš“', 'ðŸš•', 'ðŸš–', 'ðŸš—', 'ðŸš™', 'ðŸšš', 'ðŸš›', 'ðŸšœ', 'ðŸ›µ', 'ðŸš²', 'ðŸ›´', 'ðŸ—ºï¸', 'ðŸ“', 'ðŸ§­'],
            'ðŸ’¡': ['âŒš', 'ðŸ“±', 'ðŸ“²', 'ðŸ’»', 'ðŸ–¥ï¸', 'âŒ¨ï¸', 'ðŸ–±ï¸', 'ðŸ’½', 'ðŸ’¾', 'ðŸ’¿', 'ðŸ“€', 'ðŸ§®', 'ðŸ“¹', 'ðŸ“·', 'ðŸ“¸', 'ðŸ“½ï¸', 'ðŸŽ¥', 'ðŸŽ¬', 'ðŸ“ž', 'â˜Žï¸', 'ðŸ“Ÿ', 'ðŸ“ ', 'ðŸ”Œ', 'ðŸ”‹', 'ðŸ—‘ï¸', 'ðŸ›¢ï¸', 'ðŸ”¦', 'ðŸ’¡', 'ðŸ”¦', 'ðŸ“–', 'ðŸ“š', 'ðŸ“œ', 'ðŸ“°', 'ðŸ—žï¸', 'ðŸ”–', 'ðŸ·ï¸', 'ðŸ’°', 'ðŸ’µ', 'ðŸ’³', 'ðŸ’Ž', 'ðŸ”‘', 'ðŸ”“', 'ðŸ”', 'ðŸ”’', 'ðŸ”', 'ðŸ”‘', 'ðŸ”¨', 'âš’ï¸', 'â›ï¸', 'ðŸ”©', 'âš™ï¸', 'ðŸ”§', 'â›“ï¸', 'ðŸ§°', 'ðŸ§±', 'ðŸšª', 'ðŸª‘', 'ðŸ›‹ï¸', 'ðŸ›ï¸', 'ðŸ›', 'ðŸš¿', 'ðŸš½', 'ðŸª ', 'ðŸ””', 'ðŸ”•', 'ðŸ“¢', 'ðŸ“£', 'ðŸ“¯', 'ðŸŽ¶', 'ðŸŽ¼', 'ðŸŽµ', 'ðŸŽ™ï¸', 'ðŸŽ¤', 'ðŸŽ§', 'ðŸ“»', 'ðŸ“º', 'ðŸ“»', 'ðŸŽ', 'ðŸŽ€', 'ðŸŽ‰', 'ðŸŽŠ', 'ðŸŽˆ', 'ðŸ“§', 'âœ‰ï¸', 'ðŸ“¦', 'ðŸ“¤', 'ðŸ“¥', 'ðŸ“«', 'ðŸ“ª', 'ðŸ“¬', 'ðŸ“­', 'ðŸ“®'],
            'ðŸ‡§ðŸ‡·': ['ðŸ‡§ðŸ‡·', 'ðŸ‡ºðŸ‡¸', 'ðŸ‡ªðŸ‡¸', 'ðŸ‡«ðŸ‡·', 'ðŸ‡©ðŸ‡ª', 'ðŸ‡®ðŸ‡¹', 'ðŸ‡¯ðŸ‡µ', 'ðŸ‡¨ðŸ‡³', 'ðŸ‡·ðŸ‡º', 'ðŸ‡®ðŸ‡³', 'ðŸ‡¦ðŸ‡·', 'ðŸ‡¨ðŸ‡¦', 'ðŸ‡²ðŸ‡½', 'ðŸ‡µðŸ‡¹', 'ðŸ‡¬ðŸ‡§', 'ðŸ‡°ðŸ‡·', 'ðŸ‡¦ðŸ‡º', 'ðŸ‡¿ðŸ‡¦', 'ðŸ‡ªðŸ‡¬', 'ðŸ‡¸ðŸ‡¦', 'ðŸ‡¹ðŸ‡·', 'ðŸ‡µðŸ‡±', 'ðŸ‡®ðŸ‡©', 'ðŸ‡¹ðŸ‡­', 'ðŸ‡»ðŸ‡³', 'ðŸ‡³ðŸ‡¬', 'ðŸ‡¨ðŸ‡´', 'ðŸ‡µðŸ‡°', 'ðŸ‡©ðŸ‡¿', 'ðŸ‡®ðŸ‡¶', 'ðŸ‡ºðŸ‡¦', 'ðŸ‡¨ðŸ‡­', 'ðŸ‡³ðŸ‡±', 'ðŸ‡§ðŸ‡ª', 'ðŸ‡¸ðŸ‡ª', 'ðŸ‡³ðŸ‡´', 'ðŸ‡«ðŸ‡®', 'ðŸ‡©ðŸ‡°', 'ðŸ‡®ðŸ‡ª', 'ðŸ‡¬ðŸ‡·', 'ðŸ‡¨ðŸ‡±', 'ðŸ‡µðŸ‡ª', 'ðŸ‡ªðŸ‡¨', 'ðŸ‡»ðŸ‡ª', 'ðŸ‡ºðŸ‡¾', 'ðŸ‡µðŸ‡¾', 'ðŸ‡§ðŸ‡´', 'ðŸ‡¦ðŸ‡ª', 'ðŸ‡¶ðŸ‡¦', 'ðŸ‡°ðŸ‡¼', 'ðŸ‡®ðŸ‡±', 'ðŸ‡¹ðŸ‡¼', 'ðŸ‡¸ðŸ‡¬', 'ðŸ‡²ðŸ‡¾', 'ðŸ‡µðŸ‡­', 'ðŸ‡®ðŸ‡¨', 'ðŸ‡­ðŸ‡·', 'ðŸ‡·ðŸ‡´', 'ðŸ‡¨ðŸ‡¿', 'ðŸ‡­ðŸ‡º', 'ðŸ‡§ðŸ‡¬', 'ðŸ‡¦ðŸ‡¹', 'ðŸ‡¸ðŸ‡°', 'ðŸ‡¸ðŸ‡®', 'ðŸ‡±ðŸ‡»', 'ðŸ‡ªðŸ‡ª', 'ðŸ‡±ðŸ‡¹', 'ðŸ‡²ðŸ‡¹', 'ðŸ‡¨ðŸ‡¾', 'ðŸ‡¦ðŸ‡±', 'ðŸ‡§ðŸ‡¦', 'ðŸ‡²ðŸ‡ª', 'ðŸ‡²ðŸ‡°', 'ðŸ‡½ðŸ‡°', 'ðŸ‡·ðŸ‡¸', 'ðŸ‡¨ðŸ‡¿', 'ðŸ‡¬ðŸ‡ª', 'ðŸ‡¦ðŸ‡²', 'ðŸ‡¦ðŸ‡¿', 'ðŸ‡°ðŸ‡¿', 'ðŸ‡ºðŸ‡¿', 'ðŸ‡¹ðŸ‡²', 'ðŸ‡¹ðŸ‡¯', 'ðŸ‡°ðŸ‡¬', 'ðŸ‡±ðŸ‡°', 'ðŸ‡§ðŸ‡©', 'ðŸ‡³ðŸ‡µ', 'ðŸ‡²ðŸ‡²', 'ðŸ‡°ðŸ‡­', 'ðŸ‡±ðŸ‡¦', 'ðŸ‡µðŸ‡¬', 'ðŸ‡«ðŸ‡¯', 'ðŸ‡³ðŸ‡¿', 'ðŸ‡¼ðŸ‡¸', 'ðŸ‡¹ðŸ‡´', 'ðŸ‡¹ðŸ‡»', 'ðŸ‡°ðŸ‡®', 'ðŸ‡²ðŸ‡­', 'ðŸ‡«ðŸ‡²', 'ðŸ‡µðŸ‡¼', 'ðŸ‡¸ðŸ‡§', 'ðŸ‡»ðŸ‡º', 'ðŸ‡¦ðŸ‡®', 'ðŸ‡¦ðŸ‡¶', 'ðŸ‡¦ðŸ‡¸', 'ðŸ‡¦ðŸ‡¼', 'ðŸ‡¦ðŸ‡½', 'ðŸ‡§ðŸ‡§', 'ðŸ‡§ðŸ‡²', 'ðŸ‡§ðŸ‡¼', 'ðŸ‡¨ðŸ‡©', 'ðŸ‡¨ðŸ‡«', 'ðŸ‡¨ðŸ‡¬', 'ðŸ‡¨ðŸ‡®', 'ðŸ‡¨ðŸ‡°', 'ðŸ‡¨ðŸ‡½', 'ðŸ‡¨ðŸ‡¿', 'ðŸ‡ªðŸ‡­', 'ðŸ‡ªðŸ‡·', 'ðŸ‡ªðŸ‡¹', 'ðŸ‡«ðŸ‡´', 'ðŸ‡¬ðŸ‡¦', 'ðŸ‡¬ðŸ‡©', 'ðŸ‡¬ðŸ‡«', 'ðŸ‡¬ðŸ‡¬', 'ðŸ‡¬ðŸ‡­', 'ðŸ‡¬ðŸ‡®', 'ðŸ‡¬ðŸ‡±', 'ðŸ‡¬ðŸ‡²', 'ðŸ‡¬ðŸ‡¼', 'ðŸ‡¬ðŸ‡¾', 'ðŸ‡­ðŸ‡°', 'ðŸ‡®ðŸ‡´', 'ðŸ‡¯ðŸ‡ª', 'ðŸ‡°ðŸ‡ª', 'ðŸ‡°ðŸ‡²', 'ðŸ‡±ðŸ‡¨', 'ðŸ‡±ðŸ‡®', 'ðŸ‡²ðŸ‡¬', 'ðŸ‡²ðŸ‡·', 'ðŸ‡²ðŸ‡º', 'ðŸ‡²ðŸ‡¼', 'ðŸ‡²ðŸ‡½', 'ðŸ‡²ðŸ‡¾', 'ðŸ‡²ðŸ‡¿', 'ðŸ‡³ðŸ‡¦', 'ðŸ‡³ðŸ‡¨', 'ðŸ‡³ðŸ‡ª', 'ðŸ‡³ðŸ‡«', 'ðŸ‡³ðŸ‡¬', 'ðŸ‡³ðŸ‡±', 'ðŸ‡³ðŸ‡´', 'ðŸ‡³ðŸ‡µ', 'ðŸ‡³ðŸ‡·', 'ðŸ‡³ðŸ‡º', 'ðŸ‡³ðŸ‡¿', 'ðŸ‡´ðŸ‡²', 'ðŸ‡µðŸ‡¦', 'ðŸ‡µðŸ‡ª', 'ðŸ‡µðŸ‡«', 'ðŸ‡µðŸ‡¬', 'ðŸ‡µðŸ‡­', 'ðŸ‡µðŸ‡°', 'ðŸ‡µðŸ‡±', 'ðŸ‡µðŸ‡²', 'ðŸ‡µðŸ‡³', 'ðŸ‡µðŸ‡·', 'ðŸ‡µðŸ‡¸', 'ðŸ‡µðŸ‡¹', 'ðŸ‡µðŸ‡¼', 'ðŸ‡µðŸ‡¾', 'ðŸ‡¶ðŸ‡¦', 'ðŸ‡·ðŸ‡ª', 'ðŸ‡·ðŸ‡´', 'ðŸ‡·ðŸ‡¸', 'ðŸ‡·ðŸ‡º', 'ðŸ‡·ðŸ‡¼', 'ðŸ‡¸ðŸ‡¦', 'ðŸ‡¸ðŸ‡§', 'ðŸ‡¸ðŸ‡¨', 'ðŸ‡¸ðŸ‡©', 'ðŸ‡¸ðŸ‡ª', 'ðŸ‡¸ðŸ‡¬', 'ðŸ‡¸ðŸ‡­', 'ðŸ‡¸ðŸ‡®', 'ðŸ‡¸ðŸ‡°', 'ðŸ‡¸ðŸ‡±', 'ðŸ‡¸ðŸ‡²', 'ðŸ‡¸ðŸ‡³', 'ðŸ‡¸ðŸ‡´', 'ðŸ‡¸ðŸ‡·', 'ðŸ‡¸ðŸ‡¸', 'ðŸ‡¸ðŸ‡¹', 'ðŸ‡¸ðŸ‡»', 'ðŸ‡¸ðŸ‡½', 'ðŸ‡¸ðŸ‡¾', 'ðŸ‡¸ðŸ‡¿', 'ðŸ‡¹ðŸ‡¨', 'ðŸ‡¹ðŸ‡©', 'ðŸ‡¹ðŸ‡«', 'ðŸ‡¹ðŸ‡¬', 'ðŸ‡¹ðŸ‡­', 'ðŸ‡¹ðŸ‡¯', 'ðŸ‡¹ðŸ‡°', 'ðŸ‡¹ðŸ‡±', 'ðŸ‡¹ðŸ‡²', 'ðŸ‡¹ðŸ‡³', 'ðŸ‡¹ðŸ‡´', 'ðŸ‡¹ðŸ‡·', 'ðŸ‡¹ðŸ‡¹', 'ðŸ‡¹ðŸ‡»', 'ðŸ‡¹ðŸ‡¼', 'ðŸ‡¹ðŸ‡¿', 'ðŸ‡ºðŸ‡¦', 'ðŸ‡ºðŸ‡¬', 'ðŸ‡ºðŸ‡²', 'ðŸ‡ºðŸ‡³', 'ðŸ‡ºðŸ‡¸', 'ðŸ‡ºðŸ‡¾', 'ðŸ‡ºðŸ‡¿', 'ðŸ‡»ðŸ‡¦', 'ðŸ‡»ðŸ‡¨', 'ðŸ‡»ðŸ‡ª', 'ðŸ‡»ðŸ‡¬', 'ðŸ‡»ðŸ‡®', 'ðŸ‡»ðŸ‡³', 'ðŸ‡»ðŸ‡º', 'ðŸ‡¼ðŸ‡«', 'ðŸ‡¼ðŸ‡¸', 'ðŸ‡½ðŸ‡°', 'ðŸ‡¾ðŸ‡ª', 'ðŸ‡¾ðŸ‡¹', 'ðŸ‡¿ðŸ‡¦', 'ðŸ‡¿ðŸ‡²', 'ðŸ‡¿ðŸ‡¼']
        };
        let chatState = { mode: 'main', withUser: null };
        let isAudioCallActive = false;
        let localStream = null;
        let peerConnection = null;
        const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        
        let simulatedServerState = {
            users: {},
            roomLocks: {1: false, 2: false}
        };
        
        let userReactions = {};
        let userAlarmCounts = {};
        
        const messageSound = new Audio('https://www.soundjay.com/buttons/button-10.mp3');
        const applauseSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-small-group-of-people-applauding-511.mp3');
        const screamSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-scream-of-a-man-in-fear-1279.mp3');
        const attentionSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-attention-bell-2759.mp3');
        const thumbsUpSound = new Audio('https://www.soundjay.com/buttons/sounds/button-36.mp3');
        const heartSound = new Audio('https://www.soundjay.com/buttons/sounds/button-18.mp3');
        const smileSound = new Audio('https://www.soundjay.com/buttons/sounds/button-3.mp3');
        const starSound = new Audio('https://www.soundjay.com/buttons/sounds/button-2.mp3');
        const frownSound = new Audio('https://www.soundjay.com/buttons/sounds/button-37.mp3');
        const thumbsDownSound = new Audio('https://www.soundjay.com/buttons/sounds/button-1.mp3');
        const helpCircleSound = new Audio('https://www.soundjay.com/buttons/sounds/button-7.mp3');
        const checkCircleSound = new Audio('https://www.soundjay.com/buttons/sounds/button-23.mp3');
        
        const socket = io();

        socket.on('connect', () => {
            console.log('Connected to server');
        });
        
        socket.on('update users', (users) => {
             simulatedServerState.users = users;
             updateAdminStats();
             updateAdminRoomUsers();
        });

        socket.on('system message', (message) => {
            displaySystemMessage(message);
        });

        socket.on('chat message', (msg) => {
            createMessageElement(msg.content, msg.username === currentUser);
        });

        socket.on('room lock status', (isLocked) => {
            const icon = roomLockBtn.querySelector('i');
            icon.setAttribute('data-feather', isLocked ? 'lock' : 'unlock');
            feather.replace();
        });

        socket.on('room invite', ({ inviter, room }) => {
            displayInviteMessage(inviter, room);
        });

        // WebRTC Signaling
        socket.on('audio call offer', async (offer) => {
            if (isAudioCallActive) return;
            isAudioCallActive = true;
            audioCallBtn.querySelector('i').setAttribute('data-feather', 'phone-off');
            feather.replace();
            displaySystemMessage('Incoming audio call...');

            await getLocalStream();
            peerConnection = new RTCPeerConnection(configuration);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnection.ontrack = (event) => {
                document.getElementById('remoteAudio').srcObject = event.streams[0];
            };

            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('audio call answer', { answer: peerConnection.localDescription });
        });

        socket.on('audio call answer', async (answer) => {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        });

        socket.on('ice candidate', async (candidate) => {
            try {
                if (peerConnection) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                }
            } catch (e) {
                console.error('Error adding received ice candidate', e);
            }
        });

        socket.on('call ended', () => {
            endAudioCall();
            displaySystemMessage('Audio call ended.');
        });
        
        // Reset alarm count every hour
        setInterval(() => {
            userAlarmCounts = {};
        }, 3600000);

        // --- Admin Panel Functions ---
        function updateAdminStats() {
            const totalUsers = Object.keys(simulatedServerState.users).length;
            const activeRooms = new Set(Object.values(simulatedServerState.users));
            adminStatsDiv.innerHTML = `<b>Online Users:</b> ${totalUsers}`;
            
            adminRoomList.innerHTML = `<h3>Active Rooms:</h3><ul>${Array.from(activeRooms).map(room => `<li>Room ${room} ${simulatedServerState.roomLocks[room] ? '(Locked)' : ''}</li>`).join('')}</ul>`;
        }
        
        function updateAdminRoomUsers() {
            const usersInCurrentRoom = Object.entries(simulatedServerState.users).filter(([user, room]) => room === currentRoom).map(([user]) => user);
            
            let usersHtml = '<h3>Users in Room:</h3>';
            if (usersInCurrentRoom.length > 0) {
                usersHtml += `<div class="admin-user-list"><ul>${usersInCurrentRoom.map(user => `<li>${user} <button data-user-to-kick="${user}">Kick</button></li>`).join('')}</ul></div>`;
            } else {
                usersHtml += '<p>No other users in this room.</p>';
            }
            adminRoomUsersDiv.innerHTML = usersHtml;
        }
        function kickUser(username) {
            socket.emit('kick user', username);
        }
        adminRoomUsersDiv.addEventListener('click', e => {
            const button = e.target.closest('button');
            if (button && button.dataset.userToKick) {
                const userToKick = button.dataset.userToKick;
                if (confirm(`Are you sure you want to kick ${userToKick}?`)) {
                    kickUser(userToKick);
                }
            }
        });
        
        function searchUserByName() {
            const userToFind = adminUserInput.value.trim();
            if (!userToFind) return;
            socket.emit('admin search user', userToFind);
        }
        
        function searchRoomContents() {
            const roomToFind = parseInt(adminRoomInput.value);
            if (isNaN(roomToFind)) return;
            socket.emit('admin search room', roomToFind);
        }
        
        function toggleRoomLock() {
            socket.emit('toggle room lock', currentRoom);
        }
        
        function onInviteReceived(inviterName, roomNumber) { displayInviteMessage(inviterName, roomNumber); }
        // --- Main Functions ---
        function displaySystemMessage(message) {const e=document.createElement('div');e.className='system-message';e.textContent=message;chatScreen.appendChild(e);chatScreen.scrollTop=chatScreen.scrollHeight; if (isAudioEnabled) messageSound.play();}
        function displayInviteMessage(inviterName, roomNumber) {
            const inviteDiv = document.createElement('div');
            inviteDiv.className = 'invite-message';
            inviteDiv.innerHTML = `<p><b>${inviterName}</b> invited you to join <b>Room ${roomNumber}</b>.</p><button class="invite-accept-btn" data-room="${roomNumber}">Yes</button><button class="invite-decline-btn decline">No</button>`;
            chatScreen.appendChild(inviteDiv);
            chatScreen.scrollTop = chatScreen.scrollHeight;
        }
        function displayGlobalMessage(message) {
            const e = document.createElement('div');
            e.className = 'global-message';
            e.innerHTML = `<b>Global Announcement:</b><br>${message}`;
            chatScreen.appendChild(e);
            chatScreen.scrollTop = chatScreen.scrollHeight;
            
            if (isAudioEnabled && adminGlobalSound !== 'none') {
                 const sound = globalSounds[adminGlobalSound];
                 if (sound) {
                     sound.currentTime = 0;
                     sound.play();
                 }
            }
        }
        function applyFormatting(text) {
            let s = text;
            if (activeStyles.bold) s = `<b>${s}</b>`;
            if (activeStyles.italic) s = `<i>${s}</i>`;
            if (activeStyles.underline) s = `<u>${s}</u>`;
            if (activeStyles.strikethrough) s = `<s>${s}</s>`;
            if (activeStyles.highlight) s = `<span style="background-color: ${activeStyles.highlight};">${s}</span>`;
            let style = `font-size: ${activeFontSize}px; color: ${activeStyles.color}; font-family: '${activeStyles.fontFamily}', sans-serif;`;
            if (activeStyles.shadow) style += ' text-shadow: 1px 1px 1px rgba(0,0,0,0.4);';
            return `<span style="${style}">${s}</span>`;
        }
        function applyGlobalFormatting(text) {
             let s = text;
            if (adminGlobalStyles.bold) s = `<b>${s}</b>`;
            if (adminGlobalStyles.italic) s = `<i>${s}</i>`;
            if (adminGlobalStyles.underline) s = `<u>${s}</u>`;
            if (adminGlobalStyles.strikethrough) s = `<s>${s}</s>`;
            if (adminGlobalStyles.highlight) s = `<span style="background-color: ${adminGlobalStyles.highlight};">${s}</span>`;
            let style = `font-size: ${adminGlobalFontSize}px; color: ${adminGlobalStyles.color}; font-family: '${adminGlobalStyles.fontFamily}', sans-serif;`;
            if (adminGlobalStyles.shadow) style += ' text-shadow: 1px 1px 1px rgba(0,0,0,0.4);';
            return `<span style="${style}">${s}</span>`;
        }
        function getCurrentTime() {
            const now = new Date();
            const options = {
                year: '2-digit',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true,
                timeZone: 'America/Vancouver'
            };
            const formatter = new Intl.DateTimeFormat('en-US', options);
            const formattedTime = formatter.format(now).replace(',', '');
            return `[${formattedTime} SLT]`;
        }
        function createMessageElement(msg, isMyMessage) {
            const { id, content, username, isAdmin, timestamp } = msg;
            const messageDiv = document.createElement('div');
            messageDiv.id = id;
            messageDiv.className = 'chat-message';
            if (isMyMessage) messageDiv.classList.add('my-message');
            
            let displayName = username;
            let adminStar = '';
            if (isAdmin) {
                const usernameOnly = username.replace(' (Admin)', '');
                displayName = `<b>${usernameOnly}</b>`;
                adminStar = '<i data-feather="star" class="admin-star"></i>';
            }
            
            const headerDiv = document.createElement('div');
            headerDiv.style.display = 'flex';
            headerDiv.style.alignItems = 'center';
            headerDiv.innerHTML = `${adminStar}<b>${displayName}:</b>`;
            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = content;
            
            const timestampSpan = document.createElement('span');
            timestampSpan.className = 'timestamp';
            timestampSpan.textContent = `[${timestamp}]`;
            const reactionsWrapper = document.createElement('div');
            reactionsWrapper.className = 'reactions-display';
            
            messageDiv.appendChild(headerDiv);
            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(timestampSpan);
            messageDiv.appendChild(reactionsWrapper);
            
            messageReactions[id] = {};
            userReactions[id] = {};
            chatScreen.appendChild(messageDiv);
            chatScreen.scrollTop=chatScreen.scrollHeight;
            feather.replace();
            if (isAudioEnabled) {
                messageSound.currentTime = 0;
                messageSound.play();
            }
        }
        
        function linkify(text) {
            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            return text.replace(urlRegex, url => `<a href="${url.startsWith('http')?url:'https://'+url}" target="_blank">${url}</a>`);
        }
        
        function sendMessage() {
            if (messageInput.textContent.trim() === "") return;
            const formattedContent = applyFormatting(linkify(messageInput.innerHTML));
            
            const msg = {
                content: formattedContent,
                id: `msg-${messageIdCounter++}`,
                username: currentUser,
                isAdmin: currentUser.includes('(Admin)'),
                timestamp: getCurrentTime()
            };

            if (isEditing) {
                socket.emit('edit message', { id: messageToEditId, content: formattedContent });
                isEditing = false;
                messageToEditId = null;
                sendBtn.innerHTML = '<i data-feather="send"></i>';
            } else {
                socket.emit('chat message', msg);
            }
            messageInput.innerHTML = '';
            messageInput.focus();
            feather.replace();
        }
        
        // --- Navigation and State ---
        function updateHeaderUI(){
            const chatScreenActive=document.getElementById('chatScreen').classList.contains('active'),loginScreenActive=document.getElementById('loginScreen').classList.contains('active');
            backToChatBtn.style.display=chatState.mode==='private'?'flex':'none';
            roomsBtn.style.display=chatScreenActive&&chatState.mode==='main'?'flex':'none';
            logoutBtn.style.display=loginScreenActive?'none':'flex';
            inviteUserBtn.style.display=chatScreenActive&&currentRoom>0?'flex':'none';
            adminPanelBtn.style.display = currentUser.includes('(Admin)') && !loginScreenActive ? 'flex' : 'none';
            
            roomLockBtn.style.display = currentUser.includes('(Admin)') && chatScreenActive && currentRoom !== 0 ? 'flex' : 'none';
            const icon = roomLockBtn.querySelector('i');
            if (icon) {
                if (simulatedServerState.roomLocks[currentRoom]) {
                    icon.setAttribute('data-feather', 'lock');
                } else {
                    icon.setAttribute('data-feather', 'unlock');
                }
            }
            
            usersOnlineBtn.style.display = chatScreenActive ? 'flex' : 'none';
            alarmBtn.style.display = chatScreenActive ? 'flex' : 'none';
            saveChatBtn.style.display = chatScreenActive ? 'flex' : 'none';
            colorPaletteBtn.style.display = chatScreenActive ? 'flex' : 'none';
            audioToggleBtn.style.display = !loginScreenActive ? 'flex' : 'none';
            minimizeChatBtn.style.display = !loginScreenActive ? 'flex' : 'none';
            maximizeChatBtn.style.display = !chatWindow.classList.contains('maximized') && !loginScreenActive ? 'flex' : 'none';
            restoreChatBtn.style.display = chatWindow.classList.contains('maximized') && !loginScreenActive ? 'flex' : 'none';
            audioCallBtn.style.display = !loginScreenActive ? 'flex' : 'none';
            
            if(loginScreenActive){
                screenTitle.innerText='Login';
            } else if (chatState.mode==='private'){
                screenTitle.innerText=`Chat with ${chatState.withUser}`;
            } else {
                screenTitle.innerText=`Chat - Room ${currentRoom}`;
            }
            feather.replace();
        }
        
        function showScreen(screenId){
            document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
            document.getElementById(screenId).classList.add("active");
            document.getElementById('chatFooter').style.display=screenId==='chatScreen'?'flex':'none';
            updateHeaderUI();
        }
        function login() {
            let username = usernameInput.value.trim();
            if (username === "") return void alert("Please enter a username.");
            
            const allowedCharsRegex = /^[a-zA-Z0-9.\-]+$/;
            if (!allowedCharsRegex.test(username)) {
                return void alert("The username can only contain letters, numbers, one period, or one hyphen, without accents.");
            }
            const dotOrHyphenCount = (username.match(/[\.\-]/g) || []).length;
            if (dotOrHyphenCount > 1) {
                return void alert("The username can only contain one period or one hyphen.");
            }
            if (username.includes('.') && username.includes('-')) {
                return void alert("The username can only contain one period or one hyphen, not both.");
            }
            
            const adminNames = ['serkan', 'elieser'];
            const adminPassword = '51995429192';
            if (adminNames.includes(username.toLowerCase())) {
                const enteredPassword = prompt("Restricted access. Please enter the Admin password:");
                if (enteredPassword === adminPassword) {
                    currentUser = `${username} (Admin)`;
                    socket.emit('login', { username: currentUser, room: currentRoom });
                    startMainChat();
                } else {
                    alert("Incorrect password. Access denied.");
                    return;
                }
            } else {
                currentUser = username;
                socket.emit('login', { username: currentUser, room: currentRoom });
                startMainChat();
            }
        }
        function startMainChat(){
            currentRoom=0;
            chatState={mode:'main',withUser:null};
            chatScreen.innerHTML='';
            displaySystemMessage(`Welcome, ${currentUser}!`);
            displaySystemMessage(`You have entered Room ${currentRoom} (General).`);
            updateHeaderUI();
            showScreen('chatScreen');
        }
        
        function changeRoom(newRoomStr) {
            const newRoom = parseInt(newRoomStr);
            if (isNaN(newRoom) || newRoom < 0) return alert("Invalid room number.");
            if (newRoom === currentRoom) return;

            socket.emit('change room', { oldRoom: currentRoom, newRoom, username: currentUser });
            currentRoom = newRoom;
            chatScreen.innerHTML = '';
            displaySystemMessage(`You have entered Room ${currentRoom}.`);
            updateHeaderUI();
        }
        
        // --- WebRTC Functions ---
        async function getLocalStream() {
            if (localStream) return;
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                document.getElementById('localAudio').srcObject = localStream;
            } catch (err) {
                console.error("Error accessing audio devices: ", err);
            }
        }
        
        async function startAudioCall() {
            await getLocalStream();
            if (!localStream) return;

            isAudioCallActive = true;
            audioCallBtn.querySelector('i').setAttribute('data-feather', 'phone-off');
            feather.replace();
            
            peerConnection = new RTCPeerConnection(configuration);

            peerConnection.ontrack = (event) => {
                document.getElementById('remoteAudio').srcObject = event.streams[0];
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice candidate', { candidate: event.candidate, to: 'other' });
                }
            };

            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.emit('audio call offer', { offer: offer });

            displaySystemMessage('Starting audio call...');
        }
        
        function endAudioCall() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            isAudioCallActive = false;
            audioCallBtn.querySelector('i').setAttribute('data-feather', 'phone');
            feather.replace();
            document.getElementById('localAudio').srcObject = null;
            document.getElementById('remoteAudio').srcObject = null;
        }

        // --- Event Listeners ---
        loginBtn.addEventListener("click", login);
        usernameInput.addEventListener('keydown', e => { if (e.key === 'Enter') login(); });
        logoutBtn.addEventListener("click", () => {
            socket.emit('logout', currentUser);
            showScreen('loginScreen');
        });
        
        adminPanelBtn.addEventListener('click', () => {
            adminPanelModal.style.display = 'flex';
            updateAdminStats();
            updateAdminRoomUsers();
            
            const adminGlobalMessageInput = document.getElementById('adminGlobalMessage');
            const sendGlobalMessageBtn = document.getElementById('sendGlobalMessageBtn');
            const adminGlobalFormattingToolbar = document.querySelector('.admin-global-formatting-toolbar');
            const adminColorPicker = document.getElementById('admin-colorPicker');
            const adminHighlightPicker = document.getElementById('admin-highlightPicker');
            const adminGlobalSoundSelect = document.getElementById('admin-global-sound-select');
            
            sendGlobalMessageBtn.addEventListener('click', () => {
                const message = adminGlobalMessageInput.innerHTML.trim();
                if (message) {
                    const formattedMessage = applyGlobalFormatting(message);
                    socket.emit('global message', { content: formattedMessage, sound: adminGlobalSound });
                    adminGlobalMessageInput.innerHTML = '';
                }
            });
            adminGlobalFormattingToolbar.addEventListener('click', e => {
                const button = e.target.closest('.tool-button');
                if (!button) return;
                
                const command = button.dataset.command;
                if (['bold', 'italic', 'underline', 'strikethrough', 'shadow'].includes(command)) {
                    adminGlobalStyles[command] = !adminGlobalStyles[command];
                    button.classList.toggle('active', adminGlobalStyles[command]);
                } else if (button.id === 'admin-fontSizePlusBtn') {
                    if (adminGlobalFontSize < 24) {
                        adminGlobalFontSize += 2;
                        adminGlobalMessageInput.style.fontSize = `${adminGlobalFontSize}px`;
                    }
                } else if (button.id === 'admin-fontSizeMinusBtn') {
                    if (adminGlobalFontSize > 12) {
                        adminGlobalFontSize -= 2;
                        adminGlobalMessageInput.style.fontSize = `${adminGlobalFontSize}px`;
                    }
                } else if (button.id === 'admin-highlightBtn') {
                    adminHighlightPicker.click();
                } else if (button.id === 'admin-colorBtn') {
                    adminColorPicker.click();
                }
            });
            adminColorPicker.addEventListener('input', e => { adminGlobalStyles.color = e.target.value; });
            adminHighlightPicker.addEventListener('input', e => { adminGlobalStyles.highlight = e.target.value; });
            adminGlobalSoundSelect.addEventListener('change', (e) => {
                adminGlobalSound = e.target.value;
            });
            feather.replace();
        });
        adminPanelModal.addEventListener('click', e => { if(e.target === adminPanelModal) adminPanelModal.style.display = 'none'; });
        adminUserSearchBtn.addEventListener('click', searchUserByName);
        adminRoomSearchBtn.addEventListener('click', searchRoomContents);
        roomLockBtn.addEventListener('click', toggleRoomLock);
        chatIcon.addEventListener("click",()=>chatWindow.classList.toggle('open'));
        backToChatBtn.addEventListener("click",()=>changeRoom('0'));
        roomsBtn.addEventListener("click", () => roomsModal.style.display = 'flex');
        roomsModal.addEventListener('click', e => { if(e.target === roomsModal) roomsModal.style.display = 'none'; });
        joinRoomBtn.addEventListener('click', () => {
            changeRoom(roomNumberInput.value);
            roomsModal.style.display = 'none';
            roomNumberInput.value = '';
        });
        inviteUserBtn.addEventListener('click', () => inviteModal.style.display = 'flex');
        inviteModal.addEventListener('click', e => { if(e.target === inviteModal) inviteModal.style.display = 'none'; });
        sendBtn.addEventListener("click",sendMessage);
        messageInput.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}});
        
        chatScreen.addEventListener('click', e => {
            const messageElement = e.target.closest('.chat-message');
            if (messageElement) {
                const messageId = messageElement.id;
                reactionPopup.style.display = 'flex';
                const reactionOptionsHtml = availableReactions.map(r => `<button class="reaction-button" data-message-id="${messageId}" data-reaction="${r.id}"><i data-feather="${r.id}"></i></button>`).join('');
                reactionPopup.querySelector('.reaction-options').innerHTML = reactionOptionsHtml;
                reactionPopup.querySelector('.post-actions-buttons').innerHTML = `
                    
                    <button class="action-button edit-post" data-message-id="${messageId}" title="Edit"><i data-feather="edit-2"></i></button>
                    <button class="action-button delete-post" data-message-id="${messageId}" title="Delete"><i data-feather="trash-2"></i></button>
                `;
                feather.replace();
            } else if (e.target.classList.contains('invite-accept-btn')) {
                const roomToJoin = e.target.getAttribute('data-room');
                changeRoom(roomToJoin);
            }
        });
        
        reactionPopup.addEventListener('click', e => {
            const button = e.target.closest('button');
            if (button) {
                const messageId = button.dataset.messageId;
                const messageElement = document.getElementById(messageId);
                const messageContent = messageElement ? messageElement.querySelector('div:nth-child(2)').innerHTML : '';
                if (button.classList.contains('reaction-button')) {
                    const reaction = button.dataset.reaction;
                    socket.emit('react to message', { messageId, reaction });
                }  else if (button.classList.contains('edit-post')) {
                    const messageContentDiv = messageElement.querySelector('div:nth-child(2)');
                    messageInput.innerHTML = messageContentDiv.innerHTML;
                    isEditing = true;
                    messageToEditId = messageId;
                    sendBtn.innerHTML = '<i data-feather="check"></i>';
                    messageInput.focus();
                } else if (button.classList.contains('delete-post')) {
                    if (confirm("Are you sure you want to delete this message?")) {
                        socket.emit('delete message', messageId);
                    }
                }
                 reactionPopup.style.display = 'none';
            }
        });
        function updateReactionsDisplay(messageId, reactions) {
            const reactionsWrapper = document.getElementById(messageId).querySelector('.reactions-display');
            reactionsWrapper.innerHTML = '';
            for (const reaction in reactions) {
                const count = reactions[reaction];
                if (count > 0) {
                    const reactionSpan = document.createElement('span');
                    reactionSpan.className = 'reaction-count';
                    reactionSpan.innerHTML = `<i data-feather="${reaction}"></i>${count}`;
                    reactionsWrapper.appendChild(reactionSpan);
                }
            }
            feather.replace();
        }
        
        // Formatting events
        toggleFormattingBtn.addEventListener('click', () => { formattingPopup.classList.toggle('open'); });
        
        formattingPopup.addEventListener('click', e => {
            const button = e.target.closest('.tool-button');
            if (button && button.dataset.command) {
                const command = button.dataset.command;
                activeStyles[command] = !activeStyles[command];
                button.classList.toggle('active', activeStyles[command]);
            }
        });
        fontSelect.addEventListener('change', e => { activeStyles.fontFamily = e.target.value; });
        colorBtn.addEventListener('click', () => { colorPicker.click(); });
        colorPicker.addEventListener('input', e => { activeStyles.color = e.target.value; });
        fontSizePlusBtn.addEventListener('click', () => {
            if (activeFontSize < 24) {
                activeFontSize += 2;
                messageInput.style.fontSize = `${activeFontSize}px`;
            }
        });
        fontSizeMinusBtn.addEventListener('click', () => {
            if (activeFontSize > 12) {
                activeFontSize -= 2;
                messageInput.style.fontSize = `${activeFontSize}px`;
            }
        });
        highlightBtn.addEventListener('click', () => { highlightPicker.click(); });
        highlightPicker.addEventListener('input', e => { activeStyles.highlight = e.target.value; });
        mentionBtn.addEventListener('click', () => {
            const usernameToMention = prompt("Enter the username you want to mention:");
            if (usernameToMention) {
                messageInput.textContent = `@${usernameToMention} `;
                messageInput.focus();
            }
        });
        attachFileBtn.addEventListener('click', () => {
            fileUpload.click();
        });
        fileUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    socket.emit('file upload', { name: file.name, type: file.type, data: e.target.result });
                };
                reader.readAsDataURL(file);
            }
        });
        
        socket.on('file uploaded', (file) => {
             const img = `<img src="${file.data}" style="max-width: 100%; max-height: 200px; display: block; margin-top: 10px; cursor: pointer;" onclick="window.open(this.src)" />`;
             createMessageElement({ content: img, username: file.username, isAdmin: file.isAdmin, timestamp: file.timestamp });
             displaySystemMessage(`Image "${file.name}" sent.`);
        });

        emojiBtn.addEventListener('click', () => {
            emojiModal.style.display = 'flex';
            
            const emojiCategoryMap = {
                'ðŸ˜€': 'Smileys & Emotion',
                'ðŸ¶': 'Animals & Nature',
                'ðŸ”': 'Food & Drink',
                'ðŸš—': 'Activities & Travel',
                'ðŸ’¡': 'Objects & Symbols',
                'ðŸ‡§ðŸ‡·': 'Flags'
            };
            let emojiHtml = `<div class="emoji-category-tabs">`;
            for (const emojiKey in emojis) {
                emojiHtml += `<button data-category-key="${emojiKey}">${emojiKey}</button>`;
            }
            emojiHtml += `</div>`;
            emojiHtml += `<div id="emoji-list-content" class="emoji-picker-container"></div>`;
            emojiPicker.innerHTML = emojiHtml;
            
            const emojiListContent = document.getElementById('emoji-list-content');
            let initialCategoryKey = 'ðŸ˜€'; 
            
            const renderEmojis = (categoryKey) => {
                const categoryEmojis = emojis[categoryKey];
                emojiListContent.innerHTML = categoryEmojis.map(emoji => `<button class="emoji-button">${emoji}</button>`).join('');
            };
            
            renderEmojis(initialCategoryKey);
            const categoryTabs = document.querySelector('.emoji-category-tabs');
            categoryTabs.addEventListener('click', e => {
                const button = e.target.closest('button');
                if (button) {
                    const categoryKey = button.dataset.category-key;
                    renderEmojis(categoryKey);
                }
            });
        });
        emojiPicker.addEventListener('click', e => {
            const button = e.target.closest('.emoji-button');
            if (button) {
                messageInput.textContent += button.textContent;
                emojiModal.style.display = 'none';
                messageInput.focus();
            }
        });
        
        saveChatBtn.addEventListener('click', () => {
            const element = document.getElementById('chatScreen');
            const opt = {
                margin: 1,
                filename: `chat-sala-${currentRoom}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().from(element).set(opt).save();
        });
        
        // --- Online Users and Alarm Functions ---
        usersOnlineBtn.addEventListener('click', () => {
            usersOnlineModal.style.display = 'flex';
            socket.emit('request users online');
        });

        socket.on('users online list', (users) => {
            const usersInCurrentRoom = Object.entries(users).filter(([user, room]) => room === currentRoom).map(([user]) => user);
            let usersHtml = '<h3>Users in Room:</h3>';
            if (usersInCurrentRoom.length > 0) {
                usersHtml += `<ul>${usersInCurrentRoom.map(user => `<li>${user}</li>`).join('')}</ul>`;
            } else {
                usersHtml += '<p>No other users in this room.</p>';
            }
            usersListDiv.innerHTML = usersHtml;
        });

        alarmBtn.addEventListener('click', () => {
            if (!userAlarmCounts[currentUser]) {
                userAlarmCounts[currentUser] = 0;
            }
            if (userAlarmCounts[currentUser] >= 3) {
                alert('You can only call for attention 3 times per hour. Please wait to try again.');
                return;
            }
            alarmModal.style.display = 'flex';
            const usersInRoom = Object.entries(simulatedServerState.users).filter(([user, room]) => room === currentRoom).map(([user]) => user);
            const userListHtml = usersInRoom.map(user => `<button data-user="${user}">${user}</button>`).join('');
            alarmOptionsDiv.innerHTML = `<h3>Call Attention: (${userAlarmCounts[currentUser]}/3)</h3><button data-user="all">All in Room</button>${userListHtml}`;
        });
        
        alarmOptionsDiv.addEventListener('click', e => {
            const button = e.target.closest('button');
            if (button) {
                const user = button.dataset.user;
                if (!userAlarmCounts[currentUser]) {
                    userAlarmCounts[currentUser] = 0;
                }
                userAlarmCounts[currentUser]++;
                
                if (user === 'all') {
                    socket.emit('alarm', { type: 'all', room: currentRoom });
                } else {
                    socket.emit('alarm', { type: 'user', user, room: currentRoom });
                }
                alarmModal.style.display = 'none';
            }
        });
        
        // Audio and Window control events
        audioToggleBtn.addEventListener('click', () => {
            isAudioEnabled = !isAudioEnabled;
            const icon = audioToggleBtn.querySelector('i');
            icon.setAttribute('data-feather', isAudioEnabled ? 'volume-2' : 'volume-x');
            feather.replace();
        });
        minimizeChatBtn.addEventListener('click', () => {
            chatWindow.classList.add('minimized');
            chatWindow.classList.remove('maximized');
            maximizeChatBtn.style.display = 'flex';
            restoreChatBtn.style.display = 'none';
            minimizeChatBtn.style.display = 'none';
        });
        
        maximizeChatBtn.addEventListener('click', () => {
            chatWindow.classList.add('maximized');
            chatWindow.classList.remove('minimized');
            maximizeChatBtn.style.display = 'none';
            restoreChatBtn.style.display = 'flex';
            minimizeChatBtn.style.display = 'flex';
        });
        restoreChatBtn.addEventListener('click', () => {
            chatWindow.classList.remove('maximized');
            chatWindow.classList.remove('minimized');
            restoreChatBtn.style.display = 'none';
            maximizeChatBtn.style.display = 'flex';
            minimizeChatBtn.style.display = 'flex';
        });
        colorPaletteBtn.addEventListener('click', () => {
            chatWallpaperColor.click();
        });
        chatWallpaperColor.addEventListener('input', (e) => {
            chatScreen.style.backgroundColor = e.target.value;
        });
        
        // New WebRTC related events
        audioCallBtn.addEventListener('click', () => {
            if (isAudioCallActive) {
                socket.emit('end call');
                endAudioCall();
                audioCallModal.style.display = 'none';
            } else {
                audioCallModal.style.display = 'flex';
                socket.emit('request users online');
            }
        });

        socket.on('users online for call', (users) => {
             const usersHtml = Object.entries(users)
                .filter(([user, room]) => room === currentRoom && user !== currentUser)
                .map(([user]) => `<button data-user="${user}">${user}</button>`)
                .join('');

            audioCallUsersList.innerHTML = `
                <h3>Start a Call:</h3>
                <button data-user="all">Call Room</button>
                ${usersHtml}
            `;
        });

        audioCallUsersList.addEventListener('click', (e) => {
            const userToCall = e.target.closest('button').dataset.user;
            if (userToCall === 'all') {
                // Notifica o servidor para iniciar uma chamada de grupo
                socket.emit('start group call', { room: currentRoom });
            } else {
                // Notifica o servidor para iniciar uma chamada individual
                socket.emit('start peer call', { to: userToCall });
            }
            audioCallModal.style.display = 'none';
        });

        // --- Initialization ---
        googleFonts.forEach(fontName=>{const option=document.createElement('option');option.value=fontName;option.textContent=fontName;option.style.fontFamily=fontName;fontSelect.appendChild(option);});
        
        feather.replace();
        showScreen('loginScreen');
    });
    </script>
</body>
</html>
