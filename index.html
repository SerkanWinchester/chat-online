<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Chat Flutuante</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
    <button id="openChatBtn">💬</button>

    <div id="authPopup" class="popup">
    <div class="popup-header">
      <span>Login / Cadastro</span>
      <div class="popup-controls">
        <button id="minimizeAuth">—</button>
        <button id="closeAuth">✖</button>
      </div>
    </div>
    <div class="popup-body">
      <input type="text" id="username" placeholder="Usuário">
      <input type="password" id="password" placeholder="Senha">
      <input type="password" id="confirmPassword" placeholder="Confirmar Senha">
      <button id="registerBtn">Cadastrar</button>
      <button id="loginBtn">Login</button>
    </div>
  </div>

    <div id="chatWindow" class="chat">
    <div class="chat-header">
      <span>Chat Flutuante</span>
      <div class="chat-controls">
        <button id="settingsBtn">⚙️</button>
        <button id="minimizeChat">—</button>
        <button id="logoutBtn">⎋</button>
      </div>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <div class="chat-input">
      <textarea id="chatInput" placeholder="Digite sua mensagem..."></textarea>
      <button id="sendBtn">Enviar</button>
    </div>
  </div>

    <div id="settingsPopup" class="popup">
    <div class="popup-header">
      <span>Configurações</span>
      <button id="closeSettings">✖</button>
    </div>
    <div class="popup-body">
      <label>Papel de parede:</label>
      <input type="color" id="bgColorPicker">
      <input type="file" id="bgUpload" accept="image/*">
      <select id="bgPreset">
        <option value="">Escolher...</option>
        <option value="https://xatframe.github.io/xatframes/RobFerrari_Balloons.html">Balloons</option>
        <option value="https://xatframe.github.io/xatframes/lafleur_sea.html">Sea</option>
        <option value="https://xatframe.github.io/xatframes/robferrari_xneon.html">Neon</option>
      </select>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Conexão com o servidor do Render
    const socket = io('https://meu-chat-lin7.onrender.com');

    // Elementos do DOM
    const openChatBtn = document.getElementById('openChatBtn');
    const authPopup = document.getElementById('authPopup');
    const chatWindow = document.getElementById('chatWindow');
    const settingsPopup = document.getElementById('settingsPopup');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const settingsBtn = document.getElementById('settingsBtn');

    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const minimizeAuthBtn = document.getElementById('minimizeAuth');
    const closeAuthBtn = document.getElementById('closeAuth');
    const minimizeChatBtn = document.getElementById('minimizeChat');

    const bgColorPicker = document.getElementById('bgColorPicker');
    const bgUpload = document.getElementById('bgUpload');
    const bgPreset = document.getElementById('bgPreset');
    const closeSettingsBtn = document.getElementById('closeSettings');

    // Variáveis de estado
    let currentUser = null;

    // Funções de UI
    function toggleWindow(element) {
      element.style.display = (element.style.display === 'flex') ? 'none' : 'flex';
    }

    function closeWindow(element) {
      element.style.display = 'none';
    }

    function minimizeWindow(element) {
      element.style.display = 'none';
    }

    function showAuth() {
      closeWindow(chatWindow);
      toggleWindow(authPopup);
    }

    function showChat() {
      closeWindow(authPopup);
      toggleWindow(chatWindow);
    }

    function showSettings() {
      toggleWindow(settingsPopup);
    }

    function setBgColor() {
      document.body.style.backgroundColor = bgColorPicker.value;
      document.body.style.backgroundImage = 'none';
    }

    function setBgImage(url) {
      document.body.style.backgroundImage = `url('${url}')`;
    }

    // Registro
    registerBtn.addEventListener('click', async () => {
      const username = usernameInput.value;
      const password = passwordInput.value;
      const confirmPassword = confirmPasswordInput.value;

      if (!username || !password || !confirmPassword) {
        alert('Preencha todos os campos!');
        return;
      }
      if (password !== confirmPassword) {
        alert('As senhas não coincidem!');
        return;
      }

      const response = await fetch('https://meu-chat-lin7.onrender.com/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });

      const data = await response.json();
      alert(data.message);
    });

    // Login
    loginBtn.addEventListener('click', async () => {
      const username = usernameInput.value;
      const password = passwordInput.value;

      const response = await fetch('https://meu-chat-lin7.onrender.com/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });

      const data = await response.json();
      if (data.success) {
        currentUser = username;
        alert(data.message);
        showChat();
        socket.emit('user connected', { name: currentUser, color: '#FFFFFF' });
      } else {
        alert(data.message);
      }
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
      currentUser = null;
      socket.disconnect();
      location.reload();
    });

    // Mensagens
    sendBtn.addEventListener('click', () => {
      const message = chatInput.value.trim();
      if (message && currentUser) {
        socket.emit('chat message', { user: currentUser, text: message });
        chatInput.value = '';
      }
    });

    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Lógica de arrastar janelas
    function makeDraggable(element, header) {
      let isDragging = false;
      let offsetX, offsetY;

      header.addEventListener('mousedown', (e) => {
        isDragging = true;
        offsetX = e.clientX - element.getBoundingClientRect().left;
        offsetY = e.clientY - element.getBoundingClientRect().top;
        element.style.cursor = 'grabbing';
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        element.style.left = `${e.clientX - offsetX}px`;
        element.style.top = `${e.clientY - offsetY}px`;
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
        element.style.cursor = 'grab';
      });
    }

    // Event Listeners
    openChatBtn.addEventListener('click', showAuth);
    minimizeAuthBtn.addEventListener('click', () => minimizeWindow(authPopup));
    closeAuthBtn.addEventListener('click', () => closeWindow(authPopup));
    settingsBtn.addEventListener('click', showSettings);
    minimizeChatBtn.addEventListener('click', () => minimizeWindow(chatWindow));
    closeSettingsBtn.addEventListener('click', () => closeWindow(settingsPopup));
    
    bgColorPicker.addEventListener('input', setBgColor);
    bgPreset.addEventListener('change', (e) => {
      if (e.target.value) {
        setBgImage(e.target.value);
      }
    });

    // Inicialização
    document.addEventListener('DOMContentLoaded', () => {
      makeDraggable(authPopup, authPopup.querySelector('.popup-header'));
      makeDraggable(chatWindow, chatWindow.querySelector('.chat-header'));
      makeDraggable(settingsPopup, settingsPopup.querySelector('.popup-header'));
    });

    // Recebe mensagens do servidor
    socket.on('chat message', (msg) => {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'chat-message';
      messageDiv.textContent = `${msg.user}: ${msg.text}`;
      chatMessages.appendChild(messageDiv);
      scrollToBottom();
    });
  </script>
</body>
</html>
