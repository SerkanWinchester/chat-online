<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat Perfeito ‚Äî Cyber</title>

  <!-- Emoji picker com milhares de emojis -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>

  <style>
    :root {
      --bg:#0d0d14;
      --panel:#0f0f18;
      --panel2:#141422;
      --chip:#1f1f32;
      --text:#eaeaff;
      --brand1:#00f; /* azul */
      --brand2:#9b4dff; /* roxo */
      --brand3:#ff3dbb; /* pink */
    }
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body {
      margin:0; background:var(--bg) fixed center/cover;
      color:var(--text); font-family: Inter, Arial, system-ui, sans-serif;
    }

    /* Neon gradient border + brilho */
    .neon {
      border: 3px solid transparent;
      border-radius: 16px;
      background:
        linear-gradient(var(--panel2), var(--panel2)) padding-box,
        linear-gradient(135deg, var(--brand1), var(--brand2), var(--brand3)) border-box;
      box-shadow:
        0 0 12px rgba(0,0,255,.45),
        0 0 18px rgba(155,77,255,.35),
        0 0 26px rgba(255,61,187,.25);
      animation: pulseGlow 6s ease-in-out infinite;
    }
    @keyframes pulseGlow {
      0%,100% { box-shadow:
        0 0 10px rgba(0,0,255,.35),
        0 0 16px rgba(155,77,255,.28),
        0 0 22px rgba(255,61,187,.18); }
      50% { box-shadow:
        0 0 18px rgba(0,0,255,.55),
        0 0 28px rgba(155,77,255,.45),
        0 0 40px rgba(255,61,187,.35); }
    }

    header {
      display:flex; align-items:center; gap:10px; justify-content:center;
      padding:12px; background:rgba(10,10,18,.8); position:sticky; top:0; z-index:5;
      border-bottom:1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(8px);
    }
    header .title { font-weight:800; letter-spacing:.4px; text-transform:uppercase; }
    header .spacer { flex:1; }
    header button {
      background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.18);
      border-radius:10px; padding:6px 10px; cursor:pointer;
    }
    header button:hover { border-color: rgba(255,255,255,.35); }

    #app {
      max-width: 1100px; margin:16px auto; padding:14px;
    }

    #layout {
      display:grid; grid-template-columns: 300px 1fr; gap:14px;
    }

    /* Sidebar */
    .sidebar { padding:12px; background:var(--panel); }
    .sidebar h3 { margin:0 0 10px 0; font-size:14px; opacity:.85; }
    .user-item {
      display:flex; align-items:center; justify-content:space-between;
      background:var(--chip); margin:6px 0; padding:8px; border-radius:10px;
    }
    .user-name { font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 160px; }
    .user-actions button {
      border:none; background:transparent; color:var(--text); cursor:pointer; margin-left:6px;
      padding:6px; border-radius:8px;
    }
    .user-actions button:hover { background:rgba(255,255,255,.08); }

    /* Chat */
    .chat-wrap { display:flex; flex-direction:column; padding:0; overflow:hidden; }
    .chat-header {
      display:flex; gap:8px; align-items:center; justify-content:space-between;
      padding:10px 12px; background:var(--panel); border-bottom:1px solid rgba(255,255,255,.06);
      border-top-left-radius:14px; border-top-right-radius:14px;
    }
    .chat-body {
      height: 58vh; overflow-y:auto; padding:14px; background:var(--panel2);
    }
    .msg {
      margin:6px 0; padding:8px 10px; background:var(--chip); border-radius:10px; word-break:break-word;
    }
    .self { background:rgba(0,128,255,.16); }

    .chat-input {
      display:flex; gap:8px; padding:10px; background:var(--panel); border-top:1px solid rgba(255,255,255,.06);
      border-bottom-left-radius:14px; border-bottom-right-radius:14px;
    }
    .chat-input input[type="text"] {
      padding:10px; border:none; border-radius:10px; background:#10101a; color:var(--text);
    }
    #username { width:22ch; }
    #message  { flex:1; }
    .primary {
      border:none; border-radius:10px; padding:10px 14px; cursor:pointer; color:#fff;
      background: linear-gradient(135deg, var(--brand1), var(--brand2), var(--brand3));
    }
    .primary:disabled { filter: grayscale(1) brightness(.6); cursor:not-allowed; }

    /* Pain√©is flutuantes */
    .panel {
      background:var(--panel);
      border-radius:12px; border:1px solid rgba(255,255,255,.08);
      position:absolute; right:16px; top:62px; width:min(92vw, 360px); max-height:65vh; overflow:auto;
      display:none; z-index:10;
    }
    .panel header { position:sticky; top:0; justify-content:space-between; }
    .panel .content { padding:12px; }

    /* Private windows */
    .private-window {
      position:fixed; bottom:16px; right:16px; width: min(420px, 92vw);
      background: var(--panel); z-index:20; overflow:hidden;
    }
    .private-header {
      display:flex; align-items:center; justify-content:space-between;
      padding:10px; background:rgba(10,10,18,.85);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .private-body { height: 38vh; overflow-y:auto; padding:10px; background:var(--panel2); }
    .private-input { display:flex; gap:8px; padding:10px; background:var(--panel); border-top:1px solid rgba(255,255,255,.06); }
    .chip { font-size:12px; opacity:.8; }

    /* Fundo custom */
    .wallpaper-row { display:flex; gap:8px; align-items:center; }
    .wallpaper-row input { flex:1; }
  </style>
</head>
<body>
  <div id="app" class="neon">
    <header class="neon" style="border-radius:12px; margin-bottom:12px;">
      <span class="title">Chat Perfeito ‚Äî Cyber üòé</span>
      <div class="spacer"></div>
      <button id="btn-emoji" title="Emojis">üòä</button>
      <button id="btn-settings" title="Configura√ß√µes">‚öôÔ∏è</button>
    </header>

    <div id="layout">
      <!-- Sidebar -->
      <aside class="sidebar neon" id="sidebar">
        <h3>Amigos Online</h3>
        <div id="users"></div>
      </aside>

      <!-- Chat principal -->
      <section class="chat-wrap neon" id="chat">
        <div class="chat-header">
          <div>
            <strong>Canal P√∫blico</strong>
            <div class="chip" id="youChip"></div>
          </div>
          <div class="chip">Neon ON</div>
        </div>
        <div class="chat-body" id="messages" aria-live="polite"></div>
        <div class="chat-input">
          <input id="username" type="text" placeholder="Seu nome..." autocomplete="username" />
          <input id="message"  type="text" placeholder="Digite uma mensagem..." disabled />
          <button id="send" class="primary" disabled>Enviar üí¨</button>
        </div>
      </section>
    </div>

    <!-- Painel: Emojis -->
    <div id="emoji-panel" class="panel neon">
      <header>
        <span>Emojis</span>
        <button id="close-emoji">‚úñ</button>
      </header>
      <div class="content">
        <emoji-picker id="emojiPicker" class="dark"></emoji-picker>
      </div>
    </div>

    <!-- Painel: Configura√ß√µes -->
    <div id="settings-panel" class="panel neon">
      <header>
        <span>Configura√ß√µes</span>
        <button id="close-settings">‚úñ</button>
      </header>
      <div class="content">
        <div class="wallpaper-row">
          <label for="wallUrl">Papel de parede (URL):</label>
          <input id="wallUrl" type="text" placeholder="https://imagem.png" />
          <button id="applyWall" class="primary">Aplicar</button>
        </div>
        <div style="margin-top:8px;">
          <label><input id="enterToSend" type="checkbox" checked /> Enter envia</label>
        </div>
        <div style="margin-top:8px;">
          <button id="resetWall">Restaurar fundo padr√£o</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Socket.IO (Render) -->
  <script>
    // >>> AJUSTE AQUI SE TROCAR A URL <<<
    const SERVER_URL = "https://meu-chat-lin7.onrender.com";
  </script>
  <script src="https://meu-chat-lin7.onrender.com/socket.io/socket.io.js"></script>

  <script type="module">
    // ====== Estado ======
    const state = {
      me: { id: null, name: null },
      users: [],           // {id, name}
      blocked: new Set(),  // ids bloqueados (espelhado do server)
      privates: new Map()  // Map<userId, {el, bodyEl, inputEl}>
    };

    // ====== DOM ======
    const usersBox   = document.getElementById("users");
    const messagesEl = document.getElementById("messages");
    const usernameEl = document.getElementById("username");
    const messageEl  = document.getElementById("message");
    const sendBtn    = document.getElementById("send");
    const youChip    = document.getElementById("youChip");

    const emojiPanel = document.getElementById("emoji-panel");
    const settingsPanel = document.getElementById("settings-panel");
    const btnEmoji   = document.getElementById("btn-emoji");
    const btnSettings= document.getElementById("btn-settings");
    const closeEmoji = document.getElementById("close-emoji");
    const closeSettings = document.getElementById("close-settings");

    const wallUrl = document.getElementById("wallUrl");
    const applyWall = document.getElementById("applyWall");
    const resetWall = document.getElementById("resetWall");
    const enterToSend = document.getElementById("enterToSend");

    // ====== Socket ======
    const socket = io(SERVER_URL, { transports:["websocket","polling"] });

    // pega meu id quando conectar
    socket.on("connect", () => {
      state.me.id = socket.id;
      refreshYou();
      socket.emit("getBlocked");
    });

    // lista de usu√°rios online
    socket.on("onlineUsers", (list) => {
      state.users = list.filter(u => u.id !== state.me.id);
      renderUsers();
    });

    // bloqueados
    socket.on("blockedUsers", (arr) => {
      state.blocked = new Set(arr || []);
      renderUsers();
    });

    // mensagens p√∫blicas
    socket.on("chatMessage", (data) => {
      // se o remetente est√° bloqueado localmente, ignora
      if (state.blocked.has(data.from)) return;
      const p = document.createElement("div");
      p.className = "msg" + (data.from === state.me.id ? " self" : "");
      p.textContent = `${data.user}: ${data.msg}`;
      messagesEl.appendChild(p);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });

    // mensagens privadas
    socket.on("privateMessage", (data) => {
      const partnerId = data.from === state.me.id ? data.to : data.from;
      const partnerName = data.from === state.me.id ? getNameById(data.to) : data.fromName;
      const win = ensurePrivateWindow(partnerId, partnerName);
      appendPrivate(win, data.from === state.me.id, data.msg);
    });

    // ====== UI principal ======
    usernameEl.addEventListener("input", () => {
      const ok = usernameEl.value.trim().length > 0;
      messageEl.disabled = !ok;
      sendBtn.disabled = !ok;
    });

    // registra nome quando confirma com Enter ou foca no campo de msg
    usernameEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && usernameEl.value.trim()) {
        doRegister();
        messageEl.focus();
      }
    });
    messageEl.addEventListener("focus", () => { if (usernameEl.value.trim()) doRegister(); });

    function doRegister() {
      if (state.me.name === usernameEl.value.trim()) return;
      state.me.name = usernameEl.value.trim().slice(0, 40);
      youChip.textContent = `Voc√™: ${state.me.name}`;
      socket.emit("register", { name: state.me.name });
    }

    sendBtn.addEventListener("click", sendPublic);
    messageEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && enterToSend.checked) {
        e.preventDefault(); sendPublic();
      }
    });

    function sendPublic() {
      const msg = messageEl.value.trim();
      if (!state.me.name || !msg) return;
      socket.emit("chatMessage", { msg });
      messageEl.value = "";
    }

    function refreshYou() {
      youChip.textContent = state.me.name ? `Voc√™: ${state.me.name}` : `ID: ${state.me.id?.slice(0,5) ?? ""}`;
    }

    // ====== Sidebar ======
    function renderUsers() {
      usersBox.innerHTML = "";
      state.users.forEach(u => {
        const row = document.createElement("div");
        row.className = "user-item neon";
        row.style.borderRadius = "10px";

        const left = document.createElement("div");
        left.className = "user-name";
        left.textContent = u.name || u.id;

        const actions = document.createElement("div");
        actions.className = "user-actions";
        const btnPm = document.createElement("button");
        btnPm.title = "Chat privado";
        btnPm.textContent = "üí¨";
        btnPm.addEventListener("click", () => openPrivate(u.id, u.name));

        const blocked = state.blocked.has(u.id);
        const btnBlock = document.createElement("button");
        btnBlock.title = blocked ? "Desbloquear" : "Bloquear";
        btnBlock.textContent = blocked ? "‚úÖ" : "üö´";
        btnBlock.addEventListener("click", () => toggleBlock(u.id));

        actions.append(btnPm, btnBlock);
        row.append(left, actions);
        usersBox.appendChild(row);
      });
    }

    function toggleBlock(targetId) {
      if (state.blocked.has(targetId)) {
        socket.emit("unblockUser", { targetId });
      } else {
        socket.emit("blockUser", { targetId });
      }
      // server vai responder com "blockedUsers"
    }

    // ====== Privado ======
    function getNameById(id) {
      if (id === state.me.id) return state.me.name || "Voc√™";
      const u = state.users.find(x => x.id === id);
      return u?.name || id;
    }

    function openPrivate(id, name) {
      const win = ensurePrivateWindow(id, name);
      win.input.focus();
    }

    function ensurePrivateWindow(partnerId, partnerName) {
      if (state.privates.has(partnerId)) return state.privates.get(partnerId);

      const wrap = document.createElement("div");
      wrap.className = "private-window neon";
      wrap.style.borderRadius = "14px";

      // header
      const header = document.createElement("div");
      header.className = "private-header";
      const title = document.createElement("div");
      title.innerHTML = `<strong>Privado</strong><div class="chip">${partnerName}</div>`;
      const actions = document.createElement("div");
      const close = document.createElement("button");
      close.textContent = "‚úñ";
      close.addEventListener("click", () => {
        wrap.remove();
        state.privates.delete(partnerId);
      });
      actions.appendChild(close);
      header.append(title, actions);

      // body
      const body = document.createElement("div");
      body.className = "private-body";

      // input
      const inputRow = document.createElement("div");
      inputRow.className = "private-input";
      const input = document.createElement("input");
      input.type = "text"; input.placeholder = "Mensagem privada...";
      const send = document.createElement("button");
      send.className = "primary";
      send.textContent = "Enviar";
      send.addEventListener("click", () => sendPrivate(partnerId, input, body));
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && enterToSend.checked) sendPrivate(partnerId, input, body);
      });
      inputRow.append(input, send);

      wrap.append(header, body, inputRow);
      document.body.appendChild(wrap);
      state.privates.set(partnerId, { el: wrap, bodyEl: body, input, partnerName });

      // empilha janelas se abrir v√°rias
      positionPrivateWindows();
      return state.privates.get(partnerId);
    }

    function positionPrivateWindows() {
      const wins = Array.from(state.privates.values());
      wins.forEach((w, i) => {
        w.el.style.right = (16 + i * 24) + "px";
        w.el.style.bottom = (16 + i * 24) + "px";
      });
    }

    function appendPrivate(win, fromSelf, msg) {
      const p = document.createElement("div");
      p.className = "msg" + (fromSelf ? " self" : "");
      p.textContent = (fromSelf ? "Voc√™: " : `${win.partnerName}: `) + msg;
      win.bodyEl.appendChild(p);
      win.bodyEl.scrollTop = win.bodyEl.scrollHeight;
    }

    function sendPrivate(partnerId, input, body) {
      const txt = (input.value || "").trim();
      if (!txt) return;
      if (state.blocked.has(partnerId)) {
        alert("Voc√™ bloqueou este usu√°rio. Desbloqueie para enviar mensagens.");
        return;
      }
      socket.emit("privateMessage", { to: partnerId, msg: txt });
      input.value = "";
    }

    // ====== Emojis ======
    const picker = document.getElementById("emojiPicker");
    picker.addEventListener("emoji-click", (e) => {
      const emoji = e.detail.unicode;
      const start = messageEl.selectionStart ?? messageEl.value.length;
      const end   = messageEl.selectionEnd   ?? messageEl.value.length;
      messageEl.value = messageEl.value.slice(0,start) + emoji + messageEl.value.slice(end);
      messageEl.focus();
      messageEl.setSelectionRange(start + emoji.length, start + emoji.length);
    });

    // abrir/fechar pain√©is
    const toggle = (el) => { el.style.display = (el.style.display === "block") ? "none" : "block"; };
    document.getElementById("btn-emoji").addEventListener("click", () => { settingsPanel.style.display="none"; toggle(emojiPanel); });
    document.getElementById("btn-settings").addEventListener("click", () => { emojiPanel.style.display="none"; toggle(settingsPanel); });
    document.getElementById("close-emoji").addEventListener("click", () => emojiPanel.style.display="none");
    document.getElementById("close-settings").addEventListener("click", () => settingsPanel.style.display="none");
    document.addEventListener("click", (e) => {
      const inside = e.target.closest(".panel") || e.target.closest("header");
      if (!inside) { emojiPanel.style.display="none"; settingsPanel.style.display="none"; }
    });

    // ====== Papel de parede ======
    // carrega salvo
    const savedWall = localStorage.getItem("wallpaperUrl");
    if (savedWall) document.body.style.backgroundImage = `url("${savedWall}")`;
    wallUrl.value = savedWall || "";

    applyWall.addEventListener("click", () => {
      const url = wallUrl.value.trim();
      if (!url) return;
      document.body.style.backgroundImage = `url("${url}")`;
      localStorage.setItem("wallpaperUrl", url);
    });
    resetWall.addEventListener("click", () => {
      localStorage.removeItem("wallpaperUrl");
      document.body.style.backgroundImage = "";
    });
  </script>
</body>
</html>
