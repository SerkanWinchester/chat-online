<!doctype html>
<html>
<head>
    <title>Chat Flutuante - Versão Completa</title>
<style>
    /* Estilos do seu chat, copiados do seu arquivo style.css */
    :root {
        --main-bg-color: #f0f0f0; 
        --main-text-color: #000000;
        --header-bg-color: #dcdcdc;
        --header-text-color: #000000;
        --bubble-bg-color: rgba(255, 255, 255, 0.85);
        --bubble-text-color: #000000;
        --input-bg-color: #ffffff;
        --input-text-color: #000000;
        --button-bg-color: #e0e0e0;
        --button-active-bg-color: #007bff;
    }
    body { font-family: Arial, sans-serif; background-image: url('https://source.unsplash.com/random/1920x1080?abstract,gradient'); background-size: cover; }
    #chat-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
    #chat-icon { width: 60px; height: 60px; background-color: #ffffff; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.3s; animation: neon-glow 1.5s infinite alternate, pulse 1.5s infinite; }
    #chat-icon:hover { transform: scale(1.1); }
    #chat-icon img { width: 40px; height: 40px; filter: drop-shadow(0 0 3px rgba(0,0,0,0.3)); }
    @keyframes neon-glow { 0% { box-shadow: 0 0 3px #fff, 0 0 7px #8a2be2; } 33% { box-shadow: 0 0 3px #fff, 0 0 7px #007bff; } 66% { box-shadow: 0 0 3px #fff, 0 0 7px #ff1493; } 100% { box-shadow: 0 0 3px #fff, 0 0 7px #8a2be2; } }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    #chat-window { width: 580px; height: 470px; position: fixed; bottom: 90px; right: 20px; background-color: var(--main-bg-color); border: 1px solid #ccc; border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); overflow: hidden; display: none; flex-direction: column; transition: all 0.5s ease; transform-origin: bottom right; }
    #chat-window.show { display: flex; }
    #chat-window.maximized { width: 98vw; height: 98vh; bottom: 1vw; right: 1vh; border-radius: 0; }
    .chat-header { background-color: var(--header-bg-color); color: var(--header-text-color); padding: 10px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; flex-shrink: 0; border-bottom: 1px solid #ccc; }
    .header-left, .header-right { display: flex; align-items: center; gap: 5px; }
    .chat-header h3 { margin: 0; flex-grow: 1; text-align: center; }
    .header-controls button { background: none; border: none; cursor: pointer; padding: 5px; }
    .header-controls button svg { fill: var(--header-text-color); width: 20px; height: 20px; transition: fill 0.3s; }
    .header-controls button:hover svg { fill: #007bff; }
    .logout-link { color: var(--header-text-color); font-size: 14px; text-decoration: none; margin-right: 10px; cursor: pointer; transition: color 0.3s; }
    .logout-link:hover { color: #007bff; }
    .screen { flex-grow: 1; display: none; flex-direction: column; height: 100%; box-sizing: border-box; color: var(--main-text-color); background-color: var(--main-bg-color); }
    .screen.active { display: flex; }
    .login-screen, .register-screen { padding: 20px; text-align: center; justify-content: center; align-items: center; }
    .chat-screen, .settings-screen { padding: 0; }
    .login-screen input, .register-screen input { width: 80%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px; background: var(--input-bg-color); color: var(--input-text-color); }
    .login-screen button, .register-screen button { width: 80%; padding: 10px; margin: 5px 0; background-color: #333; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .login-screen h3, .login-screen p, .login-screen label, .login-screen .switch-link { color: var(--main-text-color); }
    .chat-body { flex-grow: 1; padding: 10px; overflow-y: auto; text-align: left; color: var(--main-text-color); background-color: var(--main-bg-color); }
    .chat-footer { position: relative; flex-shrink: 0; display: flex; flex-wrap: wrap; align-items: center; padding: 8px; border-top: 1px solid #ccc; background: var(--header-bg-color); gap: 5px; }
    .message-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 8px 12px; background-color: var(--input-bg-color); color: var(--input-text-color); }
    .message-bubble { background: var(--bubble-bg-color); color: var(--bubble-text-color); border-radius: 12px; border: 1px solid #dcdcdc; padding: 10px; margin-bottom: 25px; max-width: 85%; word-wrap: break-word; position: relative; }
    .message-bubble strong { color: #0056b3; }
    .reaction-buttons { position: absolute; top: -15px; right: 10px; display: flex; gap: 5px; background: #fff; border-radius: 10px; padding: 2px 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.2s; z-index: 2; }
    .message-bubble:hover .reaction-buttons { opacity: 1; }
    .reaction-buttons button { background: none; border: none; cursor: pointer; font-size: 16px; padding: 0; }
    .reaction-counters { position: absolute; bottom: -20px; left: 10px; display: flex; gap: 6px; }
    .reaction-counters span { background-color: #e0e0e0; padding: 2px 6px; border-radius: 10px; font-size: 12px; display: flex; align-items: center; gap: 3px; }
    .system-message { color: #777; font-style: italic; text-align: center; margin: 10px 0; font-size: 0.9em; width: 100%;}
    #private-chats-container { position: fixed; bottom: 20px; right: 610px; z-index: 1001; display: flex; flex-direction: column-reverse; align-items: flex-end; gap: 5px; }
    .private-chat-window { width: 350px; background-color: var(--main-bg-color); border: 1px solid #ccc; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: flex; flex-direction: column; transition: height 0.3s ease; overflow: hidden; }
    .private-chat-window:not(.minimized) { height: 400px; }
    .private-chat-window.minimized { height: 42px; cursor: pointer; }
    .private-chat-window.minimized .chat-body, .private-chat-window.minimized .chat-footer { display: none; }
    .private-chat-header { background-color: var(--header-bg-color); color: var(--header-text-color); padding: 10px; display: flex; justify-content: space-between; align-items: center; border-radius: 9px 9px 0 0; flex-shrink: 0; }
    .private-chat-header-buttons { display: flex; align-items: center; gap: 8px; }
    .private-chat-header-buttons button { background: none; border: none; cursor: pointer; padding: 0; color: var(--header-text-color); display: flex; align-items: center; }
    .private-chat-header-buttons svg { fill: var(--header-text-color); }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }
    #private-user-list-modal { display:none; background-color: white !important; border: 1px solid #ccc; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); border-radius: 8px;}
    #private-user-list-modal p, #private-user-list-modal li { color: black; }
    #private-user-list-modal li { padding: 5px; cursor: pointer; border-radius: 4px; }
    #private-user-list-modal li:hover { background-color: #f0f0f0; }
    .settings-screen { background-color: var(--main-bg-color); color: var(--main-text-color); }
    .settings-screen .settings-container { display: flex; flex-direction: column; gap: 20px; }
    .settings-screen h4 { margin-top: 0; margin-bottom: 10px; color: #007bff; border-bottom: 1px solid #ddd; padding-bottom: 5px;}
    .setting-item { display: flex; flex-direction: column; gap: 8px; }
    .setting-item label { display: flex; align-items: center; gap: 8px; }
    #font-size-preview { background: #e9e9e9; padding: 10px; border-radius: 5px; margin-top: 5px; }
</style>
</head>
<body>

<div id="chat-container">
    <div id="chat-icon"><img src="https://cdn-icons-png.flaticon.com/512/134/134914.png" alt="Ícone de Chat" /></div>
    <div id="chat-window">
        <div class="screen login-screen active">
            <h3>Login</h3><p>Entre com seu @username.</p>
            <input type="text" id="login-username" placeholder="@username" />
            <button id="login-btn">Entrar</button>
        </div>
        
        <div class="screen settings-screen">
            <div class="chat-header">
                <div class="header-left"><button id="back-to-chat-btn"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/></path></svg></button></div>
                <h3>Configurações</h3>
            </div>
            <div style="padding: 20px; text-align: left; overflow-y: auto;">
                <div class="settings-container">
                     <div class="setting-item">
                        <h4>Cor de Fundo Customizada</h4>
                        <label>Escolha uma cor: <input type="color" id="bg-color-picker" value="#f0f0f0" /></label>
                        <button id="apply-bg-color-btn" style="width: auto; padding: 5px 10px;">Aplicar Cor</button>
                        <button id="remove-bg-color-btn" style="width: auto; padding: 5px 10px;">Restaurar Padrão</button>
                    </div>
                    <div class="setting-item">
                        <h4>Ajustes de Mensagem</h4>
                        <label>Cor de Fundo: <input type="color" id="bubble-bg-color-picker" value="#FFFFFF" /></label>
                        <label>Transparência: <input type="range" id="bubble-opacity-slider" min="0" max="100" value="85" /> <span id="bubble-opacity-value">85%</span></label>
                        <label>Cor do Texto: <input type="color" id="bubble-text-color-picker" value="#000000" /></label>
                        <button id="apply-message-styles-btn" style="width: auto; padding: 5px 10px;">Aplicar Estilos</button>
                    </div>
                    <div class="setting-item">
                        <h4>Tamanho da Fonte</h4>
                        <input type="range" id="font-size-slider" min="10" max="22" value="14" />
                        <div id="font-size-preview" style="font-size: 14px;">Este é um exemplo de texto para você ver o tamanho.</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="screen chat-screen">
            <div class="chat-header">
                <div class="header-left">
                    <span id="my-username"></span>
                </div>
                <h3>Chat Geral</h3>
                <div class="header-right header-controls">
                    <button id="private-chat-btn" title="Chat Privado">🔒</button>
                    <button id="sound-toggle-btn" title="Silenciar notificações">🔔</button>
                    <button id="minimize-btn" title="Minimizar"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M19 13H5v-2h14v2z"/></path></svg></button>
                    <button id="maximize-btn" title="Maximizar"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M3 3h18v18H3V3zm16 16V5H5v14h14z"/></path></svg></button>
                    <button id="settings-btn" title="Configurações"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.09-.75-1.7-.92L15 2H9l-.31 2.5c-.61-.17-1.18-.52-1.7-.92l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.12.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19-.15-.24-.42-.12-.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.09.75 1.7.92L9 22h6l.31-2.5c.61-.17 1.18-.52-1.7-.92l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"/></path></svg></button>
                    <a href="#" id="logout-btn" class="logout-link">Logout</a>
                </div>
            </div>
            <div id="main-chat-body" class="chat-body"><div class="system-message">Bem-vindo ao chat!</div></div>
            <div id="main-chat-footer" class="chat-footer">
                <span id="typing-indicator">Digitando...</span>
            </div>
            <div id="private-user-list-modal" style="display:none;"><p><strong>Iniciar chat privado com:</strong></p><ul id="private-user-list"></ul></div>
        </div>
    </div>
</div>

<div id="private-chats-container"></div>

<audio id="notification-sound" src="https://www.myinstants.com/media/sounds/blip_1.mp3" preload="auto"></audio>
<audio id="nudge-sound" src="https://soundjay.com/misc/sounds/knocking-on-door-1.mp3" preload="auto"></audio>
<audio id="like-sound" src="https://www.myinstants.com/media/sounds/ok-sound-effect.mp3" preload="auto"></audio>
<audio id="laugh-sound" src="https://www.myinstants.com/media/sounds/rindo-alto-mp3.mp3" preload="auto"></audio>
<audio id="love-sound" src="https://soundjay.com/misc/sounds/magic-chime-01.mp3" preload="auto"></audio>
<audio id="angry-sound" src="https://soundjay.com/misc/sounds/fail-buzzer-01.mp3" preload="auto"></audio>
<audio id="clap-sound" src="https://www.myinstants.com/media/sounds/aplausos-efecto-de-sonido.mp3" preload="auto"></audio>
<audio id="sad-sound" src="https://www.myinstants.com/media/sounds/sad-violin.mp3" preload="auto"></audio>
<audio id="wow-sound" src="https://www.myinstants.com/media/sounds/wow-sound-effect.mp3" preload="auto"></audio>
<audio id="thinking-sound" src="https://www.myinstants.com/media/sounds/hm-thinking-sound-effect.mp3" preload="auto"></audio>

<script src="/socket.io/socket.io.js"></script>

<script>
    // Conexão com o Servidor
    const socket = io();

    document.addEventListener('DOMContentLoaded', () => {
        // --- ESTADO GLOBAL DO CLIENTE ---
        let currentUser = null; 
        let isSoundMuted = false;
        let friends = [];
        let openPrivateChats = {};
        let chatSettings = {
            bgColor: '', fontSize: '14px',
            messageStyles: { bubbleBgColor: '#FFFFFF', bubbleOpacity: 85, textColor: '#000000' }
        };

        const reactions = [
            { id: 'like', emoji: '👍', soundId: 'like-sound' }, { id: 'laugh', emoji: '😂', soundId: 'laugh-sound' },
            { id: 'love', emoji: '❤️', soundId: 'love-sound' }, { id: 'angry', emoji: '😠', soundId: 'angry-sound' },
            { id: 'clap', emoji: '👏', soundId: 'clap-sound' }, { id: 'sad', emoji: '😢', soundId: 'sad-sound' },
            { id: 'wow', emoji: '😮', soundId: 'wow-sound' }, { id: 'thinking', emoji: '🤔', soundId: 'thinking-sound' },
        ];

        // --- REFERÊNCIAS AO DOM ---
        const chatIcon = document.getElementById('chat-icon');
        const chatWindow = document.getElementById('chat-window');
        const mainChatBody = document.getElementById('main-chat-body');
        const mainChatFooter = document.getElementById('main-chat-footer');
        const privateChatsContainer = document.getElementById('private-chats-container');
        const loginScreen = document.querySelector('.login-screen');
        const chatScreen = document.querySelector('.chat-screen');
        const settingsScreen = document.querySelector('.settings-screen');
        const soundToggleBtn = document.getElementById('sound-toggle-btn');
        const loginBtn = document.getElementById('login-btn');
        const myUsernameDisplay = document.getElementById('my-username');
        const privateChatBtn = document.getElementById('private-chat-btn');
        const privateUserListModal = document.getElementById('private-user-list-modal');
        const settingsBtn = document.getElementById('settings-btn');
        const backToChatBtn = document.getElementById('back-to-chat-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const applyBgColorBtn = document.getElementById('apply-bg-color-btn');
        const removeBgColorBtn = document.getElementById('remove-bg-color-btn');
        const bubbleBgColorPicker = document.getElementById('bubble-bg-color-picker');
        const bubbleOpacitySlider = document.getElementById('bubble-opacity-slider');
        const bubbleTextColorPicker = document.getElementById('bubble-text-color-picker');
        const applyMessageStylesBtn = document.getElementById('apply-message-styles-btn');
        const fontSizeSlider = document.getElementById('font-size-slider');

        // --- FUNÇÕES AUXILIARES ---
        const playSound = (soundElement) => { 
            if (!isSoundMuted && soundElement) { 
                soundElement.currentTime = 0; 
                soundElement.play().catch(e => console.error("Erro ao tocar som:", e)); 
            } 
        };
        const showScreen = (screenToShow) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenToShow.classList.add('active');
        };
        
        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        function addMessageToChat(chatBody, data) {
            const messageId = data.id || `msg-${Date.now()}`;
            const messageBubble = document.createElement('div');
            messageBubble.className = 'message-bubble';
            messageBubble.id = messageId;
            messageBubble.innerHTML = `<strong>${data.user}:</strong> ${data.text}`;
            
            const reactionsContainer = document.createElement('div');
            reactionsContainer.className = 'reaction-buttons';
            const countersContainer = document.createElement('div');
            countersContainer.className = 'reaction-counters';
            messageBubble.appendChild(countersContainer);

            reactions.forEach(reaction => {
                const btn = document.createElement('button');
                btn.innerHTML = reaction.emoji;
                btn.title = reaction.id;
                btn.onclick = (e) => {
                    e.stopPropagation();
                    socket.emit('send_reaction', { messageId: messageId, reactionId: reaction.id });
                };
                reactionsContainer.appendChild(btn);
            });
            messageBubble.appendChild(reactionsContainer);
            chatBody.appendChild(messageBubble);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function addSystemMessage(chatBody, text) {
            const systemMessage = document.createElement('div');
            systemMessage.className = 'system-message';
            systemMessage.textContent = text;
            chatBody.appendChild(systemMessage);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function updateReactionCount(messageId, reactionId) {
            const messageBubble = document.getElementById(messageId);
            if (!messageBubble) return;
            playSound(document.getElementById(reactions.find(r => r.id === reactionId).soundId));
            let counts = JSON.parse(messageBubble.dataset.reactions || '{}');
            counts[reactionId] = (counts[reactionId] || 0) + 1;
            messageBubble.dataset.reactions = JSON.stringify(counts);
            const countersContainer = messageBubble.querySelector('.reaction-counters');
            if (!countersContainer) return;
            countersContainer.innerHTML = ''; 
            for (const id in counts) {
                if (counts[id] > 0) {
                    const reactionData = reactions.find(r => r.id === id);
                    if (reactionData) {
                        const counterSpan = document.createElement('span');
                        counterSpan.innerHTML = `${reactionData.emoji} ${counts[id]}`;
                        countersContainer.appendChild(counterSpan);
                    }
                }
            }
        }

        function initializeChatFooter(footerContainer, isPrivate = false, recipient = null) {
            footerContainer.innerHTML = `<input type="text" class="message-input" placeholder="Digite sua mensagem...">`;
            const messageInput = footerContainer.querySelector('.message-input');
            const sendMessage = () => {
                const messageText = messageInput.value.trim();
                if (messageText === '') return;
                if (isPrivate) {
                    socket.emit('send_private_message', { text: messageText, to: recipient, from: currentUser });
                } else {
                    socket.emit('send_message', { text: messageText, user: currentUser });
                }
                messageInput.value = '';
            };
            messageInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });
        }

        function createOrFocusPrivateChat(username) {
            if (openPrivateChats[username] && !openPrivateChats[username].isMinimized) {
                Object.values(openPrivateChats).forEach(c => c.windowEl.style.zIndex = '1001');
                openPrivateChats[username].windowEl.style.zIndex = '1002';
                return;
            }
            if (openPrivateChats[username] && openPrivateChats[username].isMinimized) {
                const chat = openPrivateChats[username];
                chat.windowEl.classList.remove('minimized');
                chat.isMinimized = false;
                Object.values(openPrivateChats).forEach(c => c.windowEl.style.zIndex = '1001');
                chat.windowEl.style.zIndex = '1002';
                return;
            }
            const windowEl = document.createElement('div');
            windowEl.className = 'private-chat-window';
            windowEl.dataset.user = username;
            windowEl.innerHTML = `
                <div class="private-chat-header"><span>Chat com ${username}</span><div class="private-chat-header-buttons">
                    <button class="private-call-btn" title="Ligar (recurso visual)">
                        <svg width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24c1.12.37 2.33.57 3.57.57c.55 0 1 .45 1 1V20c0 .55-.45 1-1 1c-9.39 0-17-7.61-17-17c0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1c0 1.25.2 2.45.57 3.57c.11.35.03.74-.25 1.02l-2.2 2.2z"/></path></svg>
                    </button>
                    <button class="private-nudge-btn" title="Puxão">Puxão</button>
                    <button class="private-minimize-btn" title="Minimizar"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M19,13H5V11H19V13Z" /></svg></button>
                    <button class="private-chat-close-btn" title="Fechar">&times;</button>
                </div></div>
                <div class="chat-body private-chat-messages"></div>
                <div class="chat-footer"></div>`;
            privateChatsContainer.appendChild(windowEl);
            initializeChatFooter(windowEl.querySelector('.chat-footer'), true, username);
            const chatState = { windowEl, isMinimized: false };
            openPrivateChats[username] = chatState;
            const callBtn = windowEl.querySelector('.private-call-btn');
            callBtn.onclick = (e) => {
                e.stopPropagation();
                alert("Função de chamada de voz/vídeo ainda não implementada. Isso requer uma infraestrutura de servidor complexa.");
            };
            const nudgeBtn = windowEl.querySelector('.private-nudge-btn');
            nudgeBtn.onclick = (e) => {
                e.stopPropagation();
                socket.emit('send_nudge', { to: username, from: currentUser });
            };
            windowEl.querySelector('.private-minimize-btn').onclick = (e) => { e.stopPropagation(); windowEl.classList.add('minimized'); chatState.isMinimized = true; };
            windowEl.querySelector('.private-chat-close-btn').onclick = (e) => { e.stopPropagation(); windowEl.remove(); delete openPrivateChats[username]; };
            windowEl.querySelector('.private-chat-header').onclick = () => { if (chatState.isMinimized) { windowEl.classList.remove('minimized'); chatState.isMinimized = false; }};
            createOrFocusPrivateChat(username);
        }

        // --- EVENT LISTENERS DO SOCKET.IO (Recebendo do Servidor) ---
        socket.on('message_received', (data) => {
            addMessageToChat(mainChatBody, data);
            playSound(document.getElementById('notification-sound'));
        });
        socket.on('private_message_received', (data) => {
            const partner = data.from === currentUser ? data.to : data.from;
            if (!openPrivateChats[partner]) {
                createOrFocusPrivateChat(partner);
            }
            const chatWindow = openPrivateChats[partner].windowEl;
            const chatBody = chatWindow.querySelector('.chat-body');
            addMessageToChat(chatBody, { user: data.from, text: data.text });
            playSound(document.getElementById('notification-sound'));
        });
        socket.on('system_message', (text) => {
            addSystemMessage(mainChatBody, text);
        });
        socket.on('update_user_list', (userList) => {
            friends = userList;
        });
        socket.on('reaction_received', (data) => {
            updateReactionCount(data.messageId, data.reactionId);
        });
        socket.on('nudge_received', (data) => {
            if(openPrivateChats[data.from]){
                const chatWindow = openPrivateChats[data.from].windowEl;
                chatWindow.classList.add('shake');
                setTimeout(() => chatWindow.classList.remove('shake'), 820);
                playSound(document.getElementById('nudge-sound'));
            }
        });
        // --- EVENT LISTENERS DA PÁGINA ---
        chatIcon.addEventListener('click', () => chatWindow.classList.toggle('show'));
        soundToggleBtn.addEventListener('click', () => {
            isSoundMuted = !isSoundMuted;
            soundToggleBtn.innerHTML = isSoundMuted ? '🔇' : '🔔';
        });
        loginBtn.addEventListener('click', () => {
            const usernameInput = document.getElementById('login-username');
            const username = usernameInput.value.trim();
            if (username) { 
                currentUser = username; 
                myUsernameDisplay.textContent = currentUser; 
                socket.emit('user_joined', currentUser);
                showScreen(chatScreen); 
                usernameInput.value = '';
            }
        });
        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.reload(); 
        });
        settingsBtn.addEventListener('click', () => showScreen(settingsScreen));
        backToChatBtn.addEventListener('click', () => showScreen(chatScreen));
        privateChatBtn.addEventListener('click', () => {
            privateUserListModal.style.display = 'block';
            const userList = privateUserListModal.querySelector('ul');
            userList.innerHTML = '';
            friends.forEach(user => {
                if (user !== currentUser) {
                    const li = document.createElement('li');
                    li.textContent = user;
                    li.onclick = () => { createOrFocusPrivateChat(user); privateUserListModal.style.display = 'none'; };
                    userList.appendChild(li);
                }
            });
        });
        document.addEventListener('click', (e) => {
            if (!privateUserListModal.contains(e.target) && !privateChatBtn.contains(e.target)) {
                privateUserListModal.style.display = 'none';
            }
        });
        applyBgColorBtn.addEventListener('click', () => { 
            chatSettings.bgColor = document.getElementById('bg-color-picker').value; 
            const allChatBodies = document.querySelectorAll('.chat-body');
            allChatBodies.forEach(body => {
                body.style.backgroundColor = chatSettings.bgColor;
                body.style.backgroundImage = 'none';
            });
        });
        removeBgColorBtn.addEventListener('click', () => { 
            chatSettings.bgColor = ''; 
            const allChatBodies = document.querySelectorAll('.chat-body');
            allChatBodies.forEach(body => {
                body.style.backgroundColor = 'var(--main-bg-color)';
            });
        });
        applyMessageStylesBtn.addEventListener('click', () => {
            const root = document.documentElement;
            const hexToRgb = (hex) => { const r = parseInt(hex.substring(1, 3), 16); const g = parseInt(hex.substring(3, 5), 16); const b = parseInt(hex.substring(5, 7), 16); return `${r}, ${g}, ${b}`; };
            const opacity = parseInt(bubbleOpacitySlider.value) / 100;
            const rgbColor = hexToRgb(bubbleBgColorPicker.value);
            root.style.setProperty('--bubble-bg-color', `rgba(${rgbColor}, ${opacity})`);
            root.style.setProperty('--bubble-text-color', bubbleTextColorPicker.value);
        });
        fontSizeSlider.addEventListener('input', () => { 
            const newSize = `${fontSizeSlider.value}px`; 
            chatSettings.fontSize = newSize; 
            document.getElementById('font-size-preview').style.fontSize = newSize; 
            const allChatBodies = document.querySelectorAll('.chat-body');
            allChatBodies.forEach(body => body.style.fontSize = newSize);
        });
        // --- INICIALIZAÇÃO ---
        initializeChatFooter(mainChatFooter);
    });
</script>

</body>
</html>
