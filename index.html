<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Online</title>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Open+Sans&family=Lato&family=Montserrat&family=Oswald&family=Raleway&family=Poppins&family=Nunito&family=Playfair+Display&family=Merriweather&family=Indie+Flower&family=Dancing+Script&family=Pacifico&family=Lobster&family=Source+Code+Pro&family=Nunito+Sans&family=Inter&family=Work+Sans&family=Fira+Sans&family=Source+Sans+Pro&family=PT+Sans&family=Ubuntu&family=Lora&family=Quicksand&family=Comfortaa&family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&family=Bebas+Neue&family=Kanit&family=Permanent+Marker&family=Anton&family=Archivo+Black&family=Abril+Fatface&family=Josefin+Sans&family=Satisfy&family=Courgette&family=Noto+Sans&family=Dosis&family=Merriweather+Sans&family=Concert+One&family=Passion+One&family=Barlow&family=Caveat&family=Alfa+Slab+One&family=Exo+2&family=Secular+One&display=swap" rel="stylesheet" />
    <style>
        body { margin: 0; font-family: Arial, sans-serif; background: #f0f2f5; overflow: hidden; }

        #chatIcon { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: black; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 0 20px rgba(255,0,255,0.5), 0 0 20px rgba(0,255,255,0.5); z-index: 1000; }
        
        .chat-window { 
            position: fixed; 
            bottom: 90px; 
            right: 20px; 
            width: 590px; 
            height: 470px; 
            background: rgba(255, 255, 255, 0.2); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px);
            border-radius: 15px; 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: none; 
            flex-direction: column; 
            overflow: hidden; 
            z-index: 999; 
            opacity: 0; 
            transform: translateY(20px); 
            pointer-events: none; 
            transition: opacity 0.3s ease, transform 0.3s ease; 
        }
        .chat-window.open { display: flex; opacity: 1; transform: translateY(0); pointer-events: auto; }
        .chat-window.maximized { width: 100vw; height: 100vh; bottom: 0; right: 0; border-radius: 0; }
        .chat-window.minimized { height: 40px; }
        .chat-window.mobile-view { width: 100vw; height: 100vh; bottom: 0; right: 0; border-radius: 0; }


        .chat-header { 
            background: rgba(255, 255, 255, 0.3); 
            padding: 10px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.5); 
            position: relative; 
            min-height: 40px; 
        }
        .header-icons-left, .header-icons-right { display: flex; align-items: center; gap: 15px; }
        .chat-header h2 { margin: 0; font-size: 18px; color: #111; position: absolute; left: 50%; transform: translateX(-50%); white-space: nowrap; }

        .screen { display: none; flex: 1; padding: 20px; overflow-y: auto; flex-direction: column; justify-content: center; align-items: center; gap: 15px; }
        #chatScreen { justify-content: flex-start; align-items: stretch; }
        #chatScreen[style*="background-color"] { background-color: var(--chat-wallpaper-color, #fff); }


        .chat-message { 
            background-color: rgba(255, 255, 255, 0.4) !important; 
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 8px 12px; 
            border-radius: 18px; 
            margin-bottom: 8px; 
            max-width: 80%; 
            align-self: flex-start; 
            word-wrap: break-word; 
            position: relative; 
            cursor: pointer; 
        }
        .chat-message.my-message { align-self: flex-end; }
        .system-message { text-align: center; font-size: 12px; color: #888; margin: 8px 0; font-style: italic; }
        .admin-star { margin-right: 5px; color: #ffc107; }
        .room-lock-icon { margin-left: auto; color: #dc3545; }


        .invite-message { background-color: #e9f5ff; border-left: 4px solid #007bff; padding: 10px; margin: 10px 5%; border-radius: 4px; font-size: 14px; }
        .invite-message p { margin: 0 0 10px 0; }
        .invite-message button { background-color: #007bff; color: white; border: none; padding: 5px 10px; margin-right: 10px; border-radius: 4px; cursor: pointer; font-size: 12px; width: auto; }
        .invite-message button.decline { background-color: #ccc; color: #333; }
        
        .chat-footer { position: relative; background: #ffffff; padding: 8px 10px; display: flex; align-items: center; gap: 8px; border-top: 1px solid #e0e0e0; }
        .footer-toolbar { display: flex; align-items: center; gap: 4px; }
        .tool-button { background: transparent; border: none; padding: 4px; cursor: pointer; border-radius: 4px; color: black; display: flex; }
        .tool-button.active { background-color: #e0e0e0; }
        .tool-button i { width: 16px; height: 16px; }
        #font-select { border-radius: 4px; border: 1px solid #ccc; background: white; max-width: 100%; font-size: 12px; }
        
        input[type="text"]#usernameInput {
            background: rgba(0, 0, 0, 0.1);
            color: #000;
            border: none;
            outline: none;
            flex: 1;
            padding: 8px;
            border-radius: 8px;
        }

        #messageInput { flex: 1; border: 1px solid #ccc; padding: 8px; border-radius: 15px; color: #111; max-height: 80px; overflow-y: auto; background: white; }
        #sendBtn { background: transparent; border: none; padding: 4px; cursor: pointer; width: auto; color: black; display: flex; }
        #sendBtn i { width: 20px; height: 20px; }
        .emoji-button { font-size: 20px; border: none; background: none; cursor: pointer; }
        .emoji-picker-container { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; max-height: 150px; overflow-y: auto; padding: 5px; }
        .emoji-category-tabs { display: flex; justify-content: center; margin-bottom: 10px; }
        .emoji-category-tabs button { padding: 5px 10px; border: none; background: #eee; cursor: pointer; }


        #formatting-popup {
            position: absolute;
            bottom: calc(100% + 5px);
            left: 10px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px;
            display: none;
            flex-wrap: nowrap;
            gap: 4px;
            width: 95%;
            overflow-x: auto;
            border: 1px solid #ddd;
            z-index: 1003;
        }
        #formatting-popup.open { display: flex; }

        #reaction-popup, #emoji-modal { position: fixed; display: none; background: #fff; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.25); padding: 8px; z-index: 1001; top: 50%; left: 50%; transform: translate(-50%, -50%); flex-direction: column; }
        #emoji-modal .modal-content { padding: 0; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1002; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; max-width: 400px; width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column; align-items: center; }
        .modal-header { display: flex; justify-content: center; align-items: center; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 15px; width: 100%; }
        .modal-header h2 { margin: 0; font-size: 18px; }
        .screen.active { display: flex; }
        .form-group { display: flex; align-items: center; border-bottom: 1px solid #e0e0e0; padding: 5px; width: 90%; }
        input { border: none; outline: none; flex: 1; padding: 8px; background: transparent; }
        button { background: black; color: white; border: none; border-radius: 5px; padding: 10px; font-weight: bold; cursor: pointer; width: 90%; margin-top: 10px; }
        .header-button { background: none; border: none; padding: 0; cursor: pointer; color: #333; }
        .emoji-button {
            font-size: 24px;
            border: none;
            background: none;
            cursor: pointer;
            padding: 5px;
            flex-basis: calc(100% / 7);
            max-width: calc(100% / 7);
            box-sizing: border-box;
        }

        /* ADMIN PANEL STYLES */
        #admin-panel-modal .modal-content {
            overflow-y: auto;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
        }
        .admin-global-message-container {
            width: 100%;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        .admin-global-formatting-toolbar {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 4px;
            width: 100%;
            margin-bottom: 10px;
            padding: 5px 0;
            border-radius: 5px;
            background-color: #f1f1f1;
            align-items: center;
        }
        .admin-global-formatting-toolbar select {
            border-radius: 4px;
            border: 1px solid #ccc;
            background: white;
            max-width: 100%;
            font-size: 12px;
        }
        #adminGlobalMessage {
            flex: 1;
            border: 1px solid #ccc;
            border-radius: 15px;
            padding: 8px;
            min-height: 50px;
            max-height: 100px;
            overflow-y: auto;
        }
        .global-message {
            position: relative;
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 10px;
            font-weight: bold;
            color: white;
            background: linear-gradient(45deg, #007bff, #dc3545, #28a745);
            border: 2px solid;
            border-image: linear-gradient(45deg, #007bff, #dc3545, #28a745) 1;
        }

        /* OUTROS ESTILOS J√Å EXISTENTES */
        #admin-stats { margin-bottom: 20px; text-align: center; font-size: 14px; }
        #admin-room-list { margin-top: 15px; width: 90%; text-align: left; font-size: 14px; }
        #admin-room-list ul { list-style: none; padding: 0; margin: 0; }
        #admin-room-list li { margin-bottom: 5px; }
        .admin-search-group { display: flex; flex-direction: column; width: 90%; gap: 10px; margin-bottom: 20px; }
        .admin-search-group input { border: 1px solid #ccc; border-radius: 5px; }
        .admin-search-group button { margin-top: 0; }
        #admin-search-results { margin-top: 15px; width: 90%; text-align: center; font-size: 14px; min-height: 20px; }
        .reactions-display { 
            display: flex; 
            gap: 5px;
            flex-wrap: wrap; 
        }
        .reaction-count { display: flex; align-items: center; background-color: #f1f1f1; border-radius: 12px; padding: 2px 6px; font-size: 12px; }
        .reaction-count i { width: 12px; height: 12px; margin-right: 3px; }
        .highlighted { background-color: yellow; }
        #messageInput.font-size-small { font-size: 12px; }
        #messageInput.font-size-medium { font-size: 16px; }
        #messageInput.font-size-large { font-size: 20px; }
        .shake-animation {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>
<body>
    <div id="chatIcon"><i data-feather="message-square"></i></div>
    <audio id="messageSound" src="https://www.soundjay.com/buttons/button-10.mp3" preload="auto"></audio>
    <audio id="applauseSound" src="https://assets.mixkit.co/sfx/preview/mixkit-small-group-of-people-applauding-511.mp3" preload="auto"></audio>
    <audio id="screamSound" src="https://assets.mixkit.co/sfx/preview/mixkit-scream-of-a-man-in-fear-1279.mp3" preload="auto"></audio>
    <audio id="attentionSound" src="https://assets.mixkit.co/sfx/preview/mixkit-attention-bell-2759.mp3" preload="auto"></audio>
    <audio id="thumbsUpSound" src="https://www.soundjay.com/buttons/sounds/button-36.mp3" preload="auto"></audio>
    <audio id="heartSound" src="https://www.soundjay.com/buttons/sounds/button-18.mp3" preload="auto"></audio>
    <audio id="smileSound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>
    <audio id="starSound" src="https://www.soundjay.com/buttons/sounds/button-2.mp3" preload="auto"></audio>
    <audio id="frownSound" src="https://www.soundjay.com/buttons/sounds/button-37.mp3" preload="auto"></audio>
    <audio id="thumbsDownSound" src="https://www.soundjay.com/buttons/sounds/button-1.mp3" preload="auto"></audio>
    <audio id="helpCircleSound" src="https://www.soundjay.com/buttons/sounds/button-7.mp3" preload="auto"></audio>
    <audio id="checkCircleSound" src="https://www.soundjay.com/buttons/sounds/button-23.mp3" preload="auto"></audio>


    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <div class="header-icons-left">
                <button id="backToChatBtn" class="header-button"><i data-feather="arrow-left"></i></button>
                <button id="roomsBtn" class="header-button"><i data-feather="hash"></i></button>
                <button id="usersOnlineBtn" class="header-button" title="Online Users" style="display: none;"><i data-feather="users"></i></button>
                <button id="audioToggleBtn" class="header-button" title="Toggle Notifications" style="display: none;"><i data-feather="volume-2"></i></button>
                <button id="minimizeChatBtn" class="header-button" title="Minimize" style="display: none;"><i data-feather="minus"></i></button>
                <button id="maximizeChatBtn" class="header-button" title="Maximize" style="display: none;"><i data-feather="maximize-2"></i></button>
                <button id="restoreChatBtn" class="header-button" title="Restore" style="display: none;"><i data-feather="minimize-2"></i></button>
                <button id="mobileViewBtn" class="header-button" title="Mobile View" style="display: none;"><i data-feather="smartphone"></i></button>
            </div>
            <h2 id="screenTitle">Login</h2>
            <div class="header-icons-right">
                <button id="inviteUserBtn" class="header-button" title="Invite user" style="display: none;"><i data-feather="search"></i></button>
                <button id="adminPanelBtn" class="header-button" title="Admin Panel" style="display: none;"><i data-feather="star"></i></button>
                <button id="roomLockBtn" class="header-button" title="Lock/Unlock Room" style="display: none;"><i data-feather="unlock"></i></button>
                <button id="alarmBtn" class="header-button" title="Call attention" style="display: none;"><i data-feather="bell"></i></button>
                <button id="colorPaletteBtn" class="header-button" title="Change wallpaper color" style="display: none;"><i data-feather="droplet"></i></button>
                <input type="color" id="chatWallpaperColor" style="display: none;" />
                <button id="saveChatBtn" class="header-button" title="Save chat as PDF" style="display: none;"><i data-feather="save"></i></button>
                <button id="logoutBtn" class="header-button"><i data-feather="power"></i></button>
            </div>
        </div>
        <div class="screen active" id="loginScreen"><div class="form-group"><i data-feather="user"></i><input type="text" id="usernameInput" placeholder="Create username" /></div><button id="loginBtn">Enter</button></div>
        <div class="screen" id="chatScreen"></div>
        <div class="chat-footer" id="chatFooter">
            <div id="formatting-popup">
                <button class="tool-button" data-command="bold" title="Bold"><i data-feather="bold"></i></button>
                <button class="tool-button" data-command="italic" title="Italic"><i data-feather="italic"></i></button>
                <button class="tool-button" data-command="underline" title="Underline"><i data-feather="underline"></i></button>
                <button class="tool-button" data-command="strikethrough" title="Strikethrough"><i data-feather="minus"></i></button>
                <button class="tool-button" data-command="shadow" title="Shadow"><i data-feather="type"></i></button>
                <select id="font-select" title="Text Font"></select>
                <button class="tool-button" id="fontSizePlusBtn" title="Increase Font"><i data-feather="plus-circle"></i></button>
                <button class="tool-button" id="fontSizeMinusBtn" title="Decrease Font"><i data-feather="minus-circle"></i></button>
                <button class="tool-button" id="highlightBtn" title="Highlight Text"><i data-feather="pen-tool"></i></button>
                <input type="color" id="highlightPicker" style="display: none;" />
                <button class="tool-button" id="colorBtn" title="Text Color"><i data-feather="edit-3"></i></button>
                <input type="color" id="colorPicker" style="display: none;" />
            </div>
            <div class="footer-toolbar">
                <button class="tool-button" id="toggleFormattingBtn" title="Format Text"><i data-feather="plus"></i></button>
                <button class="tool-button" id="mentionBtn" title="Mention/Reply"><i data-feather="at-sign"></i></button>
                <button id="attachFileBtn" class="tool-button" title="Attach file"><i data-feather="paperclip"></i></button>
                <input type="file" id="fileUpload" accept="image/*" style="display: none;" />
                <button id="emojiBtn" class="tool-button" title="Emojis"><span class="material-symbols-outlined">sentiment_satisfied</span></button>
            </div>
            <div id="messageInput" contenteditable="true" spellcheck="false"></div>
            <button id="sendBtn" title="Send message"><i data-feather="send"></i></button>
        </div>
    </div>
    
    <div id="reaction-popup" class="modal-content">
        <div class="reaction-options">
            <button class="reaction-button" data-message-id="" data-reaction="thumbs-up"><i data-feather="thumbs-up"></i></button>
            <button class="reaction-button" data-message-id="" data-reaction="heart"><i data-feather="heart"></i></button>
            <button class="reaction-button" data-message-id="" data-reaction="smile"><i data-feather="smile"></i></button>
            <button class="reaction-button" data-message-id="" data-reaction="star"><i data-feather="star"></i></button>
            <button class="reaction-button" data-message-id="" data-reaction="frown"><i data-feather="frown"></i></button>
            <button class="reaction-button" data-message-id="" data-reaction="thumbs-down"><i data-feather="thumbs-down"></i></button>
            <button class="reaction-button" data-message-id="" data-reaction="help-circle"><i data-feather="help-circle"></i></button>
            <button class="reaction-button" data-message-id="" data-reaction="check-circle"><i data-feather="check-circle"></i></button>
        </div>
        <div class="post-actions-buttons">
            
             <button class="action-button edit-post" title="Edit"><i data-feather="edit-2"></i></button>
             <button class="action-button delete-post" data-message-id="${messageId}" title="Delete"><i data-feather="trash-2"></i></button>
        </div>
    </div>
    <div class="modal-overlay" id="emoji-modal"><div class="modal-content"><div class="modal-header"><h2>Choose Emoji</h2></div><div id="emoji-picker"></div></div></div>
    <div class="modal-overlay" id="rooms-modal"><div class="modal-content"><div class="modal-header"><h2>Change Room</h2></div><div class="form-group"><i data-feather="hash"></i><input type="number" id="roomNumberInput" placeholder="Room number (0 = General)" min="0" /></div><button id="joinRoomBtn">Join Room</button></div></div>
    <div class="modal-overlay" id="users-online-modal"><div class="modal-content"><div class="modal-header"><h2>Online Users</h2></div><div id="users-list"></div></div></div>
    <div class="modal-overlay" id="alarm-modal"><div class="modal-content"><div class="modal-header"><h2>Call Attention</h2></div><div id="alarm-options"></div></div></div>
    <div class="modal-overlay" id="invite-modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Invite User</h2></div>
            <div class="form-group">
                <i data-feather="user"></i>
                <input type="text" id="usernameToInviteInput" placeholder="Username" />
            </div>
            <button id="sendInviteBtn">Invite</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="admin-panel-modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Admin Panel</h2></div>
            <div id="admin-stats"></div>
            <div class="admin-search-group">
                <input type="text" id="adminUserInput" placeholder="Search by user" />
                <button id="adminUserSearchBtn">Search User</button>
            </div>
            <div class="admin-search-group">
                <input type="number" id="adminRoomInput" placeholder="Search by room #" min="0" />
                <button id="adminRoomSearchBtn">Search Room</button>
            </div>
            <div id="admin-room-list"></div>
            <div class="admin-icon-toggles">
                <label><input type="checkbox" id="toggleRoomsBtn" checked /> Rooms</label>
                <label><input type="checkbox" id="toggleUsersOnlineBtn" checked /> Users Online</label>
                <label><input type="checkbox" id="toggleAudioToggleBtn" checked /> Audio</label>
                <label><input type="checkbox" id="toggleMinimizeChatBtn" checked /> Minimize</label>
                <label><input type="checkbox" id="toggleMaximizeChatBtn" checked /> Maximize</label>
                <label><input type="checkbox" id="toggleInviteUserBtn" checked /> Invite User</label>
                <label><input type="checkbox" id="toggleAdminPanelBtn" checked /> Admin Panel</label>
                <label><input type="checkbox" id="toggleRoomLockBtn" checked /> Room Lock</label>
                <label><input type="checkbox" id="toggleAlarmBtn" checked /> Alarm</label>
                <label><input type="checkbox" id="toggleColorPaletteBtn" checked /> Color Palette</label>
                <label><input type="checkbox" id="toggleSaveChatBtn" checked /> Save Chat</label>
                <label><input type="checkbox" id="toggleLogoutBtn" checked /> Logout</label>
                <label><input type="checkbox" id="toggleFormattingBtn" checked /> Formatting</label>
                <label><input type="checkbox" id="toggleMentionBtn" checked /> Mention</label>
                <label><input type="checkbox" id="toggleAttachFileBtn" checked /> Attach File</label>
                <label><input type="checkbox" id="toggleEmojiBtn" checked /> Emoji</label>
                <label><input type="checkbox" id="toggleSendBtn" checked /> Send Button</label>
            </div>
            <div id="admin-search-results"></div>
            <h3>Room Control</h3>
            <div id="admin-room-users"></div>
            <div class="admin-global-message-container">
                <h3>Global Announcement</h3>
                <div id="adminGlobalMessage" contenteditable="true" spellcheck="false" placeholder="Write global message..."></div>
                <div class="admin-global-formatting-toolbar">
                    <button class="tool-button" data-command="bold" title="Bold"><i data-feather="bold"></i></button>
                    <button class="tool-button" data-command="italic" title="Italic"><i data-feather="italic"></i></button>
                    <button class="tool-button" data-command="underline" title="Underline"><i data-feather="underline"></i></button>
                    <button class="tool-button" data-command="strikethrough" title="Strikethrough"><i data-feather="minus"></i></button>
                    <button class="tool-button" data-command="shadow" title="Shadow"><i data-feather="type"></i></button>
                    <button class="tool-button" id="admin-fontSizePlusBtn" title="Increase Font"><i data-feather="plus-circle"></i></button>
                    <button class="tool-button" id="admin-fontSizeMinusBtn" title="Decrease Font"><i data-feather="minus-circle"></i></button>
                    <button class="tool-button" id="admin-highlightBtn" title="Highlight Text"><i data-feather="pen-tool"></i></button>
                    <input type="color" id="admin-highlightPicker" style="display: none;" />
                    <button class="tool-button" id="admin-colorBtn" title="Text Color"><i data-feather="edit-3"></i></button>
                    <input type="color" id="admin-colorPicker" style="display: none;" />
                    <div id="admin-global-sound-selector" style="display: flex; align-items: center; gap: 5px;">
                        <i data-feather="music"></i>
                        <select id="admin-global-sound-select">
                            <option value="none" />None
                            <option value="screamSound" />Scream
                            <option value="applauseSound" />Applause
                            <option value="attentionSound" />Attention
                        </select>
                    </div>
                </div>
                <button id="sendGlobalMessageBtn" style="margin-top: 10px;">Send Global Message</button>
            </div>
        </div>
    </div>

    <script src="https://meu-chat-lin7.onrender.com/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io('https://meu-chat-lin7.onrender.com');

            const chatWindow = document.getElementById('chatWindow');
            const toggleFormattingBtn = document.getElementById('toggleFormattingBtn');
            const formattingPopup = document.getElementById('formatting-popup');
            const roomsBtn = document.getElementById('roomsBtn');
            const roomsModal = document.getElementById('rooms-modal');
            const roomNumberInput = document.getElementById('roomNumberInput');
            const joinRoomBtn = document.getElementById('joinRoomBtn');
            const inviteUserBtn = document.getElementById('inviteUserBtn');
            const inviteModal = document.getElementById('invite-modal');
            const usernameToInviteInput = document.getElementById('usernameToInviteInput');
            const sendInviteBtn = document.getElementById('sendInviteBtn');
            const chatIcon=document.getElementById('chatIcon'),chatScreen=document.getElementById('chatScreen'),screenTitle=document.getElementById('screenTitle'),logoutBtn=document.getElementById('logoutBtn'),backToChatBtn=document.getElementById('backToChatBtn'),messageInput=document.getElementById('messageInput'),sendBtn=document.getElementById('sendBtn'),attachFileBtn=document.getElementById('attachFileBtn'),fileUpload=document.getElementById('fileUpload'),saveChatBtn=document.getElementById('saveChatBtn'),fontSelect=document.getElementById('font-select'),colorBtn=document.getElementById('colorBtn'),colorPicker=document.getElementById('colorPicker'),usernameInput=document.getElementById('usernameInput'),loginBtn=document.getElementById('loginBtn'),reactionPopup=document.getElementById('reaction-popup'),mentionBtn=document.getElementById('mentionBtn');
            
            const adminPanelBtn = document.getElementById('adminPanelBtn');
            const adminPanelModal = document.getElementById('admin-panel-modal');
            const adminStatsDiv = document.getElementById('admin-stats');
            const adminUserInput = document.getElementById('adminUserInput');
            const adminUserSearchBtn = document.getElementById('adminUserSearchBtn');
            const adminRoomInput = document.getElementById('adminRoomInput');
            const adminRoomSearchBtn = document.getElementById('adminRoomSearchBtn');
            const adminSearchResults = document.getElementById('admin-search-results');
            const adminRoomList = document.getElementById('admin-room-list');
            const roomLockBtn = document.getElementById('roomLockBtn');
            const usersOnlineBtn = document.getElementById('usersOnlineBtn');
            const usersOnlineModal = document.getElementById('users-online-modal');
            const usersListDiv = document.getElementById('users-list');
            const alarmBtn = document.getElementById('alarmBtn');
            const alarmModal = document.getElementById('alarm-modal');
            const alarmOptionsDiv = document.getElementById('alarm-options');
            const fontSizePlusBtn = document.getElementById('fontSizePlusBtn');
            const fontSizeMinusBtn = document.getElementById('fontSizeMinusBtn');
            const highlightBtn = document.getElementById('highlightBtn');
            const highlightPicker = document.getElementById('highlightPicker');
            const adminRoomUsersDiv = document.getElementById('admin-room-users');
            const emojiBtn = document.getElementById('emojiBtn');
            const emojiModal = document.getElementById('emoji-modal');
            const emojiPicker = document.getElementById('emoji-picker');
            const audioToggleBtn = document.getElementById('audioToggleBtn');
            const minimizeChatBtn = document.getElementById('minimizeChatBtn');
            const maximizeChatBtn = document.getElementById('maximizeChatBtn');
            const restoreChatBtn = document.getElementById('restoreChatBtn');
            const mobileViewBtn = document.getElementById('mobileViewBtn');
            const colorPaletteBtn = document.getElementById('colorPaletteBtn');
            const chatWallpaperColor = document.getElementById('chatWallpaperColor');
            const toggleRoomsBtn = document.getElementById('toggleRoomsBtn');
            const toggleUsersOnlineBtn = document.getElementById('toggleUsersOnlineBtn');
            const toggleAudioToggleBtn = document.getElementById('toggleAudioToggleBtn');
            const toggleMinimizeChatBtn = document.getElementById('toggleMinimizeChatBtn');
            const toggleMaximizeChatBtn = document.getElementById('toggleMaximizeChatBtn');
            const toggleInviteUserBtn = document.getElementById('toggleInviteUserBtn');
            const toggleAdminPanelBtn = document.getElementById('toggleAdminPanelBtn');
            const toggleRoomLockBtn = document.getElementById('toggleRoomLockBtn');
            const toggleAlarmBtn = document.getElementById('toggleAlarmBtn');
            const toggleColorPaletteBtn = document.getElementById('toggleColorPaletteBtn');
            const toggleSaveChatBtn = document.getElementById('toggleSaveChatBtn');
            const toggleLogoutBtn = document.getElementById('toggleLogoutBtn');
            const toggleFormattingBtnAdmin = document.getElementById('toggleFormattingBtn');
            const toggleMentionBtn = document.getElementById('toggleMentionBtn');
            const toggleAttachFileBtn = document.getElementById('toggleAttachFileBtn');
            const toggleEmojiBtn = document.getElementById('toggleEmojiBtn');
            const toggleSendBtn = document.getElementById('toggleSendBtn');
            
            let currentRoom = 0;
            let currentUser = "Guest", isAudioEnabled = true, messageIdCounter = 0;
            let activeStyles = { bold: false, italic: false, underline: false, strikethrough: false, shadow: false, color: '#000000', fontFamily: 'Roboto', highlight: '' };
            let activeFontSize = 16;
            let adminGlobalStyles = { bold: false, italic: false, underline: false, strikethrough: false, shadow: false, color: '#000000', fontFamily: 'Roboto', highlight: '' };
            let adminGlobalFontSize = 16;
            let adminGlobalSound = 'none';
            let isEditing = false;
            let messageToEditId = null;

            let onlineUsers = {};
            let roomLocks = {};
            let allMessages = {};

            const googleFonts = ['Roboto','Open Sans','Lato','Montserrat','Oswald','Raleway','Poppins','Nunito','Playfair Display','Merriweather','Indie Flower','Dancing Script','Pacifico','Lobster','Source Code Pro','Nunito Sans','Inter','Work Sans','Fira Sans','Source Sans Pro','PT Sans','Ubuntu','Lora','Quicksand','Comfortaa', 'Bebas Neue', 'Kanit', 'Permanent Marker', 'Anton', 'Archivo Black', 'Abril Fatface', 'Josefin Sans', 'Satisfy', 'Courgette', 'Noto Sans', 'Dosis', 'Merriweather Sans', 'Concert One', 'Passion One', 'Barlow', 'Caveat', 'Alfa Slab One', 'Exo 2', 'Secular One'];
            const availableReactions = [{type:'icon',id:'thumbs-up',label:'Like'},{type:'icon',id:'heart',label:'Love'},{type:'icon',id:'smile',label:'Haha'},{type:'icon',id:'star',label:'Wow'},{type:'icon',id:'frown',label:'Sad'},{type:'icon',id:'thumbs-down',label:'No'},{type:'icon',id:'help-circle',label:'Thinking'},{type:'icon',id:'check-circle',label:'Approve'}];
            const reactionSounds = {
                'thumbs-up': new Audio('https://www.soundjay.com/buttons/sounds/button-36.mp3'),
                'heart': new Audio('https://www.soundjay.com/buttons/sounds/button-18.mp3'),
                'smile': new Audio('https://www.soundjay.com/buttons/sounds/button-3.mp3'),
                'star': new Audio('https://www.soundjay.com/buttons/sounds/button-2.mp3'),
                'frown': new Audio('https://www.soundjay.com/buttons/sounds/button-37.mp3'),
                'thumbs-down': new Audio('https://www.soundjay.com/buttons/sounds/button-1.mp3'),
                'help-circle': new Audio('https://www.soundjay.com/buttons/sounds/button-7.mp3'),
                'check-circle': new Audio('https://www.soundjay.com/buttons/sounds/button-23.mp3')
            };
            const globalSounds = {
                'screamSound': new Audio('https://assets.mixkit.co/sfx/preview/mixkit-scream-of-a-man-in-fear-1279.mp3'),
                'applauseSound': new Audio('https://assets.mixkit.co/sfx/preview/mixkit-small-group-of-people-applauding-511.mp3'),
                'attentionSound': new Audio('https://assets.mixkit.co/sfx/preview/mixkit-attention-bell-2759.mp3'),
            };
            const emojis = {
                'üòÄ': ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üôÉ', 'üòâ', 'üòä', 'üòá', 'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòó', 'üòö', 'üòô', 'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î', 'ü§ê', 'ü§®', 'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'ü§•', 'üòå', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï', 'ü§¢', 'ü§Æ', 'ü§ß', 'ü•µ', 'ü•∂', 'ü•¥', 'üòµ', 'ü§Ø', 'ü§†', 'ü•≥', 'üòé', 'ü§ì', 'üßê', 'üòï', 'üòü', 'üôÅ', 'üòÆ', 'üòØ', 'üò≤', 'üò≥', 'ü•∫', 'üò¶', 'üòß', 'üò®', 'üò∞', 'üò•', 'üò¢', 'üò≠', 'üò±', 'üòñ', 'üò£', 'üò©', 'üò´', 'üò°', 'üò†', 'üò§', 'ü§¨', 'üòà', 'üëø', 'üíÄ', 'üëª', 'üí©', 'ü§°'],
                'üçî': ['üçá', 'üçà', 'üçâ', 'üçä', 'üçã', 'üçå', 'üçç', 'ü•≠', 'üçé', 'üçè', 'üçê', 'üçë', 'üçí', 'üçì', 'ü•ù', 'üçÖ', 'ü••', 'ü•ë', 'üçÜ', 'ü•î', 'ü•ï', 'üåΩ', 'üå∂Ô∏è', 'ü•í', 'ü•¨', 'ü•¶', 'üçÑ', 'ü•ú', 'üå∞', 'üçû', 'ü•ê', 'ü•ñ', 'ü•®', 'ü•û', 'üßá', 'üßÄ', 'üçó', 'üçñ', 'ü•©', 'ü•ì', 'üçî', 'üçü', 'üçï', 'üå≠', 'ü•™', 'üåÆ', 'üåØ', 'ü•ô', 'üç≥', 'ü•ö', 'ü•ò', 'üç≤', 'üçú', 'üçù', 'üç£', 'üç§', 'üçö', 'üçô', 'üçò', 'üç•', 'üç°', 'üç¢', 'üçß', 'üç®', 'üç¶', 'ü•ß', 'üç∞', 'üéÇ', 'üçÆ', 'üç¨', 'üç≠', 'üç´', 'üçø', 'üç©', 'üç™', 'ü•õ', '‚òï', 'üçµ', 'üç∂', 'üçæ', 'üç∑', 'üç∏', 'üçπ', 'üç∫', 'üçª', 'ü•Ç', 'ü•É', 'ü•§', 'üßÉ'],
                'üê∂': ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üêî', 'üêß', 'üê¶', 'ü¶â', 'ü¶Ü', 'ü¶Ö', 'ü¶ã', 'üêõ', 'üêù', 'üêû', 'üê¢', 'üêç', 'ü¶ï', 'ü¶ñ', 'üêô', 'ü¶ë', 'ü¶Ä', 'ü¶û', 'ü¶ê', 'üê†', 'üêü', 'üê°', 'üê¨', 'üê≥', 'ü¶à', 'üêä', 'üêÖ', 'üêÜ', 'ü¶ì', 'ü¶í', 'üêò', 'ü¶è', 'üê™', 'üê´', 'ü¶ò', 'üêÉ', 'üêÇ', 'üêÑ', 'üêñ', 'üêè', 'üêë', 'üêê', 'ü¶å', 'üêé', 'üê¥', 'ü¶Ñ', 'üïäÔ∏è', 'üêæ', 'üå≥', 'üå≤', 'üå¥', 'üåµ', 'üå∑', 'üå∏', 'üåπ', 'üåª', 'üåº', 'üå∫', 'üåæ', 'üçÅ', 'üçÇ', 'üçÑ'],
                'üöó': ['‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'üéæ', 'üèê', 'üèâ', 'üé±', 'üèì', 'üè∏', 'üèí', 'ü•ç', 'üèë', 'üèπ', 'üé£', 'ü•ä', 'ü•ã', 'üéø', 'üèÇ', 'üõ∑', '‚õ∏Ô∏è', 'ü•å', 'üéΩ', 'ü§∏', 'üèãÔ∏è', '‚õπÔ∏è', 'ü§∫', 'üèåÔ∏è', 'üèÑ', 'üèä', 'ü§Ω', 'üö£', 'üèá', 'üö¥', 'üöµ', 'üõ£Ô∏è', 'üõ§Ô∏è', 'üö¢', 'üõ≥Ô∏è', '‚õµ', 'üö§', 'üõ•Ô∏è', 'üöÄ', 'üöÅ', '‚úàÔ∏è', 'üõ´', 'üõ¨', 'üöä', 'üöÇ', 'üöÉ', 'üöÑ', 'üöÖ', 'üöÜ', 'üöá', 'üöà', 'üöâ', 'üöè', 'üöå', 'üöê', 'üöë', 'üöí', 'üöì', 'üöï', 'üöñ', 'üöó', 'üöô', 'üöö', 'üöõ', 'üöú', 'üõµ', 'üö≤', 'üõ¥', 'üó∫Ô∏è', 'üìç', 'üß≠'],
                'üí°': ['‚åö', 'üì±', 'üì≤', 'üíª', 'üñ•Ô∏è', '‚å®Ô∏è', 'üñ±Ô∏è', 'üíΩ', 'üíæ', 'üíø', 'üìÄ', 'üßÆ', 'üìπ', 'üì∑', 'üì∏', 'üìΩÔ∏è', 'üé•', 'üé¨', 'üìû', '‚òéÔ∏è', 'üìü', 'üì†', 'üîå', 'üîã', 'üóëÔ∏è', 'üõ¢Ô∏è', 'üî¶', 'üí°', 'üî¶', 'üìñ', 'üìö', 'üìú', 'üì∞', 'üóûÔ∏è', 'üîñ', 'üè∑Ô∏è', 'üí∞', 'üíµ', 'üí≥', 'üíé', 'üîë', 'üîì', 'üîè', 'üîí', 'üîê', 'üîë', 'üî®', '‚öíÔ∏è', '‚õèÔ∏è', 'üî©', '‚öôÔ∏è', 'üîß', '‚õìÔ∏è', 'üß∞', 'üß±', 'üö™', 'ü™ë', 'üõãÔ∏è', 'üõèÔ∏è', 'üõÅ', 'üöø', 'üöΩ', 'ü™†', 'üîî', 'üîï', 'üì¢', 'üì£', 'üìØ', 'üé∂', 'üéº', 'üéµ', 'üéôÔ∏è', 'üé§', 'üéß', 'üìª', 'üì∫', 'üìª', 'üéÅ', 'üéÄ', 'üéâ', 'üéä', 'üéà', 'üìß', '‚úâÔ∏è', 'üì¶', 'üì§', 'üì•', 'üì´', 'üì™', 'üì¨', 'üì≠', 'üìÆ'],
                'üáßüá∑': ['üáßüá∑', 'üá∫üá∏', 'üá™üá∏', 'üá´üá∑', 'üá©üá™', 'üáÆüáπ', 'üáØüáµ', 'üá®üá≥', 'üá∑üá∫', 'üáÆüá≥', 'üá¶üá∑', 'üá®üá¶', 'üá≤üáΩ', 'üáµüáπ', 'üá¨üáß', 'üá∞üá∑', 'üá¶üá∫', 'üáøüá¶', 'üá™üá¨', 'üá∏üá¶', 'üáπüá∑', 'üáµüá±', 'üáÆüá©', 'üáπüá≠', 'üáªüá≥', 'üá≥üá¨', 'üá®üá¥', 'üáµüá∞', 'üá©üáø', 'üáÆüá∂', 'üá∫üá¶', 'üá®üá≠', 'üá≥üá±', 'üáßüá™', 'üá∏üá™', 'üá≥üá¥', 'üá´üáÆ', 'üá©üá∞', 'üáÆüá™', 'üá¨üá∑', 'üá®üá±', 'üáµüá™', 'üá™üá®', 'üáªüá™', 'üá∫üáæ', 'üáµüáæ', 'üáßüá¥', 'üá¶üá™', 'üá∂üá¶', 'üá∞üáº', 'üáÆüá±', 'üáπüáº', 'üá∏üá¨', 'üá≤üáæ', 'üáµüá≠', 'üáÆüá®', 'üá≠üá∑', 'üá∑üá¥', 'üá®üáø', 'üá≠üá∫', 'üáßüá¨', 'üá¶üáπ', 'üá∏üá∞', 'üá∏üáÆ', 'üá±üáª', 'üá™üá™', 'üá±üáπ', 'üá≤üáπ', 'üá®üáæ', 'üá¶üá±', 'üáßüá¶', 'üá≤üá™', 'üá≤üá∞', 'üáΩüá∞', 'üá∑üá∏', 'üá®üáø', 'üá¨üá™', 'üá¶üá≤', 'üá¶üáø', 'üá∞üáø', 'üá∫üáø', 'üáπüá≤', 'üáπüáØ', 'üá∞üá¨', 'üá±üá∞', 'üáßüá©', 'üá≥üáµ', 'üá≤üá≤', 'üá∞üá≠', 'üá±üá¶', 'üáµüá¨', 'üá´üáØ', 'üá≥üáø', 'üáºüá∏', 'üáπüá¥', 'üáπüáª', 'üá∞üáÆ', 'üá≤üá≠', 'üá´üá≤', 'üáµüáº', 'üá∏üáß', 'üáªüá∫', 'üá¶üáÆ', 'üá¶üá∂', 'üá¶üá∏', 'üá¶üáº', 'üá¶üáΩ', 'üáßüáß', 'üáßüá≤', 'üáßüáº', 'üá®üá©', 'üá®üá´', 'üá®üá¨', 'üá®üáÆ', 'üá®üá∞', 'üá®üáΩ', 'üá®üáø', 'üá™üá≠', 'üá™üá∑', 'üá™üáπ', 'üá´üá¥', 'üá¨üá¶', 'üá¨üá©', 'üá¨üá´', 'üá¨üá¨', 'üá¨üá≠', 'üá¨üáÆ', 'üá¨üá±', 'üá¨üá≤', 'üá¨üáº', 'üá¨üáæ', 'üá≠üá∞', 'üáÆüá¥', 'üáØüá™', 'üá∞üá™', 'üá∞üá≤', 'üá±üá®', 'üá±üáÆ', 'üá≤üá¨', 'üá≤üá∑', 'üá≤üá∫', 'üá≤üáº', 'üá≤üáΩ', 'üá≤üáæ', 'üá≤üáø', 'üá≥üá¶', 'üá≥üá®', 'üá≥üá™', 'üá≥üá´', 'üá≥üá¨', 'üá≥üá±', 'üá≥üá¥', 'üá≥üáµ', 'üá≥üá∑', 'üá≥üá∫', 'üá≥üáø', 'üá¥üá≤', 'üáµüá¶', 'üáµüá™', 'üáµüá´', 'üáµüá¨', 'üáµüá≠', 'üáµüá∞', 'üáµüá±', 'üáµüá≤', 'üáµüá≥', 'üáµüá∑', 'üáµüá∏', 'üáµüáπ', 'üáµüáº', 'üáµüáæ', 'üá∂üá¶', 'üá∑üá™', 'üá∑üá¥', 'üá∑üá∏', 'üá∑üá∫', 'üá∑üáº', 'üá∏üá¶', 'üá∏üáß', 'üá∏üá®', 'üá∏üá©', 'üá∏üá™', 'üá∏üá¨', 'üá∏üá≠', 'üá∏üáÆ', 'üá∏üá∞', 'üá∏üá±', 'üá∏üá≤', 'üá∏üá≥', 'üá∏üá¥', 'üá∏üá∑', 'üá∏üá∏', 'üá∏üáπ', 'üá∏üáª', 'üá∏üáΩ', 'üá∏üáæ', 'üá∏üáø', 'üáπüá®', 'üáπüá©', 'üáπüá´', 'üáπüá¨', 'üáπüá≠', 'üáπüáØ', 'üáπüá∞', 'üáπüá±', 'üáπüá≤', 'üáπüá≥', 'üáπüá¥', 'üáπüá∑', 'üáπüáπ', 'üáπüáª', 'üáπüáº', 'üáπüáø', 'üá∫üá¶', 'üá∫üá¨', 'üá∫üá≤', 'üá∫üá≥', 'üá∫üá∏', 'üá∫üáæ', 'üá∫üáø', 'üáªüá¶', 'üáªüá®', 'üáªüá™', 'üáªüá¨', 'üáªüáÆ', 'üáªüá≥', 'üáªüá∫', 'üáºüá´', 'üáºüá∏', 'üáΩüá∞', 'üáæüá™', 'üáæüáπ', 'üáøüá¶', 'üáøüá≤', 'üáøüáº']
            };
            let chatState = { mode: 'main', withUser: null };
            let userAlarmCounts = {};
            
            const messageSound = new Audio('https://www.soundjay.com/buttons/button-10.mp3');
            const applauseSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-small-group-of-people-applauding-511.mp3');
            const screamSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-scream-of-a-man-in-fear-1279.mp3');
            const attentionSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-attention-bell-2759.mp3');
            const thumbsUpSound = new Audio('https://www.soundjay.com/buttons/sounds/button-36.mp3');
            const heartSound = new Audio('https://www.soundjay.com/buttons/sounds/button-18.mp3');
            const smileSound = new Audio('https://www.soundjay.com/buttons/sounds/button-3.mp3');
            const starSound = new Audio('https://www.soundjay.com/buttons/sounds/button-2.mp3');
            const frownSound = new Audio('https://www.soundjay.com/buttons/sounds/button-37.mp3');
            const thumbsDownSound = new Audio('https://www.soundjay.com/buttons/sounds/button-1.mp3');
            const helpCircleSound = new Audio('https://www.soundjay.com/buttons/sounds/button-7.mp3');
            const checkCircleSound = new Audio('https://www.soundjay.com/buttons/sounds/button-23.mp3');

            setInterval(() => { userAlarmCounts = {}; }, 3600000);

            function updateAdminStats() {
                const totalUsers = Object.keys(onlineUsers).length;
                const activeRooms = new Set(Object.values(onlineUsers).map(u => u.room));
                adminStatsDiv.innerHTML = `<b>Online Users:</b> ${totalUsers}`;
                
                adminRoomList.innerHTML = `<h3>Active Rooms:</h3><ul>${Array.from(activeRooms).map(room => `<li>Room ${room} ${roomLocks[room] ? '(Locked)' : ''}</li>`).join('')}</ul>`;
            }
            
            function updateAdminRoomUsers() {
                const usersInCurrentRoom = Object.values(onlineUsers).filter(data => data.room === currentRoom);
                
                let usersHtml = '<h3>Users in Room:</h3>';
                if (usersInCurrentRoom.length > 0) {
                    usersHtml += `<div class="admin-user-list"><ul>${usersInCurrentRoom.map(user => `<li>${user.username} <button data-user-to-kick="${user.username}">Kick</button></li>`).join('')}</ul></div>`;
                } else {
                    usersHtml += '<p>No other users in this room.</p>';
                }
                adminRoomUsersDiv.innerHTML = usersHtml;
            }

            adminRoomUsersDiv.addEventListener('click', e => {
                const button = e.target.closest('button');
                if (button && button.dataset.userToKick) {
                    const userToKick = button.dataset.userToKick;
                    if (confirm(`Are you sure you want to kick ${userToKick}?`)) {
                        socket.emit('kick_user', userToKick);
                    }
                }
            });
            
            function searchUserByName() {
                const userToFind = adminUserInput.value.trim();
                if (userToFind) {
                    socket.emit('search_user', userToFind);
                }
            }

            function searchRoomContents() {
                const roomToFind = parseInt(adminRoomInput.value);
                if (!isNaN(roomToFind)) {
                    socket.emit('search_room', roomToFind);
                }
            }
            
            function toggleRoomLock() {
                socket.emit('admin_toggle_lock', currentRoom);
            }

            function displaySystemMessage(message) {
                const e = document.createElement('div');
                e.className = 'system-message';
                e.textContent = message;
                chatScreen.appendChild(e);
                chatScreen.scrollTop = chatScreen.scrollHeight;
                if (isAudioEnabled) messageSound.play();
            }

            function displayInviteMessage(inviterName, roomNumber) {
                const inviteDiv = document.createElement('div');
                inviteDiv.className = 'invite-message';
                inviteDiv.innerHTML = `<p><b>${inviterName}</b> invited you to join <b>Room ${roomNumber}</b>.</p><button class="invite-accept-btn" data-room="${roomNumber}">Yes</button><button class="invite-decline-btn decline">No</button>`;
                chatScreen.appendChild(inviteDiv);
                chatScreen.scrollTop = chatScreen.scrollHeight;
            }

            function displayGlobalMessage(message) {
                const e = document.createElement('div');
                e.className = 'global-message';
                e.innerHTML = `<b>Global Announcement:</b><br>${message.content}`;
                chatScreen.appendChild(e);
                chatScreen.scrollTop = chatScreen.scrollHeight;
                
                if (isAudioEnabled && message.sound !== 'none' && globalSounds[message.sound]) {
                    const sound = globalSounds[message.sound];
                    sound.currentTime = 0;
                    sound.play();
                }
            }

            function applyFormatting(text, styles) {
                let s = text;
                if (styles.bold) s = `<b>${s}</b>`;
                if (styles.italic) s = `<i>${s}</i>`;
                if (styles.underline) s = `<u>${s}</u>`;
                if (styles.strikethrough) s = `<s>${s}</s>`;
                if (styles.highlight) s = `<span style="background-color: ${styles.highlight};">${s}</span>`;
                let style = `font-size: ${styles.fontSize}px; color: ${styles.color}; font-family: '${styles.fontFamily}', sans-serif;`;
                if (styles.shadow) style += ' text-shadow: 1px 1px 1px rgba(0,0,0,0.4);';
                return `<span style="${style}">${s}</span>`;
            }

            function getCurrentTime(timestamp) {
                const now = new Date(timestamp);
                const options = {
                    year: '2-digit',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true,
                    timeZone: 'America/Vancouver'
                };
                const formatter = new Intl.DateTimeFormat('en-US', options);
                const formattedTime = formatter.format(now).replace(',', '');
                return `[${formattedTime} SLT]`;
            }

            function createMessageElement(messageData, isMyMessage = false) {
                const id = messageData.id;
                const messageDiv = document.createElement('div');
                messageDiv.id = id;
                messageDiv.className = 'chat-message';
                if (isMyMessage) messageDiv.classList.add('my-message');
                
                let displayName = messageData.username;
                let adminStar = '';
                const userObj = Object.values(onlineUsers).find(u => u.username === messageData.username);
                if (userObj && userObj.isAdmin) {
                    displayName = `<b>${messageData.username}</b>`;
                    adminStar = '<i data-feather="star" class="admin-star"></i>';
                }
                
                const headerDiv = document.createElement('div');
                headerDiv.style.display = 'flex';
                headerDiv.style.alignItems = 'center';
                headerDiv.innerHTML = `${adminStar}<b>${displayName}:</b>`;

                const contentDiv = document.createElement('div');
                contentDiv.innerHTML = messageData.content;
                
                const timestampSpan = document.createElement('span');
                timestampSpan.className = 'timestamp';
                timestampSpan.textContent = getCurrentTime(messageData.timestamp);

                const reactionsWrapper = document.createElement('div');
                reactionsWrapper.className = 'reactions-display';
                
                messageDiv.appendChild(headerDiv);
                messageDiv.appendChild(contentDiv);
                messageDiv.appendChild(timestampSpan);
                messageDiv.appendChild(reactionsWrapper);
                
                chatScreen.appendChild(messageDiv);
                chatScreen.scrollTop = chatScreen.scrollHeight;
                feather.replace();
                if (isAudioEnabled) {
                    messageSound.currentTime = 0;
                    messageSound.play();
                }
                if (allMessages[messageData.id] && allMessages[messageData.id].reactions) {
                    updateReactionsDisplay(messageData.id, allMessages[messageData.id].reactions);
                }
            }

            function renderAllMessages() {
                chatScreen.innerHTML = '';
                const currentRoomMessages = Object.values(allMessages).filter(m => {
                    const sender = Object.values(onlineUsers).find(u => u.username === m.username);
                    return sender && sender.room === currentRoom;
                });
                
                currentRoomMessages.forEach(msg => {
                    const isMyMessage = msg.username === currentUser.replace(' (Admin)', '');
                    createMessageElement(msg, isMyMessage);
                });
            }
            
            function linkify(text) {
                const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
                return text.replace(urlRegex, url => `<a href="${url.startsWith('http')?url:'https://'+url}" target="_blank">${url}</a>`);
            }

            function sendMessage() {
                if (messageInput.textContent.trim() === "") return;
                const formattedText = applyFormatting(linkify(messageInput.innerHTML), activeStyles);

                if (isEditing) {
                    socket.emit('edit_message', {
                        id: messageToEditId,
                        content: formattedText
                    });
                    isEditing = false;
                    messageToEditId = null;
                    sendBtn.innerHTML = '<i data-feather="send"></i>';
                } else {
                    socket.emit('send_message', {
                        content: formattedText,
                        styles: activeStyles,
                        fontSize: activeFontSize
                    });
                }

                messageInput.innerHTML = '';
                messageInput.focus();
                feather.replace();
            }
            
            function updateHeaderUI(){
                const chatScreenActive=document.getElementById('chatScreen').classList.contains('active'),loginScreenActive=document.getElementById('loginScreen').classList.contains('active');
                backToChatBtn.style.display=chatState.mode==='private'?'flex':'none';
                roomsBtn.style.display=chatScreenActive&&chatState.mode==='main'?'flex':'none';
                logoutBtn.style.display=loginScreenActive?'none':'flex';
                inviteUserBtn.style.display=chatScreenActive&&currentRoom>0?'flex':'none';
                adminPanelBtn.style.display = currentUser.includes('(Admin)') && !loginScreenActive ? 'flex' : 'none';
                
                roomLockBtn.style.display = currentUser.includes('(Admin)') && chatScreenActive && currentRoom !== 0 ? 'flex' : 'none';
                const icon = roomLockBtn.querySelector('i');
                if (icon) {
                    if (roomLocks[currentRoom]) {
                        icon.setAttribute('data-feather', 'lock');
                    } else {
                        icon.setAttribute('data-feather', 'unlock');
                    }
                }
                
                usersOnlineBtn.style.display = chatScreenActive ? 'flex' : 'none';
                alarmBtn.style.display = chatScreenActive ? 'flex' : 'none';
                saveChatBtn.style.display = chatScreenActive ? 'flex' : 'none';
                colorPaletteBtn.style.display = chatScreenActive ? 'flex' : 'none';
                mobileViewBtn.style.display = !chatWindow.classList.contains('mobile-view') && !loginScreenActive ? 'flex' : 'none';
                audioToggleBtn.style.display = !loginScreenActive ? 'flex' : 'none';
                minimizeChatBtn.style.display = !loginScreenActive ? 'flex' : 'none';
                maximizeChatBtn.style.display = !chatWindow.classList.contains('maximized') && !loginScreenActive ? 'flex' : 'none';
                restoreChatBtn.style.display = chatWindow.classList.contains('maximized') && !loginScreenActive ? 'flex' : 'none';

                if(loginScreenActive){
                    screenTitle.innerText='Login';
                } else if (chatState.mode==='private'){
                    screenTitle.innerText=`Chat with ${chatState.withUser}`;
                } else {
                    screenTitle.innerText=`Chat - Room ${currentRoom}`;
                }
                feather.replace();
            }
            
            function showScreen(screenId){
                document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
                document.getElementById(screenId).classList.add("active");
                document.getElementById('chatFooter').style.display=screenId==='chatScreen'?'flex':'none';
                updateHeaderUI();
            }

            function login() {
                let username = usernameInput.value.trim();
                if (username === "") return void alert("Please enter a username.");
                
                const allowedCharsRegex = /^[a-zA-Z0-9.\-]+$/;
                if (!allowedCharsRegex.test(username)) {
                    return void alert("The username can only contain letters, numbers, one period, or one hyphen, without accents.");
                }
                const dotOrHyphenCount = (username.match(/[\.\-]/g) || []).length;
                if (dotOrHyphenCount > 1) {
                    return void alert("The username can only contain one period or one hyphen.");
                }
                if (username.includes('.') && username.includes('-')) {
                    return void alert("The username can only contain one period or one hyphen, not both.");
                }
                
                socket.emit('login', username);
            }

            function startMainChat(){
                chatScreen.innerHTML = '';
                chatState={mode:'main',withUser:null};
                renderAllMessages();
                updateHeaderUI();
                showScreen('chatScreen');
            }
            
            function changeRoom(newRoomStr) {
                const newRoom = parseInt(newRoomStr);
                if (isNaN(newRoom) || newRoom < 0) return alert("Invalid room number.");
                if (newRoom === currentRoom) return;
                
                currentRoom = newRoom;
                socket.emit('join_room', newRoom);
            }
            
            socket.on('initial_data', (data) => {
                onlineUsers = data.users.reduce((acc, user) => { acc[user.username] = user; return acc; }, {});
                Object.assign(roomLocks, data.roomLocks);
                allMessages = data.messages;
                renderAllMessages();
                updateHeaderUI();
                updateAdminStats();
            });

            socket.on('login_success', (data) => {
                currentUser = data.username;
                if (data.isAdmin) {
                    currentUser += ' (Admin)';
                }
                startMainChat();
            });

            socket.on('login_error', (message) => {
                alert(message);
            });
            
            socket.on('admin_login_challenge', () => {
                const password = prompt("Restricted access. Please enter the Admin password:");
                socket.emit('admin_password_submit', password);
            });
            
            socket.on('kick_success', () => {
                alert('You have been kicked by an admin.');
                location.reload();
            });

            socket.on('update_data', (data) => {
                onlineUsers = data.users.reduce((acc, user) => { acc[user.username] = user; return acc; }, {});
                Object.assign(roomLocks, data.roomLocks);
                allMessages = data.messages;
                renderAllMessages();
                updateHeaderUI();
                updateAdminStats();
                updateAdminRoomUsers();
            });

            socket.on('new_message', (messageData) => {
                allMessages[messageData.id] = messageData;
                const sender = onlineUsers[messageData.username];
                if (sender && sender.room === currentRoom) {
                     createMessageElement(messageData, messageData.username === currentUser.replace(' (Admin)', ''));
                }
            });
            
            socket.on('update_message', (messageData) => {
                if (allMessages[messageData.id]) {
                    allMessages[messageData.id].content = messageData.content;
                    const messageElement = document.getElementById(messageData.id);
                    if (messageElement) {
                        messageElement.querySelector('div:nth-child(2)').innerHTML = messageData.content;
                    }
                }
            });

            socket.on('delete_message', (messageId) => {
                const messageElement = document.getElementById(messageId);
                if (messageElement) {
                    messageElement.remove();
                }
                delete allMessages[messageId];
            });
            
            socket.on('system_message', (message) => {
                displaySystemMessage(message);
            });

            socket.on('room_locked', () => {
                alert('Room is locked by an admin.');
            });

            socket.on('invite_received', (data) => {
                displayInviteMessage(data.inviter, data.room);
            });

            socket.on('global_message', (message) => {
                displayGlobalMessage(message);
            });

            socket.on('attention_call', (data) => {
                if (data.user === 'all' || data.user === currentUser.replace(' (Admin)', '')) {
                    chatWindow.classList.add('shake-animation');
                    if (isAudioEnabled) {
                        globalSounds[data.sound].currentTime = 0;
                        globalSounds[data.sound].play();
                    }
                    setTimeout(() => chatWindow.classList.remove('shake-animation'), 500);
                }
            });

            socket.on('update_reactions', ({ messageId, reactions }) => {
                const reactionsWrapper = document.getElementById(messageId);
                if (reactionsWrapper) {
                    reactionsWrapper.innerHTML = '';
                    for (const reaction in reactions) {
                        const count = reactions[reaction];
                        if (count > 0) {
                            const reactionSpan = document.createElement('span');
                            reactionSpan.className = 'reaction-count';
                            reactionSpan.innerHTML = `<i data-feather="${reaction}"></i>${count}`;
                            reactionsWrapper.appendChild(reactionSpan);
                        }
                    }
                    feather.replace();
                }
            });

            socket.on('search_result', (data) => {
                if (data) {
                    adminSearchResults.innerHTML = `User <b>${data.username}</b> is in Room <b>${data.room}</b>.`;
                } else {
                    adminSearchResults.textContent = "User not found.";
                }
            });

            socket.on('search_result_room', (usersInRoom) => {
                if (usersInRoom.length > 0) {
                    adminSearchResults.innerHTML = `Users in Room: ${usersInRoom.join(', ')}.`;
                } else {
                    adminSearchResults.textContent = "Nobody in this room.";
                }
            });

            loginBtn.addEventListener("click", login);
            usernameInput.addEventListener('keydown', e => { if (e.key === 'Enter') login(); });
            logoutBtn.addEventListener("click", () => {
                socket.emit('logout');
                showScreen('loginScreen');
                location.reload();
            });
            
            adminPanelBtn.addEventListener('click', () => {
                adminPanelModal.style.display = 'flex';
                updateAdminStats();
                updateAdminRoomUsers();
            });

            adminPanelModal.addEventListener('click', e => { if(e.target === adminPanelModal) adminPanelModal.style.display = 'none'; });
            adminUserSearchBtn.addEventListener('click', searchUserByName);
            adminRoomSearchBtn.addEventListener('click', searchRoomContents);
            roomLockBtn.addEventListener('click', toggleRoomLock);

            chatIcon.addEventListener("click",()=>chatWindow.classList.toggle('open'));
            backToChatBtn.addEventListener("click",()=>changeRoom('0'));
            roomsBtn.addEventListener("click", () => roomsModal.style.display = 'flex');
            roomsModal.addEventListener('click', e => { if(e.target === roomsModal) roomsModal.style.display = 'none'; });
            joinRoomBtn.addEventListener('click', () => {
                changeRoom(roomNumberInput.value);
                roomsModal.style.display = 'none';
                roomNumberInput.value = '';
            });
            inviteUserBtn.addEventListener('click', () => inviteModal.style.display = 'flex');
            inviteModal.addEventListener('click', e => { if(e.target === inviteModal) inviteModal.style.display = 'none'; });
            sendBtn.addEventListener("click",sendMessage);
            messageInput.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}});
            
            chatScreen.addEventListener('click', e => {
                const messageElement = e.target.closest('.chat-message');
                if (messageElement) {
                    const messageId = messageElement.id;
                    reactionPopup.style.display = 'flex';
                    const reactionOptionsHtml = availableReactions.map(r => `<button class="reaction-button" data-message-id="${messageId}" data-reaction="${r.id}"><i data-feather="${r.id}"></i></button>`).join('');
                    reactionPopup.querySelector('.reaction-options').innerHTML = reactionOptionsHtml;
                    
                    const isMyMessage = messageElement.querySelector('b').textContent === currentUser.replace(' (Admin)', '');
                    const postActions = reactionPopup.querySelector('.post-actions-buttons');
                    if (isMyMessage) {
                        postActions.innerHTML = `
                            <button class="action-button edit-post" data-message-id="${messageId}" title="Edit"><i data-feather="edit-2"></i></button>
                            <button class="action-button delete-post" data-message-id="${messageId}" title="Delete"><i data-feather="trash-2"></i></button>
                        `;
                    } else {
                        postActions.innerHTML = '';
                    }

                    feather.replace();
                } else if (e.target.classList.contains('invite-accept-btn')) {
                    const roomToJoin = e.target.getAttribute('data-room');
                    changeRoom(roomToJoin);
                }
            });
            
            reactionPopup.addEventListener('click', e => {
                const button = e.target.closest('button');
                if (button) {
                    const messageId = button.dataset.messageId;
                    
                    if (button.classList.contains('reaction-button')) {
                        const reaction = button.dataset.reaction;
                        socket.emit('add_reaction', { messageId, reaction });
                        
                        if(isAudioEnabled && reactionSounds[reaction]) {
                            reactionSounds[reaction].currentTime = 0;
                            reactionSounds[reaction].play();
                        }
                    }  else if (button.classList.contains('edit-post')) {
                        const messageElement = document.getElementById(messageId);
                        const messageContentDiv = messageElement.querySelector('div:nth-child(2)');
                        messageInput.innerHTML = messageContentDiv.innerHTML;
                        isEditing = true;
                        messageToEditId = messageId;
                        sendBtn.innerHTML = '<i data-feather="check"></i>';
                        messageInput.focus();
                    } else if (button.classList.contains('delete-post')) {
                        if (confirm("Are you sure you want to delete this message?")) {
                            socket.emit('delete_message', messageId);
                        }
                    }
                     reactionPopup.style.display = 'none';
                }
            });

            const adminGlobalMessageInput = document.getElementById('adminGlobalMessage');
            const sendGlobalMessageBtn = document.getElementById('sendGlobalMessageBtn');
            const adminGlobalFormattingToolbar = document.querySelector('.admin-global-formatting-toolbar');
            
            adminGlobalFormattingToolbar.addEventListener('click', e => {
                const button = e.target.closest('.tool-button');
                if (!button) return;
                
                const command = button.dataset.command;
                if (['bold', 'italic', 'underline', 'strikethrough', 'shadow'].includes(command)) {
                    adminGlobalStyles[command] = !adminGlobalStyles[command];
                    button.classList.toggle('active', adminGlobalStyles[command]);
                } else if (button.id === 'admin-fontSizePlusBtn') {
                    if (adminGlobalFontSize < 24) {
                        adminGlobalFontSize += 2;
                        adminGlobalMessageInput.style.fontSize = `${adminGlobalFontSize}px`;
                    }
                } else if (button.id === 'admin-fontSizeMinusBtn') {
                    if (adminGlobalFontSize > 12) {
                        adminGlobalFontSize -= 2;
                        adminGlobalMessageInput.style.fontSize = `${adminGlobalFontSize}px`;
                    }
                } else if (button.id === 'admin-highlightBtn') {
                    document.getElementById('admin-highlightPicker').click();
                } else if (button.id === 'admin-colorBtn') {
                    document.getElementById('admin-colorPicker').click();
                }
            });

            document.getElementById('admin-colorPicker').addEventListener('input', e => { adminGlobalStyles.color = e.target.value; });
            document.getElementById('admin-highlightPicker').addEventListener('input', e => { adminGlobalStyles.highlight = e.target.value; });
            document.getElementById('admin-global-sound-select').addEventListener('change', (e) => {
                adminGlobalSound = e.target.value;
            });

            sendGlobalMessageBtn.addEventListener('click', () => {
                const message = adminGlobalMessageInput.innerHTML.trim();
                if (message) {
                    const formattedMessage = applyFormatting(message, {
                        bold: adminGlobalStyles.bold,
                        italic: adminGlobalStyles.italic,
                        underline: adminGlobalStyles.underline,
                        strikethrough: adminGlobalStyles.strikethrough,
                        shadow: adminGlobalStyles.shadow,
                        color: adminGlobalStyles.color,
                        fontFamily: adminGlobalStyles.fontFamily,
                        highlight: adminGlobalStyles.highlight,
                        fontSize: adminGlobalFontSize
                    });
                    socket.emit('send_global_message', { content: formattedMessage, sound: adminGlobalSound });
                    adminGlobalMessageInput.innerHTML = '';
                }
            });

            // Adiciona listener para a tecla Enter no input do admin
            adminGlobalMessageInput.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendGlobalMessageBtn.click();
                }
            });

            toggleFormattingBtn.addEventListener('click', () => { formattingPopup.classList.toggle('open'); });
            
            formattingPopup.addEventListener('click', e => {
                const button = e.target.closest('.tool-button');
                if (button && button.dataset.command) {
                    const command = button.dataset.command;
                    activeStyles[command] = !activeStyles[command];
                    button.classList.toggle('active', activeStyles[command]);
                }
            });

            fontSelect.addEventListener('change', e => { activeStyles.fontFamily = e.target.value; });

            colorBtn.addEventListener('click', () => { colorPicker.click(); });
            colorPicker.addEventListener('input', e => { activeStyles.color = e.target.value; });

            fontSizePlusBtn.addEventListener('click', () => {
                if (activeFontSize < 24) {
                    activeFontSize += 2;
                    messageInput.style.fontSize = `${activeFontSize}px`;
                }
            });

            fontSizeMinusBtn.addEventListener('click', () => {
                if (activeFontSize > 12) {
                    activeFontSize -= 2;
                    messageInput.style.fontSize = `${activeFontSize}px`;
                }
            });

            highlightBtn.addEventListener('click', () => { highlightPicker.click(); });
            highlightPicker.addEventListener('input', e => { activeStyles.highlight = e.target.value; });


            mentionBtn.addEventListener('click', () => {
                const usernameToMention = prompt("Enter the username you want to mention:");
                if (usernameToMention) {
                    messageInput.textContent = `@${usernameToMention} `;
                    messageInput.focus();
                }
            });

            attachFileBtn.addEventListener('click', () => {
                fileUpload.click();
            });

            fileUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = `<img src="${e.target.result}" style="max-width: 100%; max-height: 200px; display: block; margin-top: 10px; cursor: pointer;" onclick="window.open(this.src)" />`;
                            socket.emit('send_message', {
                                content: img
                            });
                            displaySystemMessage(`Image "${file.name}" sent.`);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        socket.emit('send_message', {
                            content: `File attached: ${file.name}`
                        });
                        displaySystemMessage(`File "${file.name}" attached.`);
                    }
                    fileUpload.value = '';
                }
            });

            emojiBtn.addEventListener('click', () => {
                emojiModal.style.display = 'flex';
                
                const emojiCategoryMap = {
                    'üòÄ': 'Smileys & Emotion',
                    'üê∂': 'Animals & Nature',
                    'üçî': 'Food & Drink',
                    'üöó': 'Activities & Travel',
                    'üí°': 'Objects & Symbols',
                    'üáßüá∑': 'Flags'
                };

                let emojiHtml = `<div class="emoji-category-tabs">`;
                for (const emojiKey in emojis) {
                    emojiHtml += `<button data-category-key="${emojiKey}">${emojiKey}</button>`;
                }
                emojiHtml += `</div>`;
                emojiHtml += `<div id="emoji-list-content" class="emoji-picker-container"></div>`;
                emojiPicker.innerHTML = emojiHtml;
                
                const emojiListContent = document.getElementById('emoji-list-content');
                let initialCategoryKey = 'üòÄ'; 
                
                const renderEmojis = (categoryKey) => {
                    const categoryEmojis = emojis[categoryKey];
                    emojiListContent.innerHTML = categoryEmojis.map(emoji => `<button class="emoji-button">${emoji}</button>`).join('');
                };
                
                renderEmojis(initialCategoryKey);

                const categoryTabs = document.querySelector('.emoji-category-tabs');
                categoryTabs.addEventListener('click', e => {
                    const button = e.target.closest('button');
                    if (button) {
                        const categoryKey = button.dataset.categoryKey;
                        renderEmojis(categoryKey);
                    }
                });
            });

            emojiPicker.addEventListener('click', e => {
                const button = e.target.closest('.emoji-button');
                if (button) {
                    messageInput.textContent += button.textContent;
                    emojiModal.style.display = 'none';
                    messageInput.focus();
                }
            });
            
            saveChatBtn.addEventListener('click', () => {
                const element = document.getElementById('chatScreen');
                const opt = {
                    margin: 1,
                    filename: `chat-sala-${currentRoom}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                html2pdf().from(element).set(opt).save();
            });
            
            usersOnlineBtn.addEventListener('click', () => {
                usersOnlineModal.style.display = 'flex';
                const usersInCurrentRoom = Object.values(onlineUsers).filter(user => user.room === currentRoom);
                
                let usersHtml = '<h3>Users in Room:</h3>';
                if (usersInCurrentRoom.length > 0) {
                    usersHtml += `<ul>${usersInCurrentRoom.map(user => `<li>${user.username}</li>`).join('')}</ul>`;
                } else {
                    usersHtml += '<p>No other users in this room.</p>';
                }

                usersListDiv.innerHTML = usersHtml;
            });

            alarmBtn.addEventListener('click', () => {
                if (!userAlarmCounts[currentUser]) {
                    userAlarmCounts[currentUser] = 0;
                }
                if (userAlarmCounts[currentUser] >= 3) {
                    alert('You can only call for attention 3 times per hour. Please wait to try again.');
                    return;
                }

                alarmModal.style.display = 'flex';
                const usersInRoom = Object.values(onlineUsers).filter(user => user.room === currentRoom);
                const userListHtml = usersInRoom.map(user => `<button data-user="${user.username}">${user.username}</button>`).join('');
                alarmOptionsDiv.innerHTML = `<h3>Call Attention: (${userAlarmCounts[currentUser]}/3)</h3><button data-user="all">All in Room</button>${userListHtml}`;
            });
            
            alarmOptionsDiv.addEventListener('click', e => {
                const button = e.target.closest('button');
                if (button) {
                    const user = button.dataset.user;
                    if (!userAlarmCounts[currentUser]) {
                        userAlarmCounts[currentUser] = 0;
                    }
                    userAlarmCounts[currentUser]++;
                    
                    if (user === 'all') {
                        socket.emit('call_attention', { user: 'all', sound: 'applauseSound' });
                        displaySystemMessage(`${currentUser.replace(' (Admin)', '')} is calling everyone's attention.`);
                    } else {
                        socket.emit('call_attention', { user: user, sound: 'attentionSound' });
                        displaySystemMessage(`${currentUser.replace(' (Admin)', '')} is calling ${user}'s attention.`);
                    }
                    alarmModal.style.display = 'none';
                }
            });
            
            usersOnlineModal.addEventListener('click', e => { if(e.target === usersOnlineModal) usersOnlineModal.style.display = 'none'; });
            alarmModal.addEventListener('click', e => { if(e.target === alarmModal) alarmModal.style.display = 'none'; });
            emojiModal.addEventListener('click', e => { if(e.target === emojiModal) emojiModal.style.display = 'none'; });


            audioToggleBtn.addEventListener('click', () => {
                isAudioEnabled = !isAudioEnabled;
                const icon = audioToggleBtn.querySelector('i');
                icon.setAttribute('data-feather', isAudioEnabled ? 'volume-2' : 'volume-x');
                feather.replace();
            });

            minimizeChatBtn.addEventListener('click', () => {
                chatWindow.classList.add('minimized');
                chatWindow.classList.remove('maximized');
                chatWindow.classList.remove('mobile-view');
                maximizeChatBtn.style.display = 'flex';
                restoreChatBtn.style.display = 'none';
                mobileViewBtn.style.display = 'flex';
                minimizeChatBtn.style.display = 'none';
            });
            
            maximizeChatBtn.addEventListener('click', () => {
                chatWindow.classList.add('maximized');
                chatWindow.classList.remove('minimized');
                chatWindow.classList.remove('mobile-view');
                maximizeChatBtn.style.display = 'none';
                restoreChatBtn.style.display = 'flex';
                mobileViewBtn.style.display = 'flex';
                minimizeChatBtn.style.display = 'flex';
            });

            restoreChatBtn.addEventListener('click', () => {
                chatWindow.classList.remove('maximized');
                chatWindow.classList.remove('minimized');
                chatWindow.classList.remove('mobile-view');
                restoreChatBtn.style.display = 'none';
                maximizeChatBtn.style.display = 'flex';
                mobileViewBtn.style.display = 'flex';
                minimizeChatBtn.style.display = 'flex';
            });
            
            mobileViewBtn.addEventListener('click', () => {
                chatWindow.classList.add('mobile-view');
                chatWindow.classList.remove('maximized');
                chatWindow.classList.remove('minimized');
                mobileViewBtn.style.display = 'none';
                maximizeChatBtn.style.display = 'none';
                restoreChatBtn.style.display = 'flex';
                minimizeChatBtn.style.display = 'flex';
            });

            colorPaletteBtn.addEventListener('click', () => {
                chatWallpaperColor.click();
            });

            chatWallpaperColor.addEventListener('input', (e) => {
                chatScreen.style.backgroundColor = e.target.value;
            });
            
            googleFonts.forEach(fontName=>{const option=document.createElement('option');option.value=fontName;option.textContent=fontName;option.style.fontFamily=fontName;fontSelect.appendChild(option);});
            
            feather.replace();
            showScreen('loginScreen');
        });
    </script>
</body>
</html>
